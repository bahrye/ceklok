<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ceklok Guru MTS TANUNTUNG</title>
  <style>
    :root {
      --primary: #0066cc;
      --secondary: #004b99;
      --accent: #f0f4f8;
      --disabled: #e0e0e0;
      --text: #333;
      --bg: #f4f7f6;
      --white: #fff;
      --danger: #e74c3c;
      --danger-hover: #c0392b;
      --grey-text: #555;
      --border-color: #ccc;
      --success: #28a745;
      --success-hover: #218838;
      --warning: #ffc107;
      --warning-hover: #e0a800;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center; /* Pastikan baris ini ada */
      min-height: 100vh;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background: var(--bg);
      color: var(--text);
      padding-bottom: 70px; /* Space for fixed footer */
      padding-top: 60px; /* Space for fixed profile menu */
    }
    #app {
      flex-grow: 1;
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      /* Tambahan untuk memaksa konten di dalamnya ke tengah */
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .login-active #app {
        display: flex; /* Tetap flex untuk centering loginContainer */
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: 20px; /* Padding untuk viewport kecil */
    }
    /* Penyesuaian untuk Body saat Login Aktif */
    body.login-active {
        padding-top: 0; /* Hapus padding atas dari menu profil */
        display: flex;
        flex-direction: column; 
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background-color: var(--bg); /* KEMBALIKAN KE WARNA BACKGROUND SEMULA */
    }
    /* Styling khusus untuk kontainer login */
    .login-form-wrapper { /* Target kelas baru dari login_form.html */
        background-color: var(--white);
        padding: 35px 40px; /* Padding lebih lapang */
        border-radius: 12px; /* Sudut lebih membulat */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); /* Bayangan lebih halus */
        width: 100%;
        max-width: 420px; /* Lebar maksimal form login */
        text-align: center; /* Pusatkan teks secara default di dalam wrapper */
        border-top: none; /* Hapus border-top dari .form-column jika tidak diinginkan */
    }

    .login-header {
        margin-bottom: 25px;
    }

    #loginLogo {
        display: block; /* Agar margin auto bekerja jika ada */
        margin-left: auto;
        margin-right: auto;
        max-width: 70px; 
        margin-bottom: 15px;
        /* Uncomment baris di bawah jika Anda punya logo dan ingin menampilkannya */
        /* display: block !important;  */
    }


    .login-form-wrapper h2 {
        font-size: 1.8em; /* Ukuran judul disesuaikan */
        font-weight: 600; /* Sedikit lebih tebal */
        color: var(--secondary);
        line-height: 1.3;
        margin-top: 0;
        margin-bottom: 0; /* Margin diatur oleh .login-header */
    }

    .login-form-wrapper .form-group {
        margin-bottom: 22px; /* Jarak antar grup form */
        text-align: left; /* Label dan input rata kiri */
    }

    .login-form-wrapper .form-group label {
        font-size: 0.88em; /* Label sedikit lebih kecil */
        font-weight: 500;
        color: var(--grey-text);
        margin-bottom: 8px;
    }

    .login-form-wrapper input[type="text"],
    .login-form-wrapper input[type="password"],
    .login-form-wrapper input[type="email"] {
        padding: 12px 15px;
        font-size: 1em;
        border-radius: 6px; /* Sudut input sedikit membulat */
        border: 1px solid #ddd; /* Border lebih halus */
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .login-form-wrapper input[type="text"]:focus,
    .login-form-wrapper input[type="password"]:focus,
    .login-form-wrapper input[type="email"]:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(0,102,204,.2);
    }

    .login-form-wrapper .password-wrapper {
        margin-bottom: 0; /* Hapus margin bawah dari wrapper password jika input di dalamnya sudah punya */
    }
    .login-form-wrapper .password-wrapper input[type="password"],
    .login-form-wrapper .password-wrapper input[type="text"] {
        margin-bottom: 0; /* Pastikan tidak ada margin ganda */
    }


    .login-form-wrapper #loginButton {
        width: 100%;
        padding: 12px 20px;
        font-size: 1.05em;
        font-weight: 500;
        letter-spacing: 0.5px;
        margin-top: 10px; /* Jarak dari form group terakhir */
        border-radius: 6px;
    }

    .login-links {
        margin-top: 25px; /* Jarak dari tombol login */
        font-size: 0.9em;
    }

    .login-form-wrapper #forgotPasswordLink {
        color: var(--primary);
        text-decoration: none;
    }
    .login-form-wrapper #forgotPasswordLink:hover {
        color: var(--secondary);
        text-decoration: underline;
    }

    /* Styling untuk form Lupa Password dan Reset OTP */
    #forgotPasswordContainer, #resetPasswordContainer {
        margin-top: 25px;
        border-top: 1px solid #eee;
        padding-top: 25px;
        text-align: left; /* Kembalikan ke rata kiri untuk konten di dalamnya */
    }

    #forgotPasswordContainer h3, #resetPasswordContainer h3 {
        text-align: center; /* Judul tetap di tengah */
        font-size: 1.4em;
        color: var(--secondary);
        margin-bottom: 15px;
    }
    #forgotPasswordContainer p, #resetPasswordContainer p {
        text-align: center; /* Paragraf instruksi di tengah */
        font-size: 0.9em;
        color: var(--grey-text);
        margin-bottom: 20px;
        line-height: 1.5;
    }

    /* Tombol sekunder seperti Batal */
    .btn-secondary-action {
        background-color: #6c757d !important; /* Warna abu-abu netral */
        color: white !important;
    }
    .btn-secondary-action:hover {
        background-color: #5a6268 !important;
    }

    .login-form-wrapper .error-message {
        padding: 10px 15px; /* Padding lebih baik untuk pesan error */
        margin-top: 0; /* Atur margin bawah saja jika perlu */
        margin-bottom: 18px;
        font-size: 0.88em;
        text-align: center; /* Error utama di tengah */
    }

    /* Penyesuaian untuk tampilan mobile jika perlu */
    @media (max-width: 480px) {
        .login-form-wrapper {
            padding: 25px 20px;
            margin: 15px; /* Tambahkan margin di viewport kecil */
            max-width: none; /* Biarkan mengambil lebar penuh dengan padding */
        }
        .login-form-wrapper h2 {
            font-size: 1.5em;
        }
    }
    .container {
        max-width:900px;
        margin:10px auto; 
        padding:15px; 
        box-sizing: border-box;
        background-color: var(--white);
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    h2 { text-align:center; color:var(--primary); margin-top:0; margin-bottom:20px; font-size:1.8em; }
    h3 { text-align:center; color:var(--secondary); margin-top:15px; margin-bottom:15px; font-size:1.4em;}

    label {
        font-weight:bold;
        display:block;
        margin-bottom: 5px;
        font-size: 0.95em;
        color: var(--grey-text);
    }
    select,input[type="text"], input[type="password"], input[type="date"], input[type="month"], input[type="email"], textarea {
      width:100%; padding:10px 12px; 
      border-radius:6px;
      border:1px solid var(--border-color); font-size:16px; box-sizing: border-box;
      transition: border-color .3s, box-shadow .3s;
      margin-bottom: 10px; 
    }
    select { height: 42px; }
    input[type="month"] { height: 42px; padding: 8px 12px; } 
    textarea { min-height: 80px; }

    select:focus, input[type="text"]:focus, input[type="password"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="email"]:focus, textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(0,102,204,.25);
        outline: none;
    }
    input[disabled], select[disabled], textarea[disabled] { background:var(--disabled); color:#777; cursor: not-allowed; }

    button {
      padding:10px 18px; font-size:15px; border:none; border-radius:6px;
      cursor:pointer; margin:5px; 
      transition:background .3s;
      color:var(--white); background:var(--primary); letter-spacing: 0.5px;
      font-weight: 500;
    }
    button:hover { background:var(--secondary); }
    button.btn-danger { background: var(--danger); }
    button.btn-danger:hover { background: var(--danger-hover); }
    button.btn-success { background: var(--success); }
    button.btn-success:hover { background: var(--success-hover); }
    button.btn-warning { background: var(--warning); color: var(--text); }
    button.btn-warning:hover { background: var(--warning-hover); color: var(--text); }
    button:disabled { background: var(--disabled); color: #888; cursor: not-allowed; }

    .btn-container { display:flex; justify-content:center; flex-wrap:wrap; margin-top: 20px; margin-bottom: 10px; }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    th, td { padding: 10px 12px; text-align: left; border: 1px solid #ddd; vertical-align: middle; }
    th { background:var(--primary); color:var(--white); font-weight: bold; text-transform: uppercase; font-size:0.85em; text-align: center;}
    td.actions-cell { text-align: center; white-space: nowrap; }
    td.actions-cell button { padding: 6px 10px; font-size: 0.9em; margin: 2px;}

    tr:nth-child(even) { background-color: var(--accent); }
    td input[type="text"].inline-input { width: 100%; box-sizing: border-box; margin: 0; padding: 8px 10px; line-height: 1.2; height: auto; vertical-align: middle; font-size:15px; text-align: center;}

    @media (max-width:700px) {
      table,thead,tbody,th,td,tr { display:block; }
      thead { display:none; }
      tr { margin-bottom:15px; background:var(--white); border:1px solid #ddd; border-radius:8px; padding:10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
      td { text-align:right; padding:10px; position:relative; border: none; border-bottom: 1px solid #eee;}
      td:last-child { border-bottom: none; }
      td::before { content:attr(data-label); font-weight:bold; display:inline-block; margin-right:10px; color:var(--primary); text-align:left; float:left;}
      td.actions-cell { text-align: right;}
      td.actions-cell button { display: inline-block; margin-left: 5px; }
      td input[type="text"].inline-input { text-align: right; }
      #hasilCeklokContainer .table-container table {
          display: table; width: 100%; margin-bottom: 0; background: transparent;
          border: none; border-radius: 0; padding: 0; box-shadow: none;
      }
      #hasilCeklokContainer .table-container thead { display: table-header-group !important; }
      #hasilCeklokContainer .table-container tbody { display: table-row-group; }
      #hasilCeklokContainer .table-container tr {
          display: table-row; margin-bottom: 0; background: var(--white);
          border: none; border-radius: 0; padding: 0; box-shadow: none;
      }
      #hasilCeklokContainer .table-container tr:nth-child(even) { background-color: var(--accent); }
      #hasilCeklokContainer .table-container tr:nth-child(odd) { background-color: var(--white); }
      #hasilCeklokContainer .table-container th,
      #hasilCeklokContainer .table-container td {
          display: table-cell; text-align: left; padding: 10px 12px;
          border: 1px solid #ddd; position: static; float: none;
      }
      #hasilCeklokContainer .table-container td::before { display: none !important; }
      #hasilCeklokContainer .table-container th {
          background: var(--primary); color: var(--white); font-weight: bold;
          text-transform: uppercase; font-size: 0.85em; text-align: center;
      }
      #ceklokInputContainer .table-container tr { border-left: 3px solid var(--primary); }
      #ceklokInputContainer .table-container td {
          display: flex; justify-content: space-between; align-items: center;
          text-align: left; padding: 10px 12px; border-bottom: 1px dotted #e0e0e0; position: static;
      }
      #ceklokInputContainer .table-container td:last-child { border-bottom: none; }
      #ceklokInputContainer .table-container td::before {
          float: none; flex-basis: 110px; flex-shrink: 0;
          font-weight: 500; color: var(--grey-text); margin-right: 8px;
      }
      #ceklokInputContainer .table-container td select.inline-select {
        flex-grow: 1; 
        width: auto; /* Atau bisa juga dipertimbangkan 100% jika flex-basis diatur lebih eksplisit */
        max-width: 120px; /* Menyamakan max-width dengan input jam (input.inline-input) */
        padding: 9px 10px; 
        font-size: 1em;
        box-sizing: border-box; /* Memastikan padding tidak menambah lebar total melebihi max-width */
        /* text-overflow: ellipsis; */ /* Opsional: jika teks di dalam select terlalu panjang, akan menampilkan "..." */
      }
      #ceklokInputContainer .table-container td[data-label="Hari"]::before,
      #ceklokInputContainer .table-container td[data-label="Tanggal"]::before { font-weight: bold; color: var(--primary); }
      #ceklokInputContainer .table-container td[data-label="Hari"],
      #ceklokInputContainer .table-container td[data-label="Tanggal"] {
          font-weight: bold; background-color: #f9f9f9; padding-top: 12px; padding-bottom: 12px;
      }
      #ceklokInputContainer .table-container td[data-label="Data Masuk"],
      #ceklokInputContainer .table-container td[data-label="Data Pulang"] { color: var(--secondary); font-weight: 500; }
      #ceklokInputContainer .table-container td input.inline-input {
          flex-grow: 1; width: auto; max-width: 120px; padding: 9px 10px; text-align: center;
          border: 1px solid var(--border-color); border-radius: 5px; font-size: 1em;
      }
      #ceklokInputContainer .table-container td input.inline-input:focus {
          border-color: var(--primary); box-shadow: 0 0 0 0.2rem rgba(0,102,204,.25);
      }
      #ceklokInputContainer .table-container tr.libur-row { background-color: #fff5f5 !important; border-left-color: var(--danger); }
      #ceklokInputContainer .table-container tr.libur-row td[data-label="Hari"],
      #ceklokInputContainer .table-container tr.libur-row td[data-label="Tanggal"],
      #ceklokInputContainer .table-container tr.libur-row td.libur-text {
          color: var(--danger); font-weight: bold; background-color: #fff5f5;
      }
      #ceklokInputContainer .table-container tr.libur-row td[data-label="Data Masuk"],
      #ceklokInputContainer .table-container tr.libur-row td[data-label="Data Pulang"] { color: var(--danger); }
      #ceklokInputContainer .table-container tr.libur-row td.libur-note {
          display: block; padding: 10px 12px; background-color: transparent;
      }
      #ceklokInputContainer .table-container tr.libur-row td.libur-note::before {
          display: block; flex-basis: auto; margin-bottom: 6px; font-weight: bold; color: var(--danger);
      }
      #ceklokInputContainer .table-container tr.libur-row td.libur-note span.holiday-description {
          display: block; font-style: italic; color: var(--danger); text-align: left; line-height: 1.4;
      }
    }

    #loading { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,.85); z-index:9999; display:none;
      align-items:center; justify-content:center; flex-direction:column;
    }
    .spinner { border:8px solid #f3f3f3; border-top:8px solid var(--primary); border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
    #loading p { margin-top:15px; font-size:16px; color:var(--primary); font-weight:500; }
    @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }

    .error-message {
      font-size:.9em; color:var(--danger); margin-top: 5px; margin-bottom: 10px; display:block; text-align:left;
      padding: 8px; background-color: #ffebee; border: 1px solid var(--danger); border-radius: 4px;
    }
    .error-message.inline-form-error { margin-bottom: 15px; }
    .input-error { border:1px solid var(--danger) !important; background:#fff0f0; }

    .libur-text { color:var(--danger); font-weight: bold; }
    .libur-note { text-align:left !important; color:var(--danger); font-style: italic; }

    .form-column {
      display: flex; flex-direction: column; gap: 15px;
      max-width: 500px;
      margin: 20px auto; padding: 25px;
      background-color: var(--white); border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-top: 5px solid var(--primary);
    }
    .form-column h2 { margin-bottom: 20px; font-size: 1.6em; }
    .form-column h3 { margin-bottom: 18px; font-size: 1.2em; color: var(--secondary); }
    .form-group { display: flex; flex-direction: column; }
    .form-group input, .form-group select, .form-group textarea { margin-bottom: 0; }
    .form-group small { font-size: 0.8em; color: var(--grey-text); margin-top: 3px; }

    .form-row {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
    }
    .form-row label {
        flex: 0 0 150px;
        margin-bottom: 0;
        text-align: right;
        padding-right: 5px;
    }
    .form-row .input-wrapper {
        flex-grow: 1;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .form-row .input-wrapper input[type="text"],
    .form-row .input-wrapper input[type="month"],
    .form-row .input-wrapper select {
        margin-bottom: 0;
    }
    .form-row-note {
        padding-left: 165px;
        font-size:0.85em;
        color:var(--grey-text);
        display:block;
        margin-top:-10px;
        margin-bottom: 10px;
    }

    .password-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
    }

    .password-wrapper input[type="password"],
    .password-wrapper input[type="text"] { /* Ini penting agar input bertipe teks (saat password terlihat) juga mendapat style yang sama */
        padding-right: 45px !important; /* !important mungkin diperlukan jika ada style lain yang menimpa */
        margin-bottom:0 !important; /* Jika input memiliki margin-bottom default */
        width: 100%; /* Pastikan input mengambil lebar penuh di dalam wrapper */
        box-sizing: border-box; /* Agar padding tidak menambah lebar total */
    }
    .toggle-password-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        user-select: none;
        color: var(--grey-text);
        transition: color 0.2s;
        display: inline-flex; /* Atau flex agar SVG terpusat jika perlu */
        align-items: center;
    }
    .toggle-password-icon:hover { color: var(--primary); }

    footer {
      background-color: var(--primary); color: var(--white);
      text-align: center; padding: 12px 20px; width: 100%;
      box-sizing: border-box; position: fixed; bottom: 0; left: 0; z-index: 1000;
    }
    footer p { margin: 0; font-size: 0.85em; }

    .kalender-form-container, .kalender-list-container {
      margin-top: 20px; padding: 20px; background-color: var(--white);
      border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .kalender-form-container h3, .kalender-list-container h3 {
        margin-top: 0; color: var(--primary);
        border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;
    }

    .custom-alert {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--primary);
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out, top 0.3s ease-in-out;
        font-size: 0.95em;
        text-align: center;
        min-width: 250px;
        max-width: 90%;
    }
    .custom-alert.show { opacity: 1; top: 60px; } /* Adjusted top to not overlap with profile menu */
    .custom-alert.error { background-color: var(--danger); }
    .custom-alert.success { background-color: var(--success); }

    @media (max-width: 600px) {
        .form-column { gap: 12px; padding: 20px; }
        .form-row {
            flex-direction: column;
            align-items: stretch;
            gap: 5px;
            margin-bottom: 12px;
        }
        .form-row label {
            flex-basis: auto;
            text-align: left;
            padding-right: 0;
            margin-bottom: 3px;
        }
        .form-row .input-wrapper { width: 100%; }
        .form-row .input-wrapper input[type="text"],
        .form-row .input-wrapper input[type="month"],
        .form-row .input-wrapper select { width: 100%; }
        .form-row .input-wrapper button {
            margin-left: 0 !important;
            margin-top: 8px !important;
            width: 100%;
        }
        .form-row-note { padding-left: 0; width: 100%; text-align: left; margin-top: 0;}
    }
    .table-container { overflow-x: auto; }

    #ceklokInputContainer .table-container th:nth-child(5),
    #ceklokInputContainer .table-container th:nth-child(6) { width: 18%; }
    #ceklokInputContainer .table-container th:nth-child(7) { width: 24%; }

    #ceklokInputContainer .table-container td .inline-input,
    #ceklokInputContainer .table-container td .inline-select {
      height: 40px;           /* Menyamakan tinggi */
      padding: 8px 10px;      /* Menyamakan padding */
      font-size: 15px;        /* Menyamakan ukuran font */
      width: 100%;            /* Memastikan lebar penuh di dalam sel */
      margin: 0;              /* Menghapus margin default */
      box-sizing: border-box; /* Memastikan kalkulasi tinggi konsisten */
      vertical-align: middle; /* KUNCI UTAMA: Menyamakan posisi vertikal */
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5); 
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20000; /* Make sure modals are above profile menu */
    }

    .modal-content {
      background-color: var(--white);
      padding: 25px 30px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 450px; 
      position: relative;
      text-align: left;
    }

    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--primary);
      text-align: center;
    }
    .modal-content p {
      margin-bottom: 20px;
      font-size: 0.9em;
      color: var(--grey-text);
      line-height: 1.5;
    }

    .modal-close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
      line-height: 1;
    }
    .modal-close-button:hover {
      color: #333;
    }

    .modal-content .form-group {
      margin-bottom: 20px;
    }
    .modal-content .form-group label {
      margin-bottom: 8px; 
    }
    .modal-content .form-group input[type="email"] {
      margin-bottom: 5px; 
    }

    /* CSS Baru untuk Profile Menu */
    #profileMenuContainer {
      position: fixed;
      top: 10px; 
      right: 15px; 
      z-index: 10001; 
      display: none; 
    }

    #profileIconTrigger { 
      cursor: pointer;
      padding: 8px; 
      background-color: var(--white); 
      border-radius: 50%; 
      display: flex;
      align-items: center;
      justify-content: center; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid var(--border-color);
      transition: background-color 0.2s;
      width: 40px; 
      height: 40px; 
    }

    #profileIconTrigger .profile-svg-icon {
      width: 24px; 
      height: 24px;
      fill: var(--primary); 
    }

    #profileIconTrigger:hover {
        background-color: var(--accent);
    }

    .profile-dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      top: calc(100% + 8px); 
      background-color: var(--white);
      min-width: 230px; 
      box-shadow: 0px 6px 12px rgba(0,0,0,0.15);
      z-index: 1; 
      border-radius: 6px;
      border: 1px solid #ddd;
      padding-top: 8px; 
      padding-bottom: 8px; 
    }

    #dropdownUsernameDisplay { /* Style untuk nama pengguna di dalam dropdown */
      padding: 10px 18px;
      font-weight: bold;
      color: var(--secondary);
      font-size: 1em;
      border-bottom: 1px solid #eee; 
      margin-bottom: 8px; 
      text-align: center;
    }

    .profile-dropdown-content a {
      color: var(--text);
      padding: 10px 18px; 
      text-decoration: none;
      display: block;
      font-size: 0.95em;
      transition: background-color 0.2s, color 0.2s;
    }

    .profile-dropdown-content a:hover {
      background-color: var(--primary);
      color: var(--white);
    }

    #profileMenuContainer.show-dropdown .profile-dropdown-content {
      display: block;
    }

    /* Di dalam <style> di index.html */
    button.btn-info { background-color: #17a2b8; } /* Contoh warna biru info */
    button.btn-info:hover { background-color: #138496; }

    /* Tambahkan ini di dalam tag <style> di index.html */

    /* Styling untuk Dasbor Ringkasan Guru */
    .dashboard-summary-section {
      margin-bottom: 25px;
      padding: 20px; /* Padding lebih lapang */
      background-color: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08); /* Bayangan lebih halus */
      border: 1px solid #e0e0e0;
    }

    .summary-title {
      text-align: center;
      color: var(--primary); /* Menggunakan variabel warna primer Anda */
      margin-top: 0;
      margin-bottom: 18px;
      font-size: 1.5em; /* Ukuran font judul */
    }

    .summary-loading,
    .summary-error {
      text-align: center;
      padding: 15px;
      font-style: italic;
      color: var(--grey-text); /* Menggunakan variabel warna abu-abu Anda */
    }
    .summary-error {
        color: var(--danger); /* Menggunakan variabel warna bahaya Anda */
        font-style: normal;
        font-weight: bold;
    }


    .summary-period {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.1em;
      color: var(--secondary); /* Menggunakan variabel warna sekunder Anda */
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Kolom otomatis responsif */
      gap: 15px; /* Jarak antar item */
    }

    .summary-item {
      background-color: var(--white);
      padding: 12px 15px;
      border-radius: 6px;
      border: 1px solid #ddd;
      display: grid; /* Ubah menjadi grid */
      grid-template-columns: auto 1fr; /* Kolom pertama (label) auto, kolom kedua (value) mengisi sisa */
      align-items: center;
      gap: 10px; /* Jarak antara label dan value jika diperlukan */
      font-size: 0.95em;
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .summary-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 6px rgba(0,0,0,0.07);
    }

    .summary-label {
      color: var(--text);
      /* Tidak perlu margin-right karena gap di grid container */
      /* text-align: left; /* Default, bisa dihapus */
    }

    .summary-value {
      font-weight: bold;
      color: var(--primary);
      text-align: right; /* Penting untuk meratakan angka ke kanan */
      white-space: nowrap; /* Jaga angka dan unit tetap sebaris */
    }

    .summary-item.summary-highlight {
      background-color: var(--accent); /* Warna aksen untuk item yang penting */
      border-left: 4px solid var(--primary); /* Tambahkan aksen di kiri */
    }

    .summary-item.summary-highlight .summary-label,
    .summary-item.summary-highlight .summary-value {
      font-size: 1.05em; /* Sedikit lebih besar untuk item highlight */
      color: var(--secondary);
    }

    /* Penyesuaian untuk layar yang lebih kecil (Mobile) */
    @media (max-width: 600px) {
      .dashboard-summary-section {
        padding: 15px;
      }
      .summary-title {
        font-size: 1.3em;
      }
      .summary-grid {
        grid-template-columns: 1fr; /* Satu kolom penuh di mobile */
        gap: 10px;
      }
      .summary-item {
        padding: 10px 12px;
        font-size: 0.9em;
      }
      .summary-item.summary-highlight .summary-label,
      .summary-item.summary-highlight .summary-value {
        font-size: 1em;
      }
    }

    /* Tambahkan ini di dalam tag <style> di index.html */

    /* Custom Summary Item Colors */
    .summary-item.color-green {
      background-color: #e6ffed; /* Light green */
      border-left: 4px solid #28a745; /* Green (menggunakan var(--success) jika ada) */
    }
    .summary-item.color-green .summary-value {
      color: #155724; /* Darker green text for value */
    }
    .summary-item.color-green .summary-label { /* Opsional: jika ingin label juga berwarna */
      color: #155724;
    }

    .summary-item.color-orange {
      background-color: #fff8e1; /* Light orange */
      border-left: 4px solid #ffc107; /* Orange (menggunakan var(--warning) jika ada) */
    }
    .summary-item.color-orange .summary-value {
      color: #856404; /* Darker orange text for value */
    }
    .summary-item.color-orange .summary-label { /* Opsional */
      color: #856404;
    }

    .summary-item.color-yellow {
      background-color: #fffde7; /* Light yellow */
      border-left: 4px solid #fdd835; /* Yellow */
    }
    .summary-item.color-yellow .summary-value {
      color: #827717; /* Darker yellow text for value */
    }
    .summary-item.color-yellow .summary-label { /* Opsional */
      color: #827717;
    }

    .summary-item.color-red {
      background-color: #ffebee; /* Light red */
      border-left: 4px solid #e74c3c; /* Red (menggunakan var(--danger) jika ada) */
    }
    .summary-item.color-red .summary-value {
      color: #721c24; /* Darker red text for value */
    }
    .summary-item.color-red .summary-label { /* Opsional */
      color: #721c24;
    }

    .summary-item.color-gray {
      background-color: #f5f5f5; /* Light gray */
      border-left: 4px solid #757575; /* Darker gray */
    }
    .summary-item.color-gray .summary-value {
      color: #424242; /* Darker gray text for value */
    }
    .summary-item.color-gray .summary-label { /* Opsional */
      color: #424242;
    }

    button.btn-disabled { /* Atau bisa juga button:disabled jika ingin lebih general */
      background-color: #ccc !important;
      color: #666 !important;
      cursor: not-allowed !important;
      border: 1px solid #bbb !important;
    }
    button.btn-disabled:hover {
      background-color: #ccc !important;
      color: #666 !important;
    }

    /* CSS untuk Export Excel Collapsible */
    .collapsible-excel-export {
      margin-top: 30px;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      background-color: #f9f9f9;
    }

    .collapsible-trigger {
      background-color: var(--secondary);
      color: var(--white);
      padding: 12px 20px;
      width: 100%;
      text-align: left;
      border: none;
      outline: none;
      font-size: 1.1em;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }

    .collapsible-trigger:hover {
      background-color: var(--primary);
    }

    .arrow-icon {
      transition: transform 0.3s ease;
      font-size: 1em;
      margin-left: 10px;
    }

    .arrow-icon.down::before {
      content: "\25BC"; /* Panah ke bawah */
      display: inline-block;
    }

    .arrow-icon.up::before {
      content: "\25B2"; /* Panah ke atas */
      display: inline-block;
    }

    .collapsible-content {
      padding: 20px;
      border-top: 1px solid #ddd;
      /* display: none; /* Konten disembunyikan via JS awalnya */
    }

    .collapsible-content .form-group {
        margin-bottom: 15px;
    }
    .collapsible-content .form-group label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
    }
    .collapsible-content .form-group input[type="text"] {
        width: auto;
        max-width: 250px;
        display: inline-block;
        margin-right: 10px;
        vertical-align: middle;
    }
    .collapsible-content .form-group button {
        vertical-align: middle;
    }
    .collapsible-content .form-group small {
        display: block;
        margin-top: 8px;
        font-style: italic;
        color: var(--grey-text);
    }

    /* CSS untuk memastikan modal terlihat */
    .reminder-modal-overlay {
      position: fixed; /* Tetap di layar bahkan saat di-scroll */
      inset: 0;
      background-color: rgba(0, 0, 0, 0.6); /* Latar belakang semi-transparan */
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000; /* Pastikan berada di atas elemen lain */
      padding: 1rem;
    }
    .reminder-modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-width: 450px; /* Lebar maksimum modal */
      text-align: center;
    }
    .reminder-modal-icon {
      width: 4rem; /* 64px */
      height: 4rem; /* 64px */
      margin-left: auto;
      margin-right: auto;
      color: #FBBF24; /* Warna kuning (amber-400) */
    }
    .reminder-modal-title {
      font-size: 1.5rem; /* 24px */
      font-weight: bold;
      margin-top: 0.5rem;
      color: #1F2937; /* Warna abu-abu gelap (gray-800) */
    }
    .reminder-modal-text {
      margin-top: 1rem;
      font-size: 1.125rem; /* 18px */
      color: #4B5563; /* Warna abu-abu sedang (gray-600) */
    }
    .reminder-modal-button {
      margin-top: 1.5rem;
      padding: 0.75rem 1.5rem;
      background-color: #3B82F6; /* Warna biru (blue-500) */
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .reminder-modal-button:hover {
      background-color: #2563EB; /* Warna biru lebih gelap (blue-600) */
    }
  </style>
</head>
<body>

  <div id="profileMenuContainer">
    <div id="profileIconTrigger" tabindex="0"> 
      <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" class="profile-svg-icon">
        <path d="M0 0h24v24H0V0z" fill="none"/>
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
      </svg>
    </div>
    <div id="profileDropdown" class="profile-dropdown-content">
      <div id="dropdownUsernameDisplay">Username</div> 
      <a href="#" id="menuRequestUsernameChange">Ajukan Perubahan Username</a>
      <a href="#" id="menuChangePrimaryEmail">Ganti Email Utama</a>
      <a href="#" id="menuChangePassword">Ubah Password</a>
      <a href="#" id="menuTutorial">Petunjuk Penggunaan</a>
      <a href="#" id="menuLogoutProfile">Logout</a>
    </div>
  </div>

  <div id="requestUsernameChangeModal" class="modal-overlay" style="display:none; z-index: 20001;">
    <div class="modal-content" style="max-width: 480px;">
      <span class="modal-close-button" onclick="closeRequestUsernameChangeModal()">&times;</span>
      <h3>Ajukan Perubahan Username</h3>
      <p>Username Anda saat ini: <strong id="currentUsernameForChangeRequest"></strong></p>
      <div class="form-group">
        <label for="requestedNewUsernameInput">Username Baru yang Diinginkan:</label>
        <input type="text" id="requestedNewUsernameInput" placeholder="Minimal 4 karakter">
      </div>
      <small>Perubahan username akan membuat Anda perlu login ulang jika disetujui.</small>
      <div id="requestUsernameChangeError" class="error-message" style="display:none; margin-top:10px;"></div>
      <div class="btn-container" style="margin-top:20px;">
        <button id="btnSubmitUsernameChangeRequest" onclick="handleSubmitUsernameChangeRequest()">Kirim Pengajuan</button>
        <button type="button" onclick="closeRequestUsernameChangeModal()" style="background-color: #777;">Batal</button>
      </div>
    </div>
  </div>

  <div id="app">
    </div>

  <div id="loading">
    <div class="spinner"></div>
    <p id="loadingMessage">Memproses...</p>
  </div>

  <div id="customAlert" class="custom-alert">Pesan Alert</div>

  <div id="changePasswordModal" style="display:none; position:fixed; z-index:20001; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4);">
    <div style="background-color:#fefefe; margin:10% auto; padding:20px; border:1px solid #888; width:80%; max-width:400px; border-radius:8px; position:relative;">
      <span onclick="closeChangePasswordModal()" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;" title="Tutup">&times;</span>
      <h3>Ubah Password</h3>
      <div class="form-group">
        <label for="currentPassword">Password Lama:</label>
        <div class="password-wrapper">
          <input type="password" id="currentPassword">
          <span id="toggleCurrentPassword" class="toggle-password-icon" title="Lihat password">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </span>
        </div>
      </div>
      <div class="form-group">
        <label for="newPassword">Password Baru:</label>
        <div class="password-wrapper">
          <input type="password" id="newPassword">
          <span id="toggleNewPasswordModal" class="toggle-password-icon" title="Lihat password">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </span>
        </div>
      </div>
      <div class="form-group">
        <label for="confirmNewPassword">Konfirmasi Password Baru:</label>
        <div class="password-wrapper">
          <input type="password" id="confirmNewPassword">
          <span id="toggleConfirmNewPasswordModal" class="toggle-password-icon" title="Lihat password">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </span>
        </div>
      </div>
      <div id="changePasswordError" class="error-message" style="display:none; margin-bottom:15px;"></div>
      <div class="btn-container">
        <button onclick="submitChangePassword()">Simpan Perubahan</button>
        <button onclick="closeChangePasswordModal()" style="background-color:#ccc; color:#333;">Batal</button>
      </div>
    </div>
  </div>

  <div id="primaryEmailModal" class="modal-overlay" style="display:none; z-index: 20001;">
    <div class="modal-content">
      <span class="modal-close-button" onclick="closePrimaryEmailModal()">&times;</span>
      
      <div id="primaryEmailStep1">
        <h3>Masukkan Email Utama Anda</h3>
        <p>Email ini akan digunakan jika Anda lupa password dan dapat juga digunakan sebagai username untuk login di masa mendatang. Kode verifikasi akan dikirim ke email ini.</p>
        <div class="form-group">
          <label for="primaryEmailInput">Email:</label>
          <input type="email" id="primaryEmailInput" placeholder="contoh@email.com">
        </div>
        <div id="primaryEmailStep1Error" class="error-message" style="display:none; margin-bottom: 15px;"></div>
        <div class="btn-container">
          <button id="btnRequestPrimaryEmailOTP" onclick="handleRequestPrimaryEmailOTP()">Kirim Kode Verifikasi</button>
          <button id="btnSkipPrimaryEmail" onclick="closePrimaryEmailModal()" style="background-color: #777;">Nanti Saja</button>
        </div>
      </div>

      <div id="primaryEmailStep2" style="display:none;">
        <h3>Verifikasi Email Anda</h3>
        <p>Kode OTP telah dikirim ke <strong id="otpSentToPrimaryEmailDisplay">emailanda@contoh.com</strong>. Silakan periksa folder inbox atau spam.</p>
        <p style="font-size:0.9em; color:var(--grey-text);">OTP akan kedaluwarsa dalam <span id="primaryEmailOtpTimer">10:00</span> menit.</p>
        <div class="form-group">
          <label for="primaryEmailOtpInput">Kode OTP (6 digit):</label>
          <input type="text" id="primaryEmailOtpInput" maxlength="6" pattern="\d{6}" inputmode="numeric">
        </div>
        <div id="primaryEmailStep2Error" class="error-message" style="display:none; margin-bottom: 15px;"></div>
        <div class="btn-container">
          <button id="btnVerifyAndSavePrimaryEmail" onclick="handleVerifyAndSavePrimaryEmail()">Verifikasi & Simpan Email</button>
          <button type="button" onclick="showPrimaryEmailStep1()" style="background-color: #aaa; font-size:0.9em;">Kembali / Kirim Ulang OTP</button>
        </div>
      </div>
    </div>
  </div>

  <div id="changePrimaryEmailModal" class="modal-overlay" style="display:none; z-index: 20001;">
    <div class="modal-content">
      <span class="modal-close-button" onclick="closeChangePrimaryEmailModal()">&times;</span>
      <h3 id="changeEmailModalTitle">Ubah Email Utama Anda</h3>

      <div id="changeEmailStep1">
        <p>Email utama Anda saat ini: <strong id="currentPrimaryEmailDisplay">memuat...</strong></p>
        <p>Masukkan alamat email baru yang ingin Anda gunakan. Kode verifikasi akan dikirim ke alamat email Anda yang LAMA (<span id="currentPrimaryEmailForOtp" style="font-weight:bold;"></span>) untuk mengonfirmasi perubahan ini.</p>
        <div class="form-group">
          <label for="newPrimaryEmailInput">Email Baru:</label>
          <input type="email" id="newPrimaryEmailInput" placeholder="emailbaru@contoh.com">
        </div>
        <div id="changeEmailStep1Error" class="error-message" style="display:none; margin-bottom: 15px;"></div>
        <div class="btn-container">
          <button id="btnSendChangeEmailOTP" onclick="handleSendChangeEmailOTP()">Kirim Kode Verifikasi</button>
          <button type="button" onclick="closeChangePrimaryEmailModal()" style="background-color: #777;">Batal</button>
        </div>
      </div>

      <div id="changeEmailStep2" style="display:none;">
        <p>Sebuah kode OTP telah dikirim ke email lama Anda (<strong id="otpSentToEmailDisplay"></strong>). Masukkan kode tersebut di bawah ini untuk memverifikasi dan mengganti email Anda menjadi <strong id="newProposedEmailDisplay"></strong>.</p>
        <p style="font-size:0.9em; color:var(--grey-text);">OTP akan kedaluwarsa dalam <span id="changeEmailOtpTimer">10:00</span> menit.</p>
        <div class="form-group">
          <label for="changeEmailOtpInput">Kode OTP (6 digit):</label>
          <input type="text" id="changeEmailOtpInput" maxlength="6" pattern="\d{6}" inputmode="numeric">
        </div>
        <div id="changeEmailStep2Error" class="error-message" style="display:none; margin-bottom: 15px;"></div>
        <div class="btn-container">
          <button id="btnVerifyAndSaveNewEmail" onclick="handleVerifyAndSaveNewEmail()">Verifikasi & Ganti Email</button>
          <button type="button" onclick="openChangePrimaryEmailModal(true)" style="background-color: #aaa; font-size:0.9em;">Kembali / Kirim Ulang OTP</button> 
          </div>
      </div>
    </div>
  </div>

  <div id="overallSummaryDetailModal" class="modal-overlay" style="display:none; z-index: 20002;">
    <div class="modal-content" style="max-width: 550px;">
      <span class="modal-close-button" onclick="closeOverallSummaryDetailModal()">&times;</span>
      <h3 id="overallSummaryDetailTitle">Detail Kehadiran</h3>
      <div id="overallSummaryDetailContent" style="max-height: 400px; overflow-y: auto; padding: 10px; background-color: #f9f9f9; border-radius: 4px; border: 1px solid #eee;">
        </div>
      <div class="btn-container" style="margin-top: 20px;">
        <button onclick="closeOverallSummaryDetailModal()" style="background-color: #777;">Tutup</button>
      </div>
    </div>
  </div>

  <div id="reminderModal" class="reminder-modal-overlay" style="display: none;">
    <div class="reminder-modal-content">
      <svg xmlns="http://www.w3.org/2000/svg" class="reminder-modal-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h3 class="reminder-modal-title">Pengingat Pengisian Ceklok</h3>
      <p id="reminderText" class="reminder-modal-text"></p>
      <button id="closeReminderModal" class="reminder-modal-button">
        Saya Mengerti
      </button>
    </div>
  </div>

  <footer>
    <p>&copy; <span id="currentYear">2024</span> Created by Syamsul Bahri || v2.5</p>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // Variabel global
    let loggedInUser = null;
    let namaGuru = ''; 
    let dataTanggal = []; 
    let allTeachersList = [];
    let currentView = '';
    let currentLockIdValue = null;
    let currentBackupSheetName = null;

    let idleTimer = null;
    const IDLE_TIMEOUT_MS = 5 * 60 * 1000; 

    let globalServerCurrentMonthYear = null; 
    let globalAdminMinMonthYear = null;     
    let activeCeklokMonthYear = null;       
    let activeRekapMonthYear = null; 

    let currentLogSortColumn = 'timestamp_internal_sort'; // Default sort column (harus cocok dengan key di backend)
    let currentLogSortDirection = 'desc';   // Default direction (newest first)

    let usernameForReset = null;
    let otpTimerInterval = null; 

    let currentTeacherSummaryDetails = { // BARU: Untuk menyimpan detail dari ringkasan
        absentDates: [],
        incompleteEntries: []
    };

    let proposedNewPrimaryEmail = null;
    let changeEmailOtpTimerInterval = null; 
    const CHANGE_EMAIL_OTP_EXPIRY_MINUTES = 10;

    // Tambahkan bersama variabel global lainnya
    let primaryEmailOtpTimerInterval = null;
    let emailForPrimaryVerification = null; // Untuk menyimpan email yang sedang diverifikasi
    const PRIMARY_EMAIL_OTP_EXPIRY_MINUTES = 10;

    const ROLE_SUPERADMIN = "superadmin";
    const ROLE_ADMIN = "admin";
    const ROLE_USER = "user";

    // Tambahkan fungsi helper ini di dalam blok <script> di index.html
    function populateRoleDropdown(selectElementId, forEditingRole) {
        const roleSelect = document.getElementById(selectElementId);
        if (!roleSelect) return;

        roleSelect.innerHTML = ''; // Kosongkan opsi yang ada

        const optionUser = document.createElement('option');
        optionUser.value = ROLE_USER;
        optionUser.textContent = 'User';
        roleSelect.appendChild(optionUser);

        const optionAdmin = document.createElement('option');
        optionAdmin.value = ROLE_ADMIN;
        optionAdmin.textContent = 'Admin';
        roleSelect.appendChild(optionAdmin);

        if (loggedInUser && loggedInUser.role === ROLE_SUPERADMIN) {
            const optionSuperAdmin = document.createElement('option');
            optionSuperAdmin.value = ROLE_SUPERADMIN;
            optionSuperAdmin.textContent = 'Superadmin';
            roleSelect.appendChild(optionSuperAdmin);
        }

        if (forEditingRole) {
            // Jika sedang mengedit, set nilai dropdown ke peran pengguna yang diedit
            // Pastikan peran tersebut valid untuk ditampilkan berdasarkan pengguna yang login
            if (roleSelect.querySelector(`option[value="${forEditingRole}"]`)) {
                roleSelect.value = forEditingRole;
            } else if (forEditingRole === ROLE_SUPERADMIN && loggedInUser.role !== ROLE_SUPERADMIN) {
                // Jika admin mencoba mengedit user yang (seharusnya tidak mungkin) adalah superadmin
                // atau jika ada data tidak konsisten. Default ke user.
                roleSelect.value = ROLE_USER;
                showAlert("Peran pengguna yang diedit tidak dapat ditampilkan/diubah oleh level akses Anda.", "warning");
            } else {
                // Fallback jika peran yang diedit tidak ada di opsi (misal, peran lama dihapus)
                roleSelect.value = ROLE_USER;
            }
        } else {
            // Untuk pengguna baru, default ke 'user'
            roleSelect.value = ROLE_USER;
        }
        // Pastikan toggle nama guru dipanggil setelah nilai dropdown diatur
        if (typeof toggleManageTeacherNameInput === "function") {
            toggleManageTeacherNameInput(roleSelect.value);
        }
    }

    function showAlert(message, type = 'info', duration = 3500) {
        const alertBox = document.getElementById('customAlert');
        if (!alertBox) return;
        alertBox.textContent = message;
        alertBox.className = 'custom-alert';
        if (type === 'error') alertBox.classList.add('error');
        else if (type === 'success') alertBox.classList.add('success');
        alertBox.classList.add('show');
        setTimeout(() => { alertBox.classList.remove('show'); }, duration);
    }
    function showLoading(message = "Memproses...") {
        const loadingEl = document.getElementById("loading");
        const loadingMsgEl = document.getElementById("loadingMessage");
        if (loadingMsgEl) loadingMsgEl.textContent = message;
        if (loadingEl) loadingEl.style.display = "flex";
    }
    function hideLoading() { 
        const loadingEl = document.getElementById("loading");
        if (loadingEl) loadingEl.style.display = "none"; 
    }
    function isValidJamFormat(j_input) {
        if (!j_input) return true;
        const m = j_input.match(/^(\d{1,2})[:.](\d{1,2})$/);
        if (!m) return false;
        const h = parseInt(m[1], 10); const mn = parseInt(m[2], 10);
        return h >= 0 && h < 24 && mn >= 0 && mn < 60;
    }
    function normalizeJamFormat(j_input) {
        if (!j_input) return '';
        const m = j_input.match(/^(\d{1,2})[:.](\d{1,2})$/);
        if (!m) return j_input;
        const h = String(m[1]).padStart(2, '0'); const mn = String(m[2]).padStart(2, '0');
        return `${h}.${mn}`;
    }
    function showInlineError(containerId, message) {
        const el = document.getElementById(containerId);
        if (el) { el.textContent = message; el.style.display = 'block'; }
    }
    function clearInlineError(containerId) {
        const el = document.getElementById(containerId);
        if (el) { el.textContent = ''; el.style.display = 'none'; }
    }
    function clearInputError(...inputElements) {
        inputElements.forEach(inputElement => {
            if(inputElement) inputElement.classList.remove('input-error');
        });
    }
    function showInputError(inputElement) {
        if(inputElement) inputElement.classList.add('input-error');
    }

    function convertMMYYYYtoYYYYMM(mm_yyyy) { 
        if (!mm_yyyy || !mm_yyyy.includes('/')) return "";
        const parts = mm_yyyy.split('/');
        if (parts.length !== 2) return "";
        return `${parts[1]}-${parts[0]}`;
    }

    function convertYYYYMMtoMMYYYY(yyyy_mm) { 
        if (!yyyy_mm || !yyyy_mm.includes('-')) return "";
        const parts = yyyy_mm.split('-');
        if (parts.length !== 2) return "";
        return `${parts[1]}/${parts[0]}`;
    }
    
    function loadHtmlContent(filename, targetElementId, callback, dataForRender) {
        showLoading("Memuat tampilan...");
        google.script.run
            .withSuccessHandler(html => {
                const target = document.getElementById(targetElementId);
                if (target) {
                    target.innerHTML = html;
                    if (callback) callback(dataForRender);
                } else {
                    showAlert(`Error: Target elemen '${targetElementId}' tidak ditemukan.`, 'error');
                }
                hideLoading();
            })
            .withFailureHandler(err => {
                hideLoading();
                showAlert(`Gagal memuat ${filename}: ${err.message}`, 'error');
                const target = document.getElementById(targetElementId);
                if (target) target.innerHTML = `<div class="container"><p style="color:red;">Gagal memuat tampilan. Silakan coba lagi.</p><button onclick="renderView('login')">Kembali ke Login</button></div>`;
            })
            .getHtmlContent(filename);
    }

    // index.html di dalam tag <script>

    // GANTI fungsi renderView LAMA Anda dengan yang BARU ini
    function renderView(viewName, data, postRenderCallback) {
        console.log("Merender tampilan:", viewName, "dengan data:", data);
        currentView = viewName;
        document.body.classList.remove('login-active');

        let targetElementId = 'app';
        let htmlFile = '';
        let setupFunction = null;

        if (viewName === 'login') {
            document.body.classList.add('login-active');
        }

        switch(viewName) {
            case 'login':
                htmlFile = 'login_form.html';
                setupFunction = setupLoginFormEventListeners;
                break;
            case 'admin_dashboard':
                htmlFile = 'admin_dashboard_content.html';
                setupFunction = setupAdminDashboardView;
                break;
            case 'user_dashboard': // <-- TAMBAHKAN CASE BARU INI
                htmlFile = 'user_dashboard_content.html';
                setupFunction = setupUserDashboardView;
                break;
            case 'ceklok_table':
                htmlFile = 'ceklok_table_content.html';
                setupFunction = setupCeklokTableView;
                break;
            case 'user_management':
                htmlFile = 'user_management_content.html';
                setupFunction = setupUserManagementView;
                break;
            case 'teacher_management':
                htmlFile = 'teacher_management_content.html';
                setupFunction = setupTeacherManagementView;
                break;
            case 'kalender_pendidikan':
                htmlFile = 'kalender_pendidikan_content.html';
                setupFunction = setupKalenderPendidikanView;
                break;
            case 'hasil_ceklok':
                htmlFile = 'hasil_ceklok_content.html';
                setupFunction = setupHasilCeklokView;
                break;
            case 'tutorial':
                htmlFile = 'tutorial_content.html';
                setupFunction = setupTutorialView;
                break;
            case 'activity_log':
                htmlFile = 'activity_log_content.html';
                setupFunction = setupActivityLogView;
                break;
            case 'overall_teacher_summary':
                htmlFile = 'overall_summary_content.html';
                setupFunction = setupOverallSummaryView;
                break;
            case 'username_requests_view':
                htmlFile = 'username_requests_content.html';
                setupFunction = setupUsernameRequestsView;
                break;
            case 'cek_data_kehadiran':
                htmlFile = 'cek_data_kehadiran_content.html';
                setupFunction = setupCekDataKehadiranView;
                break;
            default:
                console.error("Tampilan tidak dikenal:", viewName);
                const appEl = document.getElementById('app');
                if (appEl) appEl.innerHTML = '<p>Tampilan tidak ditemukan: ' + viewName + '</p>';
                hideLoading();
                return;
        }

        if (viewName !== 'tutorial' && viewName !== 'login') {
            previousViewBeforeTutorial = currentView;
        }

        if (htmlFile) {
            loadHtmlContent(htmlFile, targetElementId, (dataForSetupFunction) => {
                if (setupFunction) {
                    console.log("Menjalankan setupFunction untuk", viewName);
                    setupFunction(dataForSetupFunction);
                }
                initializeAllPasswordToggles();
                
                // ===== PENAMBAHAN LOGIKA POP-UP DI SINI =====
                // Setelah view utama (dashboard admin atau tabel ceklok guru) selesai dirender,
                // jalankan pengecekan untuk menampilkan pop-up pengingat.
                if (viewName === 'admin_dashboard' || viewName === 'ceklok_table') {
                    if (typeof showEndOfMonthReminder === 'function') {
                        setTimeout(showEndOfMonthReminder, 100); 
                    }
                }
                // ===========================================

                if (postRenderCallback) {
                    postRenderCallback();
                }
            }, data);
        }
    }

    function toggleProfileDropdown() {
      const profileMenuContainer = document.getElementById('profileMenuContainer');
      if (profileMenuContainer) {
        profileMenuContainer.classList.toggle('show-dropdown');
      }
    }

    function setupProfileMenuEventListeners() {
      const profileIconTrigger = document.getElementById('profileIconTrigger');
      if (profileIconTrigger) {
        profileIconTrigger.onclick = function(event) {
          event.stopPropagation(); 
          toggleProfileDropdown();
        };
        profileIconTrigger.onkeydown = function(event) {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            event.stopPropagation();
            toggleProfileDropdown();
          }
        };
      }

      const menuRequestUsernameChange = document.getElementById('menuRequestUsernameChange');
      if (menuRequestUsernameChange) {
          menuRequestUsernameChange.onclick = function(e) {
              e.preventDefault();
              openRequestUsernameChangeModal();
              const profileMenuContainer = document.getElementById('profileMenuContainer');
              if (profileMenuContainer) profileMenuContainer.classList.remove('show-dropdown');
          };
      }

      const menuChangePrimaryEmail = document.getElementById('menuChangePrimaryEmail');
      if (menuChangePrimaryEmail) {
        menuChangePrimaryEmail.onclick = function(e) {
          e.preventDefault();
          const profileMenuContainer = document.getElementById('profileMenuContainer');
          if (loggedInUser && loggedInUser.primaryEmail) {
            openChangePrimaryEmailModal(); 
          } else {
            showAlert("Anda belum memiliki Email Utama. Silakan atur terlebih dahulu.", "warning");
            openPrimaryEmailModal(); 
          }
          if (profileMenuContainer) profileMenuContainer.classList.remove('show-dropdown');
        };
      }

      const menuChangePassword = document.getElementById('menuChangePassword');
      if (menuChangePassword) {
        menuChangePassword.onclick = function(e) {
          e.preventDefault();
          openChangePasswordModal(); 
          const profileMenuContainer = document.getElementById('profileMenuContainer');
          if (profileMenuContainer) profileMenuContainer.classList.remove('show-dropdown');
        };
      }

      const menuLogoutProfile = document.getElementById('menuLogoutProfile');
      if (menuLogoutProfile) {
          menuLogoutProfile.onclick = function(e) {
              e.preventDefault();
              const profileMenuContainer = document.getElementById('profileMenuContainer');
              if (profileMenuContainer) profileMenuContainer.classList.remove('show-dropdown');
              logout(); 
          };
      }

      const menuTutorial = document.getElementById('menuTutorial');
      if (menuTutorial) {
          menuTutorial.onclick = function(e) {
              e.preventDefault();
              navigateToTutorial();
          };
      }

      if (loggedInUser && loggedInUser.role === ROLE_USER) {
          const profileDropdownContent = document.getElementById('profileDropdown');
          const existingCekDataLink = document.getElementById('menuCekDataKehadiran'); // Cek apakah sudah ada

          if (profileDropdownContent && !existingCekDataLink) {
              const cekDataLink = document.createElement('a');
              cekDataLink.href = "#";
              cekDataLink.id = "menuCekDataKehadiran"; // ID untuk referensi
              cekDataLink.textContent = "Cek Data Kehadiran Tahunan";
              cekDataLink.onclick = function(e) {
                  e.preventDefault();
                  navigateToCekDataKehadiran();
                  toggleProfileDropdown(); // Tutup dropdown
              };
              // Sisipkan sebelum link Tutorial atau Logout
              const referenceNode = menuTutorial || document.getElementById('menuLogoutProfile');
              if (referenceNode) {
                  profileDropdownContent.insertBefore(cekDataLink, referenceNode);
              } else {
                  profileDropdownContent.appendChild(cekDataLink);
              }
          }
      }
    }

    function closeProfileDropdownOnClickOutside() {
        window.addEventListener('click', function(event) {
            const profileMenuContainer = document.getElementById('profileMenuContainer');
            const profileIconTrigger = document.getElementById('profileIconTrigger');
            // Pastikan elemen ada sebelum mengakses contains
            if (profileMenuContainer && profileIconTrigger && document.getElementById('profileDropdown') && profileMenuContainer.classList.contains('show-dropdown')) {
              if (!profileIconTrigger.contains(event.target) && !document.getElementById('profileDropdown').contains(event.target)) {
                profileMenuContainer.classList.remove('show-dropdown');
              }
            }
        });
    }

    function closeProfileDropdownOnEscape() {
        document.addEventListener('keydown', function(event) {
            const profileMenuContainer = document.getElementById('profileMenuContainer');
            if (event.key === "Escape" || event.key === "Esc") {
              if (profileMenuContainer && profileMenuContainer.classList.contains('show-dropdown')) {
                profileMenuContainer.classList.remove('show-dropdown');
              }
            }
        });
    }


    function setupLoginFormEventListeners() {
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const togglePasswordButton = document.getElementById('togglePassword');
        const loginButton = document.getElementById('loginButton');

        if (loginButton) {
            loginButton.onclick = handleLogin;
        }

        if (usernameInput) {
            usernameInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    const forgotPasswordContainer = document.getElementById('forgotPasswordContainer');
                    const resetPasswordContainer = document.getElementById('resetPasswordContainer');
                    if (
                        (!forgotPasswordContainer || forgotPasswordContainer.style.display === 'none') &&
                        (!resetPasswordContainer || resetPasswordContainer.style.display === 'none')
                    ) {
                        handleLogin();
                    }
                }
            };
        }
        if (passwordInput) {
            passwordInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    const mainLoginFields = document.getElementById('mainLoginFields');
                    if (mainLoginFields && mainLoginFields.style.display !== 'none') {
                        handleLogin();
                    }
                }
            };
        }

        if (togglePasswordButton && passwordInput) {
            const svgIconShowPassword = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
            const svgIconHidePassword = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';
            
            togglePasswordButton.onclick = () => {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    togglePasswordButton.innerHTML = svgIconHidePassword;
                    togglePasswordButton.setAttribute('title', 'Sembunyikan password');
                } else {
                    passwordInput.type = 'password';
                    togglePasswordButton.innerHTML = svgIconShowPassword;
                    togglePasswordButton.setAttribute('title', 'Lihat password');
                }
            };
        }
        showLoginForm(); 
        const footer = document.querySelector('footer');
        if (footer) footer.style.display = 'block';
        if (usernameInput) usernameInput.value = '';
        if (passwordInput) passwordInput.value = '';
        const resetIdentifierInput = document.getElementById('resetIdentifierInput');
        if (resetIdentifierInput) resetIdentifierInput.value = '';
        const otpInput = document.getElementById('otpInput');
        if (otpInput) otpInput.value = '';
        const newPasswordResetInput = document.getElementById('newPasswordResetInput');
        if (newPasswordResetInput) newPasswordResetInput.value = '';
        const confirmNewPasswordResetInput = document.getElementById('confirmNewPasswordResetInput');
        if (confirmNewPasswordResetInput) confirmNewPasswordResetInput.value = '';
        if(usernameInput) usernameInput.focus();
    }

    function handleLogin() {
        const usernameEl = document.getElementById('username');
        const passwordEl = document.getElementById('password');
        const loginErrorEl = document.getElementById('loginError');

        clearInputError(usernameEl, passwordEl);
        if (loginErrorEl) loginErrorEl.style.display = "none";

        const username = usernameEl.value.trim();
        const password = passwordEl.value;

        let hasError = false;
        if (!username) { showInputError(usernameEl); hasError = true; }
        if (!password) { showInputError(passwordEl); hasError = true; }

        if (hasError) {
            if (loginErrorEl) { loginErrorEl.textContent = "Username dan password wajib diisi."; loginErrorEl.style.display = "block"; }
            return;
        }
        showLoading("Memverifikasi login...");
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                if (response.success) {
                    loggedInUser = { username: response.username, role: response.role, teacherName: response.teacherName, googleEmail: response.googleEmail, primaryEmail: response.primaryEmail };
                    try {
                        sessionStorage.setItem('loggedInUserData', JSON.stringify(loggedInUser));
                    } catch (e) {
                        console.error("Failed to save user data to sessionStorage:", e);
                    }
                    document.body.classList.remove('login-active'); // Hapus kelas login-active dari body
                    proceedAfterLogin(); 
                } else {
                    if (loginErrorEl) { loginErrorEl.textContent = response.error || "Login gagal."; loginErrorEl.style.display = "block"; }
                    if (passwordEl) passwordEl.value = "";
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                if (loginErrorEl) { loginErrorEl.textContent = "Error server: " + err.message; loginErrorEl.style.display = "block"; }
            })
            .verifyLogin(username, password);
    }

    function logout() {
      loggedInUser = null; namaGuru = ''; dataTanggal = []; allTeachersList = [];
      currentLockIdValue = null; currentBackupSheetName = null;
      globalServerCurrentMonthYear = null; globalAdminMinMonthYear = null; activeCeklokMonthYear = null;
      activeRekapMonthYear = null; usernameForReset = null;
      if(otpTimerInterval) clearInterval(otpTimerInterval);
      otpTimerInterval = null;
      if(changeEmailOtpTimerInterval) clearInterval(changeEmailOtpTimerInterval);
      changeEmailOtpTimerInterval = null;
      proposedNewPrimaryEmail = null;
      
      const dropdownUsernameDisplayEl = document.getElementById('dropdownUsernameDisplay');
      if (dropdownUsernameDisplayEl) {
          dropdownUsernameDisplayEl.textContent = ''; 
      }
      
      const profileMenuContainer = document.getElementById('profileMenuContainer');
      if (profileMenuContainer) {
        profileMenuContainer.style.display = 'none';
        profileMenuContainer.classList.remove('show-dropdown'); 
      }

      // --- PERUBAHAN 3: Tambahkan baris ini untuk menghapus flag ---
      sessionStorage.removeItem('reminderShownForSession');
      
      sessionStorage.removeItem('loggedInUserData'); // Baris ini sudah ada, biarkan saja.
      clearTimeout(idleTimer);
      removeIdleListeners();
      document.body.classList.add('login-active');
      renderView('login');
      window.scrollTo(0, 0);
      showAlert("Anda telah logout.", "info", 2000);
    }

    function resetIdleTimer() {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(logoutDueToIdle, IDLE_TIMEOUT_MS);
    }
    function logoutDueToIdle() {
        console.log("Idle timeout reached.");
        showAlert("Sesi Anda berakhir karena tidak aktif. Silakan login kembali.", "warning", 5000);
        logout();
    }
    function setupIdleTimer() {
        console.log("Setting up idle timer and listeners.");
        removeIdleListeners();
        window.addEventListener('mousemove', resetIdleTimer);
        window.addEventListener('mousedown', resetIdleTimer);
        window.addEventListener('keypress', resetIdleTimer);
        window.addEventListener('scroll', resetIdleTimer, true);
        window.addEventListener('touchstart', resetIdleTimer);
        resetIdleTimer();
    }
    function removeIdleListeners() {
        console.log("Removing idle listeners.");
        window.removeEventListener('mousemove', resetIdleTimer);
        window.removeEventListener('mousedown', resetIdleTimer);
        window.removeEventListener('keypress', resetIdleTimer);
        window.removeEventListener('scroll', resetIdleTimer, true);
        window.removeEventListener('touchstart', resetIdleTimer);
    }

    // Pastikan konstanta peran ini sudah ada di bagian atas script Anda
    // const ROLE_SUPERADMIN = "superadmin";
    // const ROLE_ADMIN = "admin";
    // const ROLE_USER = "user";

    function proceedAfterLogin() {
        if (!loggedInUser) {
            renderView('login');
            return;
        }
        setupIdleTimer(); // Pastikan timer idle diatur

        const profileMenuContainer = document.getElementById('profileMenuContainer');
        const dropdownUsernameDisplayEl = document.getElementById('dropdownUsernameDisplay');
        if (profileMenuContainer) {
            profileMenuContainer.style.display = 'block';
        }

        // Logika untuk menampilkan nama di menu profil
        if (dropdownUsernameDisplayEl && loggedInUser) {
            if ((loggedInUser.role === ROLE_ADMIN || loggedInUser.role === ROLE_SUPERADMIN) && loggedInUser.username) {
                // Untuk admin dan superadmin, tampilkan username mereka
                dropdownUsernameDisplayEl.textContent = loggedInUser.username;
            } else if (loggedInUser.role === ROLE_USER && loggedInUser.teacherName) {
                dropdownUsernameDisplayEl.textContent = loggedInUser.teacherName;
            } else if (loggedInUser.username) { // Fallback jika kondisi di atas tidak terpenuhi tapi username ada
                dropdownUsernameDisplayEl.textContent = loggedInUser.username;
            } else {
                dropdownUsernameDisplayEl.textContent = "Pengguna"; // Default jika tidak ada info
            }
        }

        setupProfileMenuEventListeners();
        closeProfileDropdownOnClickOutside();
        closeProfileDropdownOnEscape();

        showLoading("Memuat data aplikasi...");
        google.script.run
            .withSuccessHandler(settingsResponse => {
                if (settingsResponse.error || !settingsResponse.success) {
                    hideLoading();
                    showAlert(`Error pengaturan tanggal: ${settingsResponse.error || 'Data tidak valid.'}`, 'error');
                    logout();
                    return;
                }
                globalAdminMinMonthYear = settingsResponse.adminDefinedMinMonthYear;
                globalServerCurrentMonthYear = settingsResponse.serverCurrentMonthYear;
                activeCeklokMonthYear = globalServerCurrentMonthYear; // Default periode ceklok

                // --- PERUBAHAN UTAMA ADA DI SINI ---
                if (loggedInUser.role === ROLE_ADMIN || loggedInUser.role === ROLE_SUPERADMIN) {
                    // Admin dan Superadmin akan diarahkan ke logika yang sama untuk memuat dashboard admin
                    google.script.run
                        .withSuccessHandler(response => {
                            hideLoading();
                            if (response.error) {
                                showAlert(`Error Inisialisasi Admin: ${response.error}`, 'error');
                                logout();
                                return;
                            }
                            allTeachersList = response.guruList || [];
                            renderView('admin_dashboard', {
                                guruList: allTeachersList,
                                adminDefinedMinMonthYearDisplay: response.adminDefinedMinMonthYear
                            }, () => {
                                // Pengecekan email utama setelah view dirender
                                // Berlaku untuk semua peran yang seharusnya memiliki email utama
                                if (!loggedInUser.primaryEmail &&
                                    (loggedInUser.role === ROLE_ADMIN || loggedInUser.role === ROLE_SUPERADMIN || loggedInUser.role === ROLE_USER)) {
                                    openPrimaryEmailModal();
                                }
                            });
                        })
                        .withFailureHandler(err => {
                            hideLoading();
                            showAlert(`Gagal memuat data awal admin: ${err.message}`, 'error');
                            logout();
                        })
                        .getInitialData(); // Fungsi ini mengambil data yang dibutuhkan admin/superadmin dashboard

                } else if (loggedInUser.role === ROLE_USER && loggedInUser.teacherName) {
                    namaGuru = loggedInUser.teacherName;
                    renderView('user_dashboard');
                } else {
                    // Jika peran tidak dikenali atau data tidak lengkap (misalnya, user tapi tidak ada teacherName)
                    hideLoading();
                    let errorMessage = "Peran pengguna tidak valid atau data pendukung tidak lengkap.";
                    if (loggedInUser.role === ROLE_USER && !loggedInUser.teacherName) {
                        errorMessage = `Data Nama Guru untuk pengguna '${loggedInUser.username}' tidak ditemukan. Silakan hubungi admin.`;
                    } else if (![ROLE_ADMIN, ROLE_SUPERADMIN, ROLE_USER].includes(loggedInUser.role)) {
                        errorMessage = `Peran pengguna '${loggedInUser.role}' tidak dikenal oleh sistem.`;
                    }
                    showAlert(errorMessage, 'error');
                    logout(); // Logout jika peran tidak sesuai atau data krusial hilang
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showAlert(`Gagal mengambil pengaturan tanggal server: ${err.message}`, 'error');
                logout();
            })
            .getCeklokInputSettings(); // Mengambil setting tanggal global
    }

    function loadCeklokDataFromServer(teacherName, monthYearToLoad, isUserRoleView, postRenderCallback) { 
        showLoading(`Memuat data ceklok...`);
        google.script.run
            .withSuccessHandler(ceklokResponse => {
                hideLoading();
                if (ceklokResponse.error) {
                    showAlert(`Error data ceklok: ${ceklokResponse.error}`, 'error');
                    const tableBody = document.getElementById('ceklokTableBody');
                    if (tableBody) tableBody.innerHTML = `<tr><td colspan="7" style="color:red; text-align:center;">${ceklokResponse.error}</td></tr>`;
                    const bulanTahunDisplayEl = document.getElementById('ceklokBulanTahunDisplay');
                    if(bulanTahunDisplayEl) bulanTahunDisplayEl.textContent = monthYearToLoad;
                    return;
                }
                dataTanggal = ceklokResponse.data;
                const ketLiburOptions = ceklokResponse.optionsKeteranganLibur;
                activeCeklokMonthYear = monthYearToLoad; 

                renderView('ceklok_table', {
                    rows: dataTanggal,
                    options: ketLiburOptions,
                    isUserRole: isUserRoleView,
                    currentMonthYearForDisplay: activeCeklokMonthYear
                }, postRenderCallback); 
            })
            .withFailureHandler(err => {
                hideLoading();
                showAlert(`Gagal memuat data ceklok: ${err.message}`, 'error');
            })
            .getCeklokData(namaGuru, monthYearToLoad);
    }

    function setupModalEventListeners() {
        const primaryEmailModal = document.getElementById('primaryEmailModal');
        if (primaryEmailModal) {
            primaryEmailModal.addEventListener('click', function(event) {
                if (event.target === primaryEmailModal) {
                    closePrimaryEmailModal();
                }
            });
        }
        const changeEmailModal = document.getElementById('changePrimaryEmailModal');
        if (changeEmailModal) {
            changeEmailModal.addEventListener('click', function(event) {
                if (event.target === changeEmailModal) {
                    closeChangePrimaryEmailModal();
                }
            });
        }
        const summaryDetailModalEl = document.getElementById('summaryDetailModal');
        if (summaryDetailModalEl) {
            summaryDetailModalEl.addEventListener('click', function(event) {
                if (event.target === summaryDetailModalEl) {
                    closeSummaryDetailModal();
                }
            });
        }
        const cdkDetailModalEl = document.getElementById('cdkDetailModal');
        if (cdkDetailModalEl) {
            cdkDetailModalEl.addEventListener('click', function(event) {
                if (event.target === cdkDetailModalEl) {
                    closeCdkDetailModal();
                }
            });
        }
        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape" || event.key === "Esc") {
                if (primaryEmailModal && primaryEmailModal.style.display === 'flex') {
                    closePrimaryEmailModal();
                }
                if (changeEmailModal && changeEmailModal.style.display === 'flex') {
                    closeChangePrimaryEmailModal();
                }
                const changePasswordModal = document.getElementById('changePasswordModal');
                if (changePasswordModal && changePasswordModal.style.display === 'block') { 
                    closeChangePasswordModal();
                }
                const profileMenuContainer = document.getElementById('profileMenuContainer');
                if (profileMenuContainer && profileMenuContainer.classList.contains('show-dropdown')) {
                    profileMenuContainer.classList.remove('show-dropdown');
                }
                if (summaryDetailModalEl && summaryDetailModalEl.style.display === 'flex') {
                    closeSummaryDetailModal();
                }
                if (cdkDetailModalEl && cdkDetailModalEl.style.display === 'flex') {
                    closeCdkDetailModal();
                }
            }
        });
    }

    // Di dalam file index.html, dalam blok <script>

    function setupAdminDashboardView(data) {
        // data yang diterima berisi: { guruList: response.guruList, adminDefinedMinMonthYearDisplay: response.adminDefinedMinMonthYear }
        // dari pemanggilan getInitialData() saat admin/superadmin login.
        const overallSummaryButton = document.getElementById('btnOverallSummary');
        if (overallSummaryButton) {
            if (loggedInUser && loggedInUser.role === ROLE_SUPERADMIN) {
                overallSummaryButton.style.display = 'block'; // Or 'inline-block' depending on your layout
            } else {
                overallSummaryButton.style.display = 'none';
            }
        }

        const namaSelect = document.getElementById('namaAdminSelect');
        if (namaSelect) {
            let guruOptionsHtml = '';
            if (data && data.guruList && data.guruList.length > 0) {
                // Simpan juga ke variabel global jika belum
                allTeachersList = data.guruList;
                guruOptionsHtml = data.guruList.map(n => `<option value="${n}">${n}</option>`).join('');
                namaSelect.innerHTML = `<option disabled selected value="">-- Pilih Nama Guru --</option>${guruOptionsHtml}`;
                namaSelect.disabled = false;
            } else {
                allTeachersList = []; // Pastikan kosong jika tidak ada data
                namaSelect.innerHTML = '<option value="" disabled selected>Tidak ada data guru</option>';
                namaSelect.disabled = true;
            }
        }

        const bulanAdminInputEl = document.getElementById('bulanAdminInput');
        if (bulanAdminInputEl) {
            // Set nilai dari data yang diterima saat setup view
            bulanAdminInputEl.value = (data && data.adminDefinedMinMonthYearDisplay) ? data.adminDefinedMinMonthYearDisplay : '';
            const labelBulanAdmin = document.querySelector('label[for="bulanAdminInput"]');
            if (labelBulanAdmin) {
                // Teks label ini bisa diatur statis di HTML atau di sini jika perlu dinamis
                labelBulanAdmin.textContent = "Batas Bawah Periode Ceklok (A1):";
            }
        }

        const nextBtn = document.getElementById('btnNextCeklokGuru');
        if (nextBtn) {
            nextBtn.disabled = !(data && data.guruList && data.guruList.length > 0);
        }

        // Scroll ke atas halaman
        window.scrollTo(0, 0);

        // Memuat dan menampilkan histori login
        const loginHistoryTableBody = document.getElementById('loginHistoryTableBody');
        if (loginHistoryTableBody) {
            loginHistoryTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 15px;">Memuat histori login...</td></tr>`;
        }

        // Pastikan loggedInUser dan loggedInUser.role sudah ada dan valid
        if (loggedInUser && loggedInUser.role) {
            google.script.run
                .withSuccessHandler(historyResponse => {
                    if (!loginHistoryTableBody) return; // Cek lagi jika elemen hilang

                    if (historyResponse.success) {
                        const historyEntries = historyResponse.history;
                        if (historyEntries && historyEntries.length > 0) {
                            let tableHtml = '';
                            historyEntries.forEach(entry => {
                                tableHtml += `<tr>
                                    <td data-label="Waktu Login">${entry.timestamp || '-'}</td>
                                    <td data-label="Pengguna">${entry.username || '-'}</td>
                                    <td data-label="Nama Guru">${entry.teacherName || '-'}</td>
                                </tr>`;
                            });
                            loginHistoryTableBody.innerHTML = tableHtml;
                        } else if (historyResponse.message) {
                            loginHistoryTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 15px;">${historyResponse.message}</td></tr>`;
                        } else {
                            loginHistoryTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 15px;">Tidak ada histori login untuk ditampilkan.</td></tr>`;
                        }
                    } else {
                        const errorMsg = historyResponse.error || "Gagal memuat histori login.";
                        loginHistoryTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 15px; color:red;">${errorMsg}</td></tr>`;
                        // Anda bisa tambahkan showAlert di sini jika ingin notifikasi error lebih menonjol
                        // showAlert(errorMsg, 'error');
                    }
                })
                .withFailureHandler(err => {
                    if (loginHistoryTableBody) {
                        loginHistoryTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 15px; color:red;">Error server: ${err.message}</td></tr>`;
                    }
                    // showAlert(`Gagal memuat histori login: ${err.message}`, 'error');
                })
                .getLoginHistory(loggedInUser.role, 20); // Mengirim peran pengguna yang login
        } else {
            // Jika loggedInUser atau loggedInUser.role tidak ada (seharusnya tidak terjadi jika sudah login)
            if (loginHistoryTableBody) {
                loginHistoryTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 15px; color:red;">Tidak dapat memuat histori login: informasi sesi pengguna tidak valid.</td></tr>`;
            }
            console.error("Informasi loggedInUser tidak lengkap untuk memuat histori login.");
        }

        // Memuat daftar bulan yang terkunci untuk ditampilkan di dashboard admin
        if (typeof loadLockedMonthsForAdminDisplay === "function") {
            loadLockedMonthsForAdminDisplay();
        } else {
            console.error("Fungsi loadLockedMonthsForAdminDisplay tidak ditemukan.");
            const lockedDisplayDiv = document.getElementById('lockedMonthsDisplay');
            if(lockedDisplayDiv) lockedDisplayDiv.innerHTML = '<p style="color:red;">Error: Komponen tampilan bulan terkunci gagal dimuat.</p>';
        }

        // === BARU: Tambahkan Tombol Lihat Log Aktivitas untuk Superadmin ===
        if (loggedInUser && loggedInUser.role === ROLE_SUPERADMIN) {
            const menuButtonContainer = document.querySelector('#adminDashboardContainer .form-column .btn-container[style*="flex-direction: column"]');
            if (menuButtonContainer) {
                if (!document.getElementById('btnViewActivityLog')) {
                    const activityLogButton = document.createElement('button');
                    activityLogButton.id = "btnViewActivityLog";
                    activityLogButton.textContent = "Lihat Log Aktivitas Pengguna";
                    activityLogButton.onclick = navigateToActivityLog;
                    activityLogButton.classList.add('btn-info');
                    // activityLogButton.style.marginTop = "10px"; // Jika ada style, pastikan valid
                    menuButtonContainer.appendChild(activityLogButton);
                }
            } // ELSE INI MUNGKIN HILANG ATAU SALAH TEMPAT
        }
    }

    function handleAdminPilihGuru() {
        const namaSelect = document.getElementById('namaAdminSelect');
        if (!namaSelect || !namaSelect.value) { showAlert('Pilih nama guru dahulu.', 'error'); return; }
        namaGuru = namaSelect.value;

        if (!globalServerCurrentMonthYear) {
            showAlert('Pengaturan bulan server tidak termuat. Coba refresh.', 'error'); return;
        }
        activeCeklokMonthYear = globalServerCurrentMonthYear; 
        loadCeklokDataFromServer(namaGuru, activeCeklokMonthYear, false); 
    }

    function handleUpdateBulanTahunAdmin() {
        const bulanAdminInputEl = document.getElementById('bulanAdminInput');
        if (!bulanAdminInputEl) { showAlert("Elemen input Bulan/Tahun tidak ditemukan.", 'error'); return; }
        const newBulanTahunValue = bulanAdminInputEl.value.trim();
        clearInputError(bulanAdminInputEl);

        if (!newBulanTahunValue) { showAlert("Batas Bawah Periode tidak boleh kosong.", 'error'); showInputError(bulanAdminInputEl); return; }
        if (!/^(0[1-9]|1[0-2])\/(20\d{2}|21\d{2})$/.test(newBulanTahunValue)) {
            showAlert("Format Batas Bawah Periode salah (mm/yyyy, tahun 2000-2199).", 'error'); showInputError(bulanAdminInputEl); return;
        }
        showLoading("Memperbarui Batas Bawah Periode Ceklok...");
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                if (response.success) {
                    showAlert(response.message, 'success');
                    if(bulanAdminInputEl) bulanAdminInputEl.value = response.newBulanTahun;
                    globalAdminMinMonthYear = response.newBulanTahun; 
                } else { showAlert(response.error || "Gagal update.", 'error'); }
            })
            .withFailureHandler(err => { hideLoading(); showAlert(`Error server update: ${err.message}`, 'error'); })
            .setBulanTahunSetting(newBulanTahunValue, loggedInUser.username, loggedInUser.role);
    }

    // Di dalam file index.html, dalam blok <script>

    // Pastikan konstanta peran ini sudah didefinisikan secara global di skrip Anda
    // const ROLE_SUPERADMIN = "superadmin";
    // const ROLE_ADMIN = "admin";
    // const ROLE_USER = "user";

    function goBackToAdminDashboard() {
        // Periksa apakah pengguna yang login adalah ADMIN atau SUPERADMIN
        if (loggedInUser && (loggedInUser.role === ROLE_ADMIN || loggedInUser.role === ROLE_SUPERADMIN)) {
            showLoading("Kembali ke Dashboard Admin..."); // Tambahkan indikator loading

            // Ambil setting tanggal terbaru sebelum merender dashboard admin
            google.script.run
                .withSuccessHandler(settingsResponse => {
                    if (settingsResponse.error || !settingsResponse.success) {
                        hideLoading(); // Sembunyikan loading jika ada error
                        showAlert(`Gagal memuat pengaturan tanggal: ${settingsResponse.error || 'Data tidak valid.'}`, 'error');
                        // Pertimbangkan untuk tidak logout di sini, biarkan pengguna di halaman saat ini dengan pesan error
                        return;
                    }
                    globalAdminMinMonthYear = settingsResponse.adminDefinedMinMonthYear;
                    globalServerCurrentMonthYear = settingsResponse.serverCurrentMonthYear;
                    // activeCeklokMonthYear juga bisa direset di sini jika perlu,
                    // atau biarkan menggunakan nilai dari settingsResponse.serverCurrentMonthYear saat dashboard admin dimuat

                    // Setelah mendapatkan setting, ambil data awal untuk dashboard admin
                    google.script.run
                        .withSuccessHandler(response => {
                            // hideLoading() akan dipanggil oleh renderView atau callbacknya
                            if (response.error) {
                                hideLoading();
                                showAlert(`Error memuat data awal admin: ${response.error}`, 'error');
                                return;
                            }
                            allTeachersList = response.guruList || [];
                            renderView('admin_dashboard', {
                                guruList: allTeachersList,
                                adminDefinedMinMonthYearDisplay: response.adminDefinedMinMonthYear // Kirim nilai terbaru
                            }
                            // , () => { // Callback opsional setelah renderView, jika ada pengecekan email utama
                            //     if (!loggedInUser.primaryEmail) {
                            //         openPrimaryEmailModal();
                            //     }
                            // }
                            );
                        })
                        .withFailureHandler(err => {
                            hideLoading();
                            showAlert(`Gagal memuat data awal admin: ${err.message}`, 'error');
                        })
                        .getInitialData();
                })
                .withFailureHandler(err => {
                    hideLoading();
                    showAlert(`Gagal memuat pengaturan tanggal: ${err.message}`, 'error');
                })
                .getCeklokInputSettings();
        } else if (loggedInUser && loggedInUser.role === ROLE_USER) {
            // Jika pengguna biasa (guru) secara tidak sengaja memanggil fungsi ini,
            // arahkan mereka kembali ke tampilan ceklok mereka atau logout jika data tidak lengkap.
            hideLoading(); // Pastikan loading disembunyikan
            showAlert("Navigasi tidak sesuai untuk peran Anda. Kembali ke halaman ceklok.", "info");
            if (loggedInUser.teacherName) {
                const monthToLoad = activeCeklokMonthYear || globalServerCurrentMonthYear;
                if (monthToLoad) {
                    loadCeklokDataFromServer(loggedInUser.teacherName, monthToLoad, true);
                } else {
                    // Jika tidak ada periode aktif, coba muat dengan periode server
                    if (globalServerCurrentMonthYear) {
                        loadCeklokDataFromServer(loggedInUser.teacherName, globalServerCurrentMonthYear, true);
                    } else {
                        // Jika semua gagal, logout
                        logout();
                    }
                }
            } else {
                logout(); // Jika nama guru tidak ada
            }
        }
        else {
            // Jika pengguna tidak login atau peran tidak dikenali, lakukan logout
            hideLoading(); // Pastikan loading disembunyikan
            logout();
        }
    }

    function setupCeklokTableView(data) {
        console.log("Data diterima oleh setupCeklokTableView:", data);
        const { rows, options: ketLiburOptions, isUserRole, currentMonthYearForDisplay, isLocked } = data;
        console.log("Status isLocked di frontend:", isLocked);
        const tableBody = document.getElementById('ceklokTableBody');
        const guruNameEl = document.getElementById('ceklokGuruName');
        const bulanTahunDisplayEl = document.getElementById('ceklokBulanTahunDisplay');
        const ceklokBulanSelectEl = document.getElementById('ceklokBulanSelect');
        const ceklokTahunSelectEl = document.getElementById('ceklokTahunSelect');
        const btnKembaliContainer = document.getElementById('ceklokTombolKembaliContainer');
        const summaryDashboardElement = document.getElementById('teacherDashboardSummary');

        const isMonthLocked = isLocked;
        const btnSimpanCeklok = document.getElementById('btnSimpanCeklok');
        const ceklokLockMessageDiv = document.getElementById('ceklokLockMessage');

        if (btnSimpanCeklok) {
            if (isMonthLocked) {
                btnSimpanCeklok.disabled = true;
                btnSimpanCeklok.classList.add('btn-disabled');
            } else {
                btnSimpanCeklok.disabled = false;
                btnSimpanCeklok.classList.remove('btn-disabled');
            }
        }

        if (ceklokLockMessageDiv) {
            if (isMonthLocked) {
                ceklokLockMessageDiv.textContent = "PERHATIAN: Bulan ini telah dikunci oleh Admin dan data ceklok tidak dapat diubah.";
                ceklokLockMessageDiv.style.display = 'block';
            } else {
                ceklokLockMessageDiv.style.display = 'none';
            }
        }
        // --- AKHIR PENAMBAHAN LOGIKA PENGUNCIAN TOMBOL SIMPAN & PESAN ---

        if (isUserRole && summaryDashboardElement) {
            summaryDashboardElement.style.display = 'block';
            const monthForSummary = currentMonthYearForDisplay || activeCeklokMonthYear || globalServerCurrentMonthYear;
            if (namaGuru && monthForSummary) {
                loadAndDisplayTeacherSummary(namaGuru, monthForSummary);
            } else {
                const summaryErrorEl = document.getElementById('summaryContentError');
                const summaryLoadingEl = document.getElementById('summaryContentLoading');
                const summaryDataEl = document.getElementById('summaryContentData');
                if(summaryErrorEl && summaryLoadingEl && summaryDataEl){
                    summaryLoadingEl.style.display = 'none';
                    summaryDataEl.style.display = 'none';
                    summaryErrorEl.textContent = "Informasi guru atau periode untuk ringkasan tidak tersedia.";
                    summaryErrorEl.style.display = 'block';
                }
            }
        } else if (summaryDashboardElement) {
            summaryDashboardElement.style.display = 'none';
        }

        if (guruNameEl) guruNameEl.textContent = namaGuru;
        if (bulanTahunDisplayEl) bulanTahunDisplayEl.textContent = currentMonthYearForDisplay || activeCeklokMonthYear || "Bulan belum dipilih";

        if (ceklokBulanSelectEl && ceklokTahunSelectEl) {
            const targetMonthYear = currentMonthYearForDisplay || activeCeklokMonthYear || globalServerCurrentMonthYear;
            let defaultYear = getYearFromMMYYYY(targetMonthYear);
            let defaultMonth = getMonthStrFromMMYYYY(targetMonthYear);

            let minAllowedYear = getYearFromMMYYYY(globalAdminMinMonthYear);
            let maxAllowedYear = getYearFromMMYYYY(globalServerCurrentMonthYear);

            if (isNaN(minAllowedYear)) minAllowedYear = new Date().getFullYear() - 5;
            if (isNaN(maxAllowedYear)) maxAllowedYear = new Date().getFullYear();
            if (isNaN(defaultYear)) defaultYear = maxAllowedYear;
            if (!defaultMonth || defaultMonth.length !== 2) defaultMonth = String(new Date().getMonth() + 1).padStart(2, '0');

            populateYearSelect('ceklokTahunSelect', minAllowedYear, maxAllowedYear, defaultYear);
            ceklokBulanSelectEl.value = defaultMonth;

            ceklokTahunSelectEl.onchange = () => validateMonthRange('ceklokBulanSelect', 'ceklokTahunSelect');
            ceklokBulanSelectEl.onchange = () => validateMonthRange('ceklokBulanSelect', 'ceklokTahunSelect');
            validateMonthRange('ceklokBulanSelect', 'ceklokTahunSelect');
        }

        if (tableBody) {
            let bodyHtml = '';
            if (rows && rows.length > 0) {
                rows.forEach((row, i) => {
                    if (row.isLibur) {
                        // MODIFIKASI COLSPAN DI SINI
                        bodyHtml += `<tr class="libur-row">
                            <td class="libur-text" data-label="Hari">${row.hari}</td>
                            <td class="libur-text" data-label="Tanggal">${row.tanggal}</td>
                            <td data-label="Data Masuk" style="text-align: center;">-</td>
                            <td data-label="Data Pulang" style="text-align: center;">-</td>
                            <td colspan="4" class="libur-note" data-label="Keterangan"><span class="holiday-description">${row.keterangan || 'Hari Libur'}</span></td>
                        </tr>`;
                    } else {
                        let ketLiburDropdownHtml = `<select id="ketLiburManual${i}" class="inline-select ket-libur-manual-dropdown" data-rowindex="${i}" ${isMonthLocked ? 'disabled' : ''}>`;
                        ketLiburDropdownHtml += '<option value="">-- Alasan Tidak Hadir --</option>';
                        if (ketLiburOptions && ketLiburOptions.length > 0) {
                            ketLiburOptions.forEach(opt => {
                                const selected = (opt === row.keteranganLiburManual) ? 'selected' : '';
                                ketLiburDropdownHtml += `<option value="${opt}" ${selected}>${opt}</option>`;
                            });
                        }
                        ketLiburDropdownHtml += '</select>';
                        
                        const isKetLiburManualSelected = row.keteranganLiburManual && row.keteranganLiburManual.trim() !== "";
                        const jamMasukInputValue = isKetLiburManualSelected ? "" : (row.dataMasuk || "");
                        const jamPulangInputValue = isKetLiburManualSelected ? "" : (row.dataPulang || "");

                        const inputDisabledAttr = isMonthLocked ? 'disabled' : (isKetLiburManualSelected ? 'disabled' : '');

                        // --- BARIS HTML UTAMA YANG DIMODIFIKASI ---
                        bodyHtml += `<tr>
                            <td data-label="Hari">${row.hari}</td>
                            <td data-label="Tanggal">${row.tanggal}</td>
                            <td data-label="Data Masuk" style="text-align: center;">${row.dataMasuk || '-'}</td>
                            <td data-label="Data Pulang" style="text-align: center;">${row.dataPulang || '-'}</td>
                            <td data-label="Input Jam Masuk"><input type="text" class="inline-input" id="jamMasuk${i}" placeholder="HH.MM" value="${jamMasukInputValue}" ${inputDisabledAttr}></td>
                            <td data-label="Input Jam Pulang"><input type="text" class="inline-input" id="jamPulang${i}" placeholder="HH.MM" value="${jamPulangInputValue}" ${inputDisabledAttr}></td>
                            <td data-label="Keterangan Libur/Alasan">${ketLiburDropdownHtml}</td>
                            <td data-label="Aksi" class="actions-cell">
                                <button class="btn-danger" style="padding: 5px 10px; font-size: 0.9em;" onclick="clearCeklokRow(${i})" title="Hapus Isian Baris Ini" ${isMonthLocked ? 'disabled' : ''}>Hapus</button>
                            </td>
                        </tr>`;
                    }
                });
            } else {
                // MODIFIKASI COLSPAN DI SINI
                bodyHtml = `<tr><td colspan="8" style="text-align:center;">Tidak ada data untuk periode ini atau periode belum dipilih.</td></tr>`;
            }
            tableBody.innerHTML = bodyHtml;
            
            attachTimeInputValidationToCeklok();
            attachKetLiburDropdownListeners();
        }

        // Kode baru untuk mengontrol tombol kembali
        const btnKembaliAdminContainer = document.getElementById('ceklokTombolKembaliContainer');
        const btnKembaliPengguna = document.getElementById('ceklokTombolKembaliPengguna');

        if (isUserRole) {
            // Jika yang login adalah GURU, tampilkan tombol kembali ke dasbor guru
            if (btnKembaliPengguna) btnKembaliPengguna.style.display = 'inline-block';
            if (btnKembaliAdminContainer) btnKembaliAdminContainer.style.display = 'none';
        } else {
            // Jika yang login adalah ADMIN, tampilkan tombol kembali ke dashboard admin
            if (btnKembaliPengguna) btnKembaliPengguna.style.display = 'none';
            if (btnKembaliAdminContainer) btnKembaliAdminContainer.style.display = 'inline-block';
        }


        // ===== KODE JAVASCRIPT BARU (PERBAIKAN - EFEK PERMANEN) =====
        const importContainer = document.querySelector('.collapsible-excel-export');
        if (importContainer) {
            // Cukup tambahkan kelas 'glow-effect' untuk memulai animasi secara permanen.
            importContainer.classList.add('glow-effect');
        }
        // ==========================================================

        setupLockIdAndExportClientFeatures();
        window.scrollTo(0, 0);
    }

    function loadCeklokDataForSelectedMonth() {
        const bulanSelectEl = document.getElementById('ceklokBulanSelect');
        const tahunSelectEl = document.getElementById('ceklokTahunSelect');

        if (!bulanSelectEl || !tahunSelectEl) {
            showAlert("Elemen input bulan atau tahun tidak ditemukan.", "error"); return;
        }
        const selectedMonth = bulanSelectEl.value; 
        const selectedYear = tahunSelectEl.value;  

        if (!selectedMonth || !selectedYear) {
            showAlert("Pilih bulan dan tahun terlebih dahulu.", "warning"); return;
        }
        if (bulanSelectEl.options[bulanSelectEl.selectedIndex].disabled) {
            showAlert("Bulan yang dipilih tidak valid untuk tahun ini. Silakan pilih bulan lain.", "warning");
            return;
        }

        const newActiveMonthYear = `${selectedMonth}/${selectedYear}`; 

        const minYear = getYearFromMMYYYY(globalAdminMinMonthYear);
        const minMonth = parseInt(getMonthStrFromMMYYYY(globalAdminMinMonthYear));
        const maxYear = getYearFromMMYYYY(globalServerCurrentMonthYear);
        const maxMonth = parseInt(getMonthStrFromMMYYYY(globalServerCurrentMonthYear));
        const currentSelectedYear = parseInt(selectedYear);
        const currentSelectedMonth = parseInt(selectedMonth);

        if (currentSelectedYear < minYear || (currentSelectedYear === minYear && currentSelectedMonth < minMonth)) {
            showAlert(`Periode tidak valid. Minimum adalah ${globalAdminMinMonthYear}.`, "error");
            return;
        }
        if (currentSelectedYear > maxYear || (currentSelectedYear === maxYear && currentSelectedMonth > maxMonth)) {
            showAlert(`Periode tidak valid. Maksimum adalah ${globalServerCurrentMonthYear}.`, "error");
            return;
        }

        if (!namaGuru) {
            showAlert("Nama guru tidak diset. Tidak bisa memuat data.", "error"); return;
        }
        loadCeklokDataFromServer(namaGuru, newActiveMonthYear, loggedInUser.role === 'user');
    }


    function attachTimeInputValidationToCeklok() {
        const inputs = document.querySelectorAll('#ceklokTableBody input[type="text"]');
        inputs.forEach(input => {
            input.oninput = () => clearInputError(input); 
            input.onblur = (e) => {
                const v = e.target.value.trim();
                clearInputError(input);
                if (v && !isValidJamFormat(v)) {
                    showInputError(input);
                    showAlert('Format jam salah (HH.MM). Contoh: 07.30 atau 14.15.', 'error', 2000);
                } else if (v) {
                    e.target.value = normalizeJamFormat(v);
                }
            };
        });
    }

    function attachKetLiburDropdownListeners() {
        const dropdowns = document.querySelectorAll('.ket-libur-manual-dropdown');
        const isCurrentlyLocked = document.getElementById('ceklokLockMessage')?.style.display === 'block'; // Cara sederhana cek status lock dari UI

        dropdowns.forEach(dropdown => {
            // Jika bulan terkunci, pastikan dropdown itu sendiri sudah disabled dari setupCeklokTableView.
            // Listener ini akan tetap ada, tapi tidak akan banyak berpengaruh jika dropdownnya disabled.
            // Namun, untuk lebih aman, kita bisa tambahkan cek di sini juga.
            if (isCurrentlyLocked) {
                dropdown.disabled = true; // Pastikan lagi
            }

            dropdown.onchange = function() {
                // Jika bulan terkunci, jangan lakukan apa-apa terkait enable/disable input jam.
                if (isCurrentlyLocked) return; 

                const rowIndex = this.dataset.rowindex;
                const jamMasukInput = document.getElementById(`jamMasuk${rowIndex}`);
                const jamPulangInput = document.getElementById(`jamPulang${rowIndex}`);
                const isKeteranganSelected = this.value !== "";

                if (jamMasukInput) {
                    jamMasukInput.disabled = isKeteranganSelected;
                    if (isKeteranganSelected) jamMasukInput.value = "";
                }
                if (jamPulangInput) {
                    jamPulangInput.disabled = isKeteranganSelected;
                    if (isKeteranganSelected) jamPulangInput.value = "";
                }
            };
            // Pemicu awal jika dropdown sudah memiliki nilai saat load (untuk kasus edit atau data yang sudah ada)
            // Namun, ini juga harus menghormati status lock
            if (!isCurrentlyLocked && dropdown.value !== "") {
                const rowIndex = dropdown.dataset.rowindex;
                const jamMasukInput = document.getElementById(`jamMasuk${rowIndex}`);
                const jamPulangInput = document.getElementById(`jamPulang${rowIndex}`);
                if (jamMasukInput) jamMasukInput.disabled = true;
                if (jamPulangInput) jamPulangInput.disabled = true;
            }
        });
    }

    function submitCeklokData() {
        let hasInvalidFormat = false;
        const inputsToValidate = document.querySelectorAll('#ceklokTableBody input[type="text"]:not([disabled])');
        inputsToValidate.forEach(input => { 
             if (input.value.trim() && !isValidJamFormat(input.value.trim())) {
                showInputError(input);
                hasInvalidFormat = true;
            }
        });

        if (hasInvalidFormat) { showAlert("Ada format jam yang salah. Perbaiki sebelum menyimpan.", 'error'); return; }

        showLoading("Menyimpan data ceklok...");
        const dataToSave = dataTanggal.map((row, i) => {
            if (!row.isLibur) {
                const jamMasukEl = document.getElementById(`jamMasuk${i}`);
                const jamPulangEl = document.getElementById(`jamPulang${i}`);
                const ketLiburManualEl = document.getElementById(`ketLiburManual${i}`);
                let jamMasukVal = jamMasukEl ? jamMasukEl.value.trim() : '';
                let jamPulangVal = jamPulangEl ? jamPulangEl.value.trim() : '';
                const ketLiburManualVal = ketLiburManualEl ? ketLiburManualEl.value : '';
                if (ketLiburManualVal && ketLiburManualVal !== "") {
                    jamMasukVal = ""; jamPulangVal = "";
                }
                return { tanggal: row.tanggal, jamMasuk: jamMasukVal, jamPulang: jamPulangVal, keteranganLiburManual: ketLiburManualVal };
            }
            return null;
        }).filter(item => item !== null);

        if (!namaGuru || !activeCeklokMonthYear) { 
            hideLoading();
            showAlert("Error: Informasi guru atau periode bulan tidak lengkap untuk penyimpanan.", "error");
            return;
        }

        google.script.run
            .withSuccessHandler(msg => {
                hideLoading();
                const isError = String(msg).toLowerCase().startsWith("error:");
                showAlert(msg, isError ? 'error' : 'success');
                if (namaGuru && activeCeklokMonthYear) {
                    loadCeklokDataFromServer(namaGuru, activeCeklokMonthYear, loggedInUser.role === 'user');
                }
            })
            .withFailureHandler(err => { hideLoading(); showAlert(`Gagal menyimpan: ${err.message}`, 'error'); })
            .simpanData(namaGuru, dataToSave, loggedInUser.username, loggedInUser.role);
    }

    /**
     * Membersihkan input pada baris ceklok tertentu.
     * Ini adalah aksi di sisi klien dan tidak menyimpan data.
     * @param {number} rowIndex Indeks baris yang akan dibersihkan.
     */
    function clearCeklokRow(rowIndex) {
        // Ambil elemen-elemen input berdasarkan rowIndex
        const jamMasukEl = document.getElementById(`jamMasuk${rowIndex}`);
        const jamPulangEl = document.getElementById(`jamPulang${rowIndex}`);
        const ketLiburManualEl = document.getElementById(`ketLiburManual${rowIndex}`);

        // Bersihkan nilai input jam masuk
        if (jamMasukEl) {
            jamMasukEl.value = '';
            jamMasukEl.disabled = false; // Aktifkan kembali
            clearInputError(jamMasukEl); // Hapus style error jika ada
        }

        // Bersihkan nilai input jam pulang
        if (jamPulangEl) {
            jamPulangEl.value = '';
            jamPulangEl.disabled = false; // Aktifkan kembali
            clearInputError(jamPulangEl); // Hapus style error jika ada
        }

        // Reset dropdown keterangan ke pilihan default
        if (ketLiburManualEl) {
            ketLiburManualEl.value = ''; // Mengatur ke pilihan dengan value=""
        }
        
        // Beri notifikasi ringan ke pengguna
        showAlert("Isian baris telah dibersihkan. Klik 'Simpan Data Ceklok' untuk menyimpan perubahan.", "info", 2500);
    }

    function navigateToHasilCeklok() {
        showLoading("Membuka halaman rekapitulasi...");
        const monthToLoad = activeCeklokMonthYear || globalServerCurrentMonthYear;

        renderView('hasil_ceklok', {
            defaultMonthForRekap: monthToLoad 
        });
    }
    
    function setupHasilCeklokView(data) {
        const rekapInfoBulanEl = document.getElementById('rekapInfoBulanTahun');
        const rekapTableTheadEl = document.getElementById('rekapTableThead');
        const rekapTableTbodyEl = document.getElementById('rekapTableTbody');
        const rekapControlsContainer = document.getElementById('rekapControlsContainer');
        const rekapBulanSelectEl = document.getElementById('rekapBulanSelect');
        const rekapTahunSelectEl = document.getElementById('rekapTahunSelect');

        if (!rekapInfoBulanEl || !rekapTableTheadEl || !rekapTableTbodyEl || !rekapControlsContainer || !rekapBulanSelectEl || !rekapTahunSelectEl) {
            console.error("Elemen UI penting untuk rekap bulanan tidak ditemukan.");
            showAlert("Gagal memuat komponen halaman rekap.", "error");
            hideLoading(); // Pastikan loading disembunyikan jika ada error di awal
            return;
        }
        
        activeRekapMonthYear = null; // Reset periode rekap aktif

        // Periksa peran pengguna
        const isAdminOrSuperAdmin = loggedInUser && (loggedInUser.role === ROLE_ADMIN || loggedInUser.role === ROLE_SUPERADMIN);

        if (isAdminOrSuperAdmin) {
            // Untuk Admin/Superadmin: selalu tampilkan kontrol pemilihan periode
            hideLoading(); // Sembunyikan loading jika ada yang aktif sebelumnya
            rekapControlsContainer.style.display = 'block'; 
            if(rekapInfoBulanEl) rekapInfoBulanEl.textContent = "Periode Belum Dipilih";
            if(rekapTableTheadEl) rekapTableTheadEl.innerHTML = ""; // Kosongkan header tabel lama
            if(rekapTableTbodyEl) rekapTableTbodyEl.innerHTML = `<tr><td colspan="1" style="text-align:center; padding:15px;">Silakan pilih Bulan dan Tahun, lalu klik "Tampilkan Rekap".</td></tr>`;

            // Ambil tahun dan bulan default (misalnya, bulan server saat ini)
            // dan batas minimum/maksimum untuk dropdown
            const defaultYearForDropdown = getYearFromMMYYYY(globalServerCurrentMonthYear) || new Date().getFullYear();
            const defaultMonthForDropdown = getMonthStrFromMMYYYY(globalServerCurrentMonthYear) || String(new Date().getMonth() + 1).padStart(2, '0');
            
            const minAllowedYearForDropdown = getYearFromMMYYYY(globalAdminMinMonthYear) || (new Date().getFullYear() - 5); // Batas bawah dari Setting A1
            const maxAllowedYearForDropdown = getYearFromMMYYYY(globalServerCurrentMonthYear) || new Date().getFullYear(); // Batas atas adalah bulan server

            populateYearSelect('rekapTahunSelect', minAllowedYearForDropdown, maxAllowedYearForDropdown, defaultYearForDropdown);
            if(rekapBulanSelectEl) rekapBulanSelectEl.value = defaultMonthForDropdown;
            
            // Validasi rentang bulan yang bisa dipilih berdasarkan tahun yang terpilih dan batasan global
            validateMonthRange('rekapBulanSelect', 'rekapTahunSelect');

        } else { // Untuk pengguna biasa (ROLE_USER)
            // Muat rekap untuk periode default pengguna (perilaku lama)
            const monthYearToLoadForUser = data.defaultMonthForRekap || activeCeklokMonthYear || globalServerCurrentMonthYear;
            if (monthYearToLoadForUser && /^\d{2}\/\d{4}$/.test(monthYearToLoadForUser)) {
                rekapControlsContainer.style.display = 'none'; // Sembunyikan kontrol pemilihan
                if(rekapInfoBulanEl) rekapInfoBulanEl.textContent = monthYearToLoadForUser;
                if(rekapTableTheadEl) rekapTableTheadEl.innerHTML = "";
                if(rekapTableTbodyEl) rekapTableTbodyEl.innerHTML = `<tr><td colspan="1" style="text-align:center; padding:20px;">Memuat data rekap untuk ${monthYearToLoadForUser}...</td></tr>`;
                loadMonthlyRekap(monthYearToLoadForUser); // Fungsi ini akan memanggil showLoading() di dalamnya
            } else {
                // Fallback jika periode default pengguna tidak valid (seharusnya jarang terjadi)
                hideLoading();
                rekapControlsContainer.style.display = 'block'; 
                showAlert("Periode default tidak dapat ditentukan. Silakan pilih periode manual.", "warning");
                if(rekapInfoBulanEl) rekapInfoBulanEl.textContent = "Periode Belum Dipilih";
                if(rekapTableTbodyEl) rekapTableTbodyEl.innerHTML = `<tr><td colspan="1" style="text-align:center; padding:15px;">Kesalahan: Periode tidak valid.</td></tr>`;
                 // Anda bisa memilih untuk mengisi dropdown di sini juga sebagai fallback
                const fallbackYear = getYearFromMMYYYY(globalServerCurrentMonthYear) || new Date().getFullYear();
                const fallbackMonth = getMonthStrFromMMYYYY(globalServerCurrentMonthYear) || String(new Date().getMonth() + 1).padStart(2, '0');
                const minAllowedYearPopulate = getYearFromMMYYYY(globalAdminMinMonthYear) || new Date().getFullYear() - 5;
                const maxAllowedYearPopulate = getYearFromMMYYYY(globalServerCurrentMonthYear) || new Date().getFullYear();
                populateYearSelect('rekapTahunSelect', minAllowedYearPopulate, maxAllowedYearPopulate, fallbackYear);
                if(rekapBulanSelectEl) rekapBulanSelectEl.value = fallbackMonth;
                validateMonthRange('rekapBulanSelect', 'rekapTahunSelect');
            }
        }
        window.scrollTo(0, 0); // Scroll ke atas halaman
    }


    function loadMonthlyRekap(monthYearToLoadParam) {
        const rekapBulanSelectEl = document.getElementById('rekapBulanSelect');
        const rekapTahunSelectEl = document.getElementById('rekapTahunSelect');
        const rekapInfoBulanEl = document.getElementById('rekapInfoBulanTahun');
        const rekapTableTheadEl = document.getElementById('rekapTableThead');
        const rekapTableTbodyEl = document.getElementById('rekapTableTbody');

        if (!rekapInfoBulanEl || !rekapTableTheadEl || !rekapTableTbodyEl) {
            showAlert("Komponen UI rekap tidak siap atau tidak ditemukan.", "error");
            hideLoading(); 
            return;
        }

        let selectedMonthYear;

        if (monthYearToLoadParam && /^\d{2}\/\d{4}$/.test(monthYearToLoadParam)) {
            selectedMonthYear = monthYearToLoadParam;
            if (rekapBulanSelectEl && rekapTahunSelectEl) {
                const [mm, yyyy] = selectedMonthYear.split('/');
                rekapBulanSelectEl.value = mm;
                rekapTahunSelectEl.value = yyyy;
            }
        } else { 
            if (!rekapBulanSelectEl || !rekapTahunSelectEl) {
                showAlert("Elemen pilih bulan/tahun tidak ditemukan.", "error");
                hideLoading();
                return;
            }
            const selectedMonth = rekapBulanSelectEl.value;
            const selectedYear = rekapTahunSelectEl.value;

            if (!selectedMonth || !selectedYear) {
                showAlert("Silakan pilih Bulan dan Tahun untuk ditampilkan.", "warning");
                return; 
            }
            if (rekapBulanSelectEl.options[rekapBulanSelectEl.selectedIndex] && rekapBulanSelectEl.options[rekapBulanSelectEl.selectedIndex].disabled) {
                showAlert("Bulan yang dipilih tidak valid untuk tahun ini.", "warning");
                return;
            }
            selectedMonthYear = `${selectedMonth}/${selectedYear}`;
        }

        if (globalAdminMinMonthYear && globalServerCurrentMonthYear) {
            const [sMonth, sYear] = selectedMonthYear.split('/');
            const minYear = getYearFromMMYYYY(globalAdminMinMonthYear);
            const minMonthStr = getMonthStrFromMMYYYY(globalAdminMinMonthYear);
            const minMonth = minMonthStr ? parseInt(minMonthStr, 10) : null;
            const maxYear = getYearFromMMYYYY(globalServerCurrentMonthYear);
            const maxMonthStr = getMonthStrFromMMYYYY(globalServerCurrentMonthYear);
            const maxMonth = maxMonthStr ? parseInt(maxMonthStr, 10) : null;
            const currentSelectedYear = parseInt(sYear, 10);
            const currentSelectedMonth = parseInt(sMonth, 10);
        
            if (minMonth !== null && (currentSelectedYear < minYear || (currentSelectedYear === minYear && currentSelectedMonth < minMonth))) {
                showAlert(`Periode rekap ${selectedMonthYear} di luar rentang minimal (${globalAdminMinMonthYear}).`, "error");
                if (monthYearToLoadParam) hideLoading();
                return;
            }
            if (maxMonth !== null && (currentSelectedYear > maxYear || (currentSelectedYear === maxYear && currentSelectedMonth > maxMonth))) {
                showAlert(`Periode rekap ${selectedMonthYear} di luar rentang maksimal (${globalServerCurrentMonthYear}).`, "error");
                if (monthYearToLoadParam) hideLoading();
                return;
            }
        }


        showLoading(`Memuat rekapitulasi untuk periode ${selectedMonthYear}...`);
        if(rekapInfoBulanEl) rekapInfoBulanEl.textContent = selectedMonthYear;
        if(rekapTableTheadEl) rekapTableTheadEl.innerHTML = "";
        if(rekapTableTbodyEl) rekapTableTbodyEl.innerHTML = `<tr><td colspan="1" style="text-align:center; padding: 20px;">Memuat data rekapitulasi untuk ${selectedMonthYear}...</td></tr>`;

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                if (!response || !response.success) {
                    const errorMsg = response.error || "Gagal memuat data rekapitulasi dari server.";
                    showAlert(errorMsg, "error");
                    if(rekapTableTheadEl) rekapTableTheadEl.innerHTML = "";
                    if(rekapTableTbodyEl) rekapTableTbodyEl.innerHTML = `<tr><td colspan="1" style="color:red; text-align:center; padding: 20px;">${errorMsg}</td></tr>`;
                    activeRekapMonthYear = null; 
                    return;
                }

                if (response.message) {
                    if(rekapTableTheadEl) rekapTableTheadEl.innerHTML = `<tr><th style="text-align:center;">Informasi</th></tr>`;
                    if(rekapTableTbodyEl) rekapTableTbodyEl.innerHTML = `<tr><td style="text-align:center; padding: 20px;">${response.message}</td></tr>`;
                    activeRekapMonthYear = selectedMonthYear; 
                    return;
                }

                if (!response.daftarHeaderTanggal || response.daftarHeaderTanggal.length === 0) {
                    if(rekapTableTheadEl) rekapTableTheadEl.innerHTML = `<tr><th style="text-align:center;">Informasi</th></tr>`;
                    if(rekapTableTbodyEl) rekapTableTbodyEl.innerHTML = `<tr><td style="text-align:center; padding: 20px;">Tidak ada data tanggal untuk periode ${selectedMonthYear}.</td></tr>`;
                    activeRekapMonthYear = selectedMonthYear;
                    return;
                }

                activeRekapMonthYear = selectedMonthYear;

                let headerHtml = '<tr>';
                headerHtml += '<th rowspan="2" style="vertical-align: middle; text-align:center; min-width: 150px; position: -webkit-sticky; position: sticky; left: 0; z-index: 3; background-color: var(--primary); color: var(--white); border-right: 1px solid #ddd;">Nama Guru</th>';
                response.daftarHeaderTanggal.forEach(tglAngka => {
                    headerHtml += `<th class="rekap-tgl-header" style="text-align:center;">${tglAngka}</th>`;
                });
                headerHtml += '</tr>';
                headerHtml += '<tr>';
                response.daftarHeaderTanggal.forEach((tglAngka, index) => {
                    let namaHariUntukHeader = "";
                    if (response.daftarGuru && response.daftarGuru.length > 0 &&
                        response.daftarGuru[0].absensi && response.daftarGuru[0].absensi[index]) {
                      namaHariUntukHeader = response.daftarGuru[0].absensi[index].namaHari.substring(0,3);
                    }
                    headerHtml += `<th class="rekap-tgl-header-hari" style="text-align:center; font-size:0.8em; padding: 4px;">${namaHariUntukHeader || tglAngka}</th>`;
                });
                headerHtml += '</tr>';
                if(rekapTableTheadEl) rekapTableTheadEl.innerHTML = headerHtml;

                let tbodyHtml = '';
                if (response.daftarGuru && response.daftarGuru.length > 0) {
                    response.daftarGuru.forEach((guru, guruIndex) => {
                        let trMasukClass = guruIndex > 0 ? "pemisah-guru-atas" : "";
                        tbodyHtml += `<tr class="${trMasukClass}">`;
                        tbodyHtml += `<td rowspan="2" class="rekap-nama-guru" style="position: -webkit-sticky; position: sticky; left: 0; z-index: 2; background-color: var(--white); border-right: 1px solid #ddd;">${guru.nama}</td>`;
                        
                        guru.absensi.forEach(absen => {
                            const tooltipTanggal = `${absen.namaHari}, ${absen.tanggalFullStr || absen.tanggalFormatted}`;
                            const titleText = `Tgl: ${tooltipTanggal}${absen.keterangan ? ' - ' + absen.keterangan : ''}`;
                            tbodyHtml += `<td class="${absen.cssClass || ''}" title="${titleText}" data-label="M">${absen.jamMasuk}</td>`;
                        });
                        tbodyHtml += `</tr>`;
                        
                        let trPulangClass = "pemisah-guru-bawah";
                        tbodyHtml += `<tr class="${trPulangClass}">`;
                        guru.absensi.forEach(absen => {
                            const tooltipTanggal = `${absen.namaHari}, ${absen.tanggalFullStr || absen.tanggalFormatted}`;
                            const titleText = `Tgl: ${tooltipTanggal}${absen.keterangan ? ' - ' + absen.keterangan : ''}`;
                            tbodyHtml += `<td class="${absen.cssClass || ''}" title="${titleText}" data-label="P">${absen.jamPulang}</td>`;
                        });
                        tbodyHtml += `</tr>`;
                    });
                } else {
                    const colspanCount = (response.daftarHeaderTanggal ? response.daftarHeaderTanggal.length : 0) + 1;
                    tbodyHtml = `<tr><td colspan="${colspanCount}" style="text-align:center; padding: 20px;">Tidak ada data absensi guru untuk ditampilkan pada periode ${selectedMonthYear}.</td></tr>`;
                }
                if(rekapTableTbodyEl) rekapTableTbodyEl.innerHTML = tbodyHtml;

            })
            .withFailureHandler(err => {
                hideLoading();
                showAlert(`Error server saat memuat rekapitulasi: ${err.message}`, "error");
                if(rekapTableTheadEl) rekapTableTheadEl.innerHTML = "";
                if(rekapTableTbodyEl) rekapTableTbodyEl.innerHTML = `<tr><td colspan="1" style="color:red; text-align:center; padding: 20px;">Error server: ${err.message}</td></tr>`;
                activeRekapMonthYear = null; 
            })
            .getDynamicMonthlyRekap(selectedMonthYear);
    }

    // Di dalam file index.html, dalam blok <script>

    // Pastikan konstanta peran ini sudah didefinisikan secara global di skrip Anda
    // const ROLE_SUPERADMIN = "superadmin";
    // const ROLE_ADMIN = "admin";
    // const ROLE_USER = "user";

    function backToPreviousCeklokView() {
        if (!loggedInUser) { // Jika tidak ada sesi pengguna
            logout();
            return;
        }

        // Skenario utama: kembali dari halaman 'Hasil Ceklok' atau 'Kalender Pendidikan'
        // (Tambahkan 'tutorial' jika goBackFromTutorial() juga bisa memanggil ini atau memiliki logika serupa)
        if (currentView === 'hasil_ceklok' || currentView === 'kalender_pendidikan') {
            if (loggedInUser.role === ROLE_USER) {
                // Jika pengguna adalah GURU, kembali ke tampilan input cekloknya.
                const monthToLoad = activeCeklokMonthYear || globalServerCurrentMonthYear;
                if (loggedInUser.teacherName && monthToLoad) {
                    loadCeklokDataFromServer(loggedInUser.teacherName, monthToLoad, true); // true untuk isUserRoleView
                } else {
                    showAlert("Data guru atau periode tidak lengkap untuk kembali.", "warning");
                    logout(); // Fallback jika data penting tidak ada
                }
            } else if (loggedInUser.role === ROLE_ADMIN || loggedInUser.role === ROLE_SUPERADMIN) {
                // Jika pengguna adalah ADMIN atau SUPERADMIN:
                // Cek apakah ada konteks 'namaGuru' yang aktif (misalnya, admin/superadmin sedang melihat detail ceklok guru tertentu
                // sebelum pindah ke Hasil Ceklok atau Kalender).
                // Variabel global 'namaGuru' dan 'activeCeklokMonthYear' digunakan untuk ini.
                if (namaGuru && activeCeklokMonthYear) {
                    // Kembali ke tampilan input ceklok untuk guru yang sedang aktif dilihat (tampilan admin/superadmin)
                    loadCeklokDataFromServer(namaGuru, activeCeklokMonthYear, false); // false untuk isUserRoleView
                } else {
                    // Jika tidak ada konteks guru spesifik, kembali ke Dashboard Admin utama.
                    goBackToAdminDashboard();
                }
            } else {
                // Jika peran tidak dikenali (seharusnya tidak terjadi jika sudah login)
                logout();
            }
        }
        // Skenario fallback jika fungsi ini dipanggil dari view lain (kurang umum untuk fungsi bernama ini)
        else {
            if (loggedInUser.role === ROLE_ADMIN || loggedInUser.role === ROLE_SUPERADMIN) {
                goBackToAdminDashboard();
            } else if (loggedInUser.role === ROLE_USER) {
                const monthToLoad = activeCeklokMonthYear || globalServerCurrentMonthYear;
                if (loggedInUser.teacherName && monthToLoad) {
                    loadCeklokDataFromServer(loggedInUser.teacherName, monthToLoad, true);
                } else {
                    logout();
                }
            } else {
                logout();
            }
        }
    }
    
    function navigateToKalenderForm() { renderView('kalender_pendidikan'); }

    function setupKalenderPendidikanView() {
        loadAndDisplayKalenderEntries(); 
        window.scrollTo(0,0);
    }

    function loadAndDisplayKalenderEntries() {
        showLoading("Memuat entri kalender...");
        google.script.run
            .withSuccessHandler(response => { 
                hideLoading();
                const container = document.getElementById('existingKalenderEntriesTableBody'); 
                if (!container) return;
                if (response.error) { container.innerHTML = `<tr><td colspan="3" style="color:red;">Error: ${response.error}</td></tr>`; return; }
                
                const entries = response; 
                if (!entries || entries.length === 0) { container.innerHTML = `<tr><td colspan="3">Belum ada data di Kalender Pendidikan.</td></tr>`; return; }
                
                let tableHtml = '';
                entries.forEach(entry => {
                    tableHtml += `<tr>
                        <td data-label="Tanggal">${entry.date || '-'}</td>
                        <td data-label="Keterangan">${entry.description || '-'}</td>
                        <td data-label="Aksi" class="actions-cell"><button class="btn-danger" onclick="confirmDeleteKalenderEntry(${entry.sheetRow})">Hapus</button></td>
                    </tr>`;
                });
                container.innerHTML = tableHtml;
            })
            .withFailureHandler(err => {
                hideLoading();
                const container = document.getElementById('existingKalenderEntriesTableBody');
                if(container) container.innerHTML = `<tr><td colspan="3" style="color:red;">Gagal memuat Kalender: ${err.message}</td></tr>`;
            })
            .getKalenderPendidikanEntries();
    }

    function submitNewKalenderEntry() { 
        const dateInputEl = document.getElementById('kalenderDate');
        const descriptionEl = document.getElementById('kalenderDescription');
        clearInputError(dateInputEl, descriptionEl);

        const dateInputVal = dateInputEl.value; 
        const description = descriptionEl.value.trim();

        if (!dateInputVal) { showAlert("Tanggal wajib.", 'error'); showInputError(dateInputEl); return; } 
        if (!description) { showAlert("Keterangan wajib.", 'error'); showInputError(descriptionEl); return; } 

        const parts = dateInputVal.split('-'); 
        const formattedDate = `${parts[2]}/${parts[1]}/${parts[0]}`; 

        showLoading("Menyimpan entri kalender...");
        google.script.run
            .withSuccessHandler(response => { 
                hideLoading();
                showAlert(response.message || response.error, response.success ? 'success' : 'error');
                if (response.success) {
                    if(dateInputEl) dateInputEl.value = '';
                    if(descriptionEl) descriptionEl.value = '';
                    loadAndDisplayKalenderEntries(); 
                }
            })
            .withFailureHandler(err => { hideLoading(); showAlert(`Gagal menambah entri: ${err.message}`, 'error'); })
            .addKalenderPendidikanEntry(
                { date: formattedDate, description: description }, // entryData
                loggedInUser.username,                             // actingUserUsername
                loggedInUser.role                                  // actingUserRole
            );
    }

    function confirmDeleteKalenderEntry(sheetRow) {
        if (confirm("Yakin ingin menghapus entri Kalender ini?")) {
            showLoading("Menghapus entri...");
            google.script.run
                .withSuccessHandler(response => {
                    hideLoading();
                    showAlert(response.message || response.error, response.success ? 'success' : 'error');
                    if (response.success) loadAndDisplayKalenderEntries();
                })
                .withFailureHandler(err => { hideLoading(); showAlert(`Gagal menghapus: ${err.message}`, 'error'); })
                .deleteKalenderPendidikanEntry(sheetRow, loggedInUser.username, loggedInUser.role);
        }
    }
    
    function navigateToUserManagement() { renderView('user_management'); }

    // Modifikasi fungsi setupUserManagementView()
    function setupUserManagementView() {
        showLoading("Memuat data...");
        google.script.run
            .withSuccessHandler(teacherData => {
                allTeachersList = teacherData.success ? (teacherData.teachers || []) : [];
                if (!teacherData.success) showAlert(`Gagal memuat daftar guru untuk form: ${teacherData.error || "Error"}`, 'warning');

                google.script.run
                    .withSuccessHandler(userResponse => {
                        hideLoading();
                        if (userResponse.success) {
                            renderUserListTable(userResponse.users); // renderUserListTable akan diubah juga
                        } else {
                            const container = document.getElementById('userListTableContainer'); 
                            if(container) container.innerHTML = `<p style="color:red;">Error: ${userResponse.error}</p>`;
                            showAlert(userResponse.error, 'error');
                        }
                        // Mempopulasikan dropdown peran untuk form 'Tambah Pengguna Baru'
                        populateRoleDropdown('manageUserRole'); // Untuk form tambah baru
                        populateTeacherDropdownForUserForm(); 

                        // Set default role dan panggil toggleManageTeacherNameInput
                        const roleSelect = document.getElementById('manageUserRole');
                        if(roleSelect) {
                          // populateRoleDropdown sudah mengatur default value dan memanggil toggle
                        }
                        cancelEditUserForm(); // Ini akan memastikan form tambah user di-reset dengan benar
                    })
                    .withFailureHandler(err => { hideLoading(); showAlert(`Gagal memuat pengguna: ${err.message}`, 'error'); })
                    .getUsersForAdmin();
            })
            .withFailureHandler(err => { 
                hideLoading(); 
                allTeachersList = [];
                showAlert(`Gagal memuat daftar guru: ${err.message}`, 'error');
                google.script.run
                    .withSuccessHandler(userResponse => { /* ... */ })
                    .withFailureHandler(err => { /* ... */ })
                    .getUsersForAdmin(); // Tetap coba muat user meskipun guru gagal
            })
            .getTeachersForAdmin(); 
        window.scrollTo(0,0);
    }

    function populateTeacherDropdownForUserForm(selectedTeacher = "") {
        const dropdown = document.getElementById('manageUserActualTeacherNameDropdown'); 
        const textInput = document.getElementById('manageUserActualTeacherNameInput'); 
        if (!dropdown || !textInput) return;

        if (allTeachersList && allTeachersList.length > 0) {
            dropdown.style.display = 'block'; textInput.style.display = 'none';
            dropdown.innerHTML = '<option value="">-- Pilih Nama Guru --</option>';
            allTeachersList.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher; option.textContent = teacher;
                if (teacher === selectedTeacher) option.selected = true;
                dropdown.appendChild(option);
            });
            if(selectedTeacher) dropdown.value = selectedTeacher;

        } else {
            dropdown.style.display = 'none'; textInput.style.display = 'block';
            textInput.value = selectedTeacher;
        }
    }

    function toggleManageTeacherNameInput(role) { 
        const group = document.getElementById('manageUserTeacherNameGroup'); 
        const dropdown = document.getElementById('manageUserActualTeacherNameDropdown');
        const textInput = document.getElementById('manageUserActualTeacherNameInput');
        if (group) group.style.display = (role === 'user') ? 'block' : 'none';
        
        if (role === 'user' && (dropdown || textInput)) {
            const currentTeacher = dropdown && dropdown.style.display !== 'none' ? dropdown.value : (textInput ? textInput.value : '');
            populateTeacherDropdownForUserForm(currentTeacher);
        }
    }

    // Modifikasi fungsi renderUserListTable() di dalam <script> index.html
    function renderUserListTable(users) {
        const container = document.getElementById('userListTableBody');
        if (!container) {
            console.error("Elemen 'userListTableBody' tidak ditemukan.");
            return;
        }
        let tableHtml = '';
        if (users && users.length > 0) {
            users.forEach(user => {
                let canEdit = true;
                let canDelete = true;
                let actionsHtml = '';

                // Logika untuk menentukan apakah tombol Edit dan Delete harus ditampilkan/diaktifkan
                if (loggedInUser.role === ROLE_ADMIN) {
                    // Admin tidak bisa mengedit atau menghapus Superadmin
                    if (user.role === ROLE_SUPERADMIN) {
                        canEdit = false;
                        canDelete = false;
                    }
                }
                // Superadmin bisa mengedit dan menghapus semua (termasuk admin lain),
                // kecuali dirinya sendiri (untuk tombol delete)

                // Semua pengguna tidak bisa menghapus dirinya sendiri dari daftar ini
                if (loggedInUser.username === user.username) {
                    canDelete = false;
                    // Superadmin juga tidak bisa mengedit dirinya sendiri melalui form ini
                    // (misalnya mengubah role sendiri menjadi lebih rendah jika dia superadmin terakhir)
                    // Namun, mereka bisa mengubah password sendiri via menu profil.
                    // Untuk edit role via tabel ini, kita bisa nonaktifkan jika itu dirinya sendiri.
                    // if (user.role === ROLE_SUPERADMIN) { // Atau periksa jika username sama
                    //     canEdit = false;
                    // }
                }

                // Membuat HTML untuk tombol aksi
                if (canEdit) {
                    actionsHtml += `<button class="btn-warning" onclick="prepareEditUserForm('${user.username}', '${user.role}', '${user.teacherName || ''}')">Edit</button>`;
                }
                if (canDelete) {
                    // Tambahkan spasi jika tombol edit juga ada
                    if (actionsHtml !== '') actionsHtml += ' ';
                    actionsHtml += `<button class="btn-danger" onclick="confirmDeleteUser('${user.username}')">Hapus</button>`;
                }

                if (actionsHtml === '') {
                    actionsHtml = '<span style="font-size:0.85em; color: #777;">Tidak Ada Aksi</span>';
                }

                tableHtml += `<tr>
                    <td data-label="Username">${user.username}</td>
                    <td data-label="Role">${user.role}</td>
                    <td data-label="Nama Guru Asli">${user.teacherName || '-'}</td>
                    <td data-label="Aksi" class="actions-cell">
                        ${actionsHtml}
                    </td></tr>`;
            });
        } else {
            tableHtml += `<tr><td colspan="4" style="text-align:center; padding:15px;">Tidak ada pengguna terdaftar.</td></tr>`;
        }
        container.innerHTML = tableHtml;
    }

    // Modifikasi fungsi prepareEditUserForm()
    function prepareEditUserForm(username, role, teacherName) {
        const formTitle = document.getElementById('userFormTitle');
        const editKey = document.getElementById('editUsernameKey');
        const usernameInput = document.getElementById('manageUsernameInput');
        const passwordInput = document.getElementById('manageUserPasswordInput');
        // const roleSelect = document.getElementById('manageUserRole'); // Akan di-handle oleh populateRoleDropdown
        const teacherDropdown = document.getElementById('manageUserActualTeacherNameDropdown');
        const teacherTextInput = document.getElementById('manageUserActualTeacherNameInput');
        const saveBtn = document.getElementById('btnSaveUser');
        const cancelBtn = document.getElementById('btnCancelEditUser');

        if(formTitle) formTitle.textContent = 'Edit Pengguna: ' + username;
        if(editKey) editKey.value = username; 
        if(usernameInput) { usernameInput.value = username; usernameInput.readOnly = true; }
        if(passwordInput) { passwordInput.value = ''; passwordInput.placeholder = 'Kosongkan jika tidak ubah password'; }

        // Mempopulasikan dan mengatur dropdown peran untuk mode edit
        populateRoleDropdown('manageUserRole', role); // Kirim peran saat ini untuk diseleksi

        // toggleManageTeacherNameInput(role) akan dipanggil oleh populateRoleDropdown
        if (role === ROLE_USER) { // Menggunakan konstanta
            populateTeacherDropdownForUserForm(teacherName); // Panggil ini untuk mengisi nama guru jika dropdown
        } else {
            if (teacherDropdown) teacherDropdown.value = '';
            if (teacherTextInput) teacherTextInput.value = '';
        }

        if(saveBtn) saveBtn.textContent = 'Update Pengguna'; 
        if(cancelBtn) cancelBtn.style.display = 'inline-block'; 
        clearInlineError('userFormErrorGlobal'); 
        if(formTitle) window.scrollTo(0, formTitle.offsetTop - 20); // Scroll ke form
    }

    function cancelEditUserForm() { 
        const formTitle = document.getElementById('userFormTitle');
        const editKey = document.getElementById('editUsernameKey');
        const usernameInput = document.getElementById('manageUsernameInput');
        const passwordInput = document.getElementById('manageUserPasswordInput');
        const roleSelect = document.getElementById('manageUserRole');
        const teacherDropdown = document.getElementById('manageUserActualTeacherNameDropdown');
        const teacherTextInput = document.getElementById('manageUserActualTeacherNameInput');
        const saveBtn = document.getElementById('btnSaveUser');
        const cancelBtn = document.getElementById('btnCancelEditUser');


        if(formTitle) formTitle.textContent = 'Tambah Pengguna Baru';
        if(editKey) editKey.value = '';
        if(usernameInput) { usernameInput.value = ''; usernameInput.readOnly = false; }
        if(passwordInput) { passwordInput.value = ''; passwordInput.placeholder = 'Password baru/awal'; }
        if(roleSelect) roleSelect.value = 'user';
        
        if(teacherDropdown) teacherDropdown.value = '';
        if(teacherTextInput) teacherTextInput.value = '';

        if(roleSelect) toggleManageTeacherNameInput(roleSelect.value); // Pastikan konsisten dengan role default
        
        if(saveBtn) saveBtn.textContent = 'Simpan Pengguna';
        if(cancelBtn) cancelBtn.style.display = 'none';
        clearInlineError('userFormErrorGlobal');
    }

    // Modifikasi fungsi handleSaveUser()
    function handleSaveUser() { 
        const editUsernameKey = document.getElementById('editUsernameKey').value;
        const isEditMode = !!editUsernameKey;

        const usernameEl = document.getElementById('manageUsernameInput');
        const passwordEl = document.getElementById('manageUserPasswordInput');
        const roleEl = document.getElementById('manageUserRole');
        const teacherDropdownEl = document.getElementById('manageUserActualTeacherNameDropdown');
        const teacherInputEl = document.getElementById('manageUserActualTeacherNameInput');
        const errorContainerId = 'userFormErrorGlobal';
        clearInlineError(errorContainerId);
        clearInputError(usernameEl, passwordEl, roleEl, teacherDropdownEl, teacherInputEl);

        const username = usernameEl.value.trim();
        const password = passwordEl.value; 
        const role = roleEl.value;
        let teacherName = "";
        if (role === ROLE_USER) { // Menggunakan konstanta
            teacherName = (teacherDropdownEl && teacherDropdownEl.style.display !== 'none' && teacherDropdownEl.value) 
                          ? teacherDropdownEl.value 
                          : teacherInputEl.value.trim();
        }

        if (!username) { showInlineError(errorContainerId, "Username wajib."); showInputError(usernameEl); return; }
        if (!isEditMode && !password) { showInlineError(errorContainerId, "Password wajib untuk user baru."); showInputError(passwordEl);return; }
        if (password && password.length < 4 && (isEditMode && password || !isEditMode) ) { 
            showInlineError(errorContainerId, "Password minimal 4 karakter."); showInputError(passwordEl); return;
        }
        if (!role) { // Validasi tambahan jika dropdown role bisa kosong (seharusnya tidak dengan implementasi populate)
            showInlineError(errorContainerId, "Peran pengguna wajib dipilih."); showInputError(roleEl); return;
        }
        if (role === ROLE_USER && !teacherName) { // Menggunakan konstanta
            showInlineError(errorContainerId, "Nama Guru Asli wajib untuk role 'user'.");
            if(teacherDropdownEl && teacherDropdownEl.style.display !== 'none') showInputError(teacherDropdownEl); else showInputError(teacherInputEl);
            return;
        }

        showLoading(isEditMode ? "Memperbarui..." : "Menambahkan...");
        const actingUserRole = loggedInUser.role; // Ambil peran pengguna yang login
        const actingUsername = loggedInUser.username;
        const actingRole = loggedInUser.role;
        
        if (isEditMode) {
            const userDataToUpdate = { newRole: role, newTeacherName: teacherName };
            if (password) userDataToUpdate.newPassword = password; 
            google.script.run.withSuccessHandler(response => {
                hideLoading(); showAlert(response.message || response.error, response.success ? 'success' : 'error');
                if (response.success) { cancelEditUserForm(); setupUserManagementView();  }
            }).withFailureHandler(err => { hideLoading(); showAlert(`Update gagal: ${err.message}`, 'error'); })
            .updateUserByUsername(editUsernameKey, userDataToUpdate, actingUsername, actingUserRole); // Kirim actingUserRole
        } else {
            const newUser = { username, password, role, teacherName };
            google.script.run.withSuccessHandler(response => {
                hideLoading(); showAlert(response.message || response.error, response.success ? 'success' : 'error');
                if (response.success) { cancelEditUserForm(); setupUserManagementView();  }
            }).withFailureHandler(err => { hideLoading(); showAlert(`Tambah gagal: ${err.message}`, 'error'); })
            .addNewUser(newUser, actingUsername, actingUserRole); // Kirim actingUserRole
        }
    }

    // Modifikasi fungsi confirmDeleteUser()
    function confirmDeleteUser(username) {
        if (username === loggedInUser.username) { showAlert("Tidak bisa menghapus akun sendiri.", 'error'); return; }
        if (confirm(`Yakin hapus pengguna '${username}'?`)) {
            showLoading("Menghapus pengguna...");
            const actingUsername = loggedInUser.username;
            const actingUserRole = loggedInUser.role; // Ambil peran pengguna yang login
            google.script.run.withSuccessHandler(response => {
                hideLoading(); showAlert(response.message || response.error, response.success ? 'success' : 'error');
                if (response.success) setupUserManagementView(); 
            }).withFailureHandler(err => { hideLoading(); showAlert(`Hapus gagal: ${err.message}`, 'error'); })
            .deleteUserByUsername(username, actingUsername, actingUserRole); // Kirim actingUserRole
        }
    }

    function navigateToTeacherManagement() { renderView('teacher_management'); }

    function setupTeacherManagementView() {
        showLoading("Memuat data guru...");
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                if (response.success) {
                    allTeachersList = response.teachers || [];
                    renderTeacherListTable(allTeachersList);
                } else {
                    const container = document.getElementById('teacherListTableContainer'); 
                    if(container) container.innerHTML = `<p style="color:red;">Error: ${response.error}</p>`;
                    showAlert(response.error, 'error');
                }
                cancelEditTeacherForm(); 
            })
            .withFailureHandler(err => { hideLoading(); showAlert(`Gagal memuat guru: ${err.message}`, 'error'); })
            .getTeachersForAdmin();
        window.scrollTo(0,0);
    }

    function renderTeacherListTable(teachers) {
        const container = document.getElementById('teacherListTableBody'); 
        if (!container) return;
        let tableHtml = '';
        if (teachers && teachers.length > 0) {
            teachers.forEach(teacher => {
                tableHtml += `<tr>
                    <td data-label="Nama Guru">${teacher}</td>
                    <td data-label="Aksi" class="actions-cell">
                        <button class="btn-warning" onclick="prepareEditTeacherForm('${teacher}')">Edit</button>
                        <button class="btn-danger" onclick="confirmDeleteTeacher('${teacher}')">Hapus</button>
                    </td></tr>`;
            });
        } else {
            tableHtml += `<tr><td colspan="2">Belum ada nama guru.</td></tr>`;
        }
        container.innerHTML = tableHtml;
    }

    function prepareEditTeacherForm(teacherName) {
        const formTitle = document.getElementById('teacherFormTitle');
        const editKey = document.getElementById('editTeacherNameKey');
        const nameInput = document.getElementById('manageTeacherNameInput');
        const saveBtn = document.getElementById('btnSaveTeacher');
        const cancelBtn = document.getElementById('btnCancelEditTeacher');

        if(formTitle) formTitle.textContent = 'Edit Nama Guru'; 
        if(editKey) editKey.value = teacherName;
        if(nameInput) nameInput.value = teacherName; 
        if(saveBtn) saveBtn.textContent = 'Update Nama Guru'; 
        if(cancelBtn) cancelBtn.style.display = 'inline-block'; 
        clearInlineError('teacherFormErrorGlobal'); 
        if(formTitle) window.scrollTo(0, formTitle.offsetTop);
    }

    function cancelEditTeacherForm() { 
        const formTitle = document.getElementById('teacherFormTitle');
        const editKey = document.getElementById('editTeacherNameKey');
        const nameInput = document.getElementById('manageTeacherNameInput');
        const saveBtn = document.getElementById('btnSaveTeacher');
        const cancelBtn = document.getElementById('btnCancelEditTeacher');

        if(formTitle) formTitle.textContent = 'Tambah Nama Guru Baru';
        if(editKey) editKey.value = '';
        if(nameInput) nameInput.value = '';
        if(saveBtn) saveBtn.textContent = 'Simpan Nama Guru';
        if(cancelBtn) cancelBtn.style.display = 'none';
        clearInlineError('teacherFormErrorGlobal');
    }

    function handleSaveTeacher() { 
        const editTeacherNameKey = document.getElementById('editTeacherNameKey').value;
        const isEditMode = !!editTeacherNameKey;
        const teacherNameEl = document.getElementById('manageTeacherNameInput');
        const teacherName = teacherNameEl.value.trim();
        const errorContainerId = 'teacherFormErrorGlobal';
        clearInlineError(errorContainerId); clearInputError(teacherNameEl);

        if (!teacherName) { showInlineError(errorContainerId, "Nama guru wajib."); showInputError(teacherNameEl); return; }

        showLoading(isEditMode ? "Memperbarui..." : "Menambahkan...");
        if (isEditMode) {
            if (editTeacherNameKey === teacherName) { hideLoading(); showInlineError(errorContainerId, "Nama baru sama dengan nama lama."); return; }
            google.script.run.withSuccessHandler(response => {
                hideLoading(); showAlert(response.message || response.error, response.success ? 'success' : 'error');
                if (response.success) { cancelEditTeacherForm(); setupTeacherManagementView();  }
            }).withFailureHandler(err => { hideLoading(); showAlert(`Update gagal: ${err.message}`, 'error'); })
            .updateTeacherByName(editTeacherNameKey, teacherName);
        } else {
            google.script.run.withSuccessHandler(response => {
                hideLoading(); showAlert(response.message || response.error, response.success ? 'success' : 'error');
                if (response.success) { cancelEditTeacherForm(); setupTeacherManagementView();  }
            }).withFailureHandler(err => { hideLoading(); showAlert(`Tambah gagal: ${err.message}`, 'error'); })
            .addNewTeacher(teacherName);
        }
    }

    function confirmDeleteTeacher(teacherName) {
        if (confirm(`Yakin hapus nama guru '${teacherName}'? Ini juga bisa mempengaruhi akun user yang terhubung.`)) {
            showLoading("Menghapus nama guru...");
            google.script.run.withSuccessHandler(response => {
                hideLoading(); showAlert(response.message || response.error, response.success ? 'success' : 'error');
                if (response.success) setupTeacherManagementView(); 
            }).withFailureHandler(err => { hideLoading(); showAlert(`Hapus gagal: ${err.message}`, 'error'); })
            .deleteTeacherByName(teacherName);
        }
    }

    function updateFooterYear() {
        const yearEl = document.getElementById('currentYear');
        if (yearEl) yearEl.textContent = new Date().getFullYear();
    }

    window.onload = function() {
        console.log("Page loaded. Checking for existing session...");
        const appDiv = document.getElementById('app');
        if(appDiv) appDiv.innerHTML = ''; // Kosongkan app div
        updateFooterYear();
        setupModalEventListeners(); 
        closeProfileDropdownOnClickOutside(); // Tambahkan ini
        closeProfileDropdownOnEscape();  // Tambahkan ini

        const storedUserData = sessionStorage.getItem('loggedInUserData');
        if (storedUserData) {
            console.log("Found user data in sessionStorage.");
            try {
                loggedInUser = JSON.parse(storedUserData);
                if (loggedInUser && loggedInUser.username && loggedInUser.role) {
                    console.log("User data parsed successfully. Proceeding...");
                    document.body.classList.remove('login-active'); // Hapus kelas login-active dari body
                    proceedAfterLogin(); 
                } else {
                    console.warn("Stored user data is invalid. Clearing session.");
                    sessionStorage.removeItem('loggedInUserData');
                    document.body.classList.add('login-active'); // Tambahkan kelas login-active ke body
                    renderView('login');
                }
            } catch (e) {
                console.error("Failed to parse stored user data:", e);
                sessionStorage.removeItem('loggedInUserData');
                document.body.classList.add('login-active'); 
                renderView('login');
            }
        } else {
            console.log("No user data in sessionStorage. Rendering login view.");
            document.body.classList.add('login-active'); 
            renderView('login');
        }
    };

    function setupLockIdAndExportClientFeatures() {
        const lockIdInput = document.getElementById('lockIdInput');
        const btnSimpanLockId = document.getElementById('btnSimpanLockIdClient');
        const btnExportExcel = document.getElementById('btnExportExcelClient');
        const lockIdStatusMsg = document.getElementById('lockIdStatusMessage');

        if (lockIdInput) {
            lockIdInput.addEventListener('input', function() {
                if (btnExportExcel) {
                    btnExportExcel.disabled = true;
                    btnExportExcel.classList.remove('btn-ready-export');
                    btnExportExcel.classList.add('btn-greyed-out');
                }
                if (lockIdStatusMsg) lockIdStatusMsg.textContent = '';
                currentLockIdValue = null; 
                currentBackupSheetName = null;
            });
        }
    }

    function handleSimpanLockIdClientSite() {
        const lockIdInputEl = document.getElementById('lockIdInput');
        const btnExportExcel = document.getElementById('btnExportExcelClient');
        const lockIdStatusMsg = document.getElementById('lockIdStatusMessage');

        if (!lockIdInputEl || !btnExportExcel || !lockIdStatusMsg) {
            showAlert("Komponen UI untuk LOCK_ID tidak ditemukan pada halaman. Coba muat ulang.", "error");
            return;
        }

        const lockIdValue = lockIdInputEl.value.trim();
        if (!lockIdValue) {
            showAlert("LOCK_ID tidak boleh kosong.", "error");
            lockIdInputEl.focus();
            return;
        }
        if (isNaN(parseInt(lockIdValue))) {
            showAlert("LOCK_ID harus berupa angka.", "error");
            lockIdInputEl.focus();
            return;
        }

        if (!namaGuru) {
            showAlert("Nama guru belum dipilih atau tidak valid. Silakan pilih guru terlebih dahulu.", "error");
            return;
        }
        if (!activeCeklokMonthYear) {
            showAlert("Periode bulan dan tahun belum aktif. Silakan muat data ceklok untuk periode yang diinginkan terlebih dahulu.", "error");
            return;
        }
        if (!dataTanggal || dataTanggal.length === 0) {
            showAlert("Tidak ada data ceklok yang dimuat untuk periode saat ini (" + activeCeklokMonthYear + "). Silakan muat data terlebih dahulu sebelum menyimpan LOCK_ID.", "warning");
            return;
        }
        const currentCeklokDataForBackup = dataTanggal.map((row, i) => {
            let jamMasukVal = '';
            let jamPulangVal = '';
            let ketValForBackup = ''; 

            if (row.isLibur) { 
                jamMasukVal = "";
                jamPulangVal = "";
                ketValForBackup = row.keteranganLiburManual || ""; 
            } else { 
                const jamMasukEl = document.getElementById(`jamMasuk${i}`);
                const jamPulangEl = document.getElementById(`jamPulang${i}`);
                const ketLiburManualEl = document.getElementById(`ketLiburManual${i}`); 

                jamMasukVal = jamMasukEl ? jamMasukEl.value.trim() : '';
                jamPulangVal = jamPulangEl ? jamPulangEl.value.trim() : '';
                ketValForBackup = ketLiburManualEl ? ketLiburManualEl.value : ''; 
                if (ketValForBackup && ketValForBackup !== "") {
                    jamMasukVal = "";
                    jamPulangVal = "";
                }
            }

            return {
                tanggal: row.tanggal, 
                hari: row.hari,
                jamMasuk: jamMasukVal,
                jamPulang: jamPulangVal,
                keteranganLiburManual: ketValForBackup 
            };
        });

        // --- PERUBAHAN DI SINI ---
        // Pesan loading diubah untuk mencakup kedua proses
        showLoading("Menyimpan LOCK_ID & Menyiapkan Unduhan...");
        google.script.run
            .withSuccessHandler(response => {
                // JANGAN panggil hideLoading() di sini. Biarkan loading screen tetap aktif
                // sampai proses unduh selesai atau gagal.

                if (response.success) {
                    // Simpan variabel global yang diperlukan untuk proses unduh
                    currentLockIdValue = lockIdValue; 
                    currentBackupSheetName = response.backupSheetName; 

                    // Perbarui UI seperti biasa, tapi dengan pesan yang sedikit berbeda
                    showAlert(response.message || "LOCK_ID berhasil disimpan. Memulai unduhan otomatis...", "info", 4000);
                    lockIdStatusMsg.textContent = `LOCK_ID '${lockIdValue}' aktif untuk periode ${activeCeklokMonthYear}. Sheet cadangan: ${response.backupSheetName}. Siap export.`;
                    lockIdStatusMsg.style.color = "green";
                    
                    // Tetap aktifkan tombol unduh manual untuk fallback
                    btnExportExcel.disabled = false;
                    btnExportExcel.classList.remove('btn-greyed-out');
                    btnExportExcel.classList.add('btn-ready-export');
                    
                    // --- INI BAGIAN UTAMA PERUBAHANNYA ---
                    // Langsung panggil fungsi unduh setelah berhasil menyimpan LOCK_ID
                    // Kita beri flag 'true' untuk menandakan ini adalah unduhan otomatis
                    handleExportExcelClientSite(true); 

                } else {
                    hideLoading(); // Sembunyikan loading JIKA penyimpanan gagal
                    showAlert(response.error || "Gagal menyimpan LOCK_ID.", "error");
                    lockIdStatusMsg.textContent = response.error || "Gagal memproses.";
                    lockIdStatusMsg.style.color = "red";
                    btnExportExcel.disabled = true;
                    btnExportExcel.classList.add('btn-greyed-out');
                    btnExportExcel.classList.remove('btn-ready-export');
                }
            })
            .withFailureHandler(err => {
                hideLoading(); // Sembunyikan loading jika ada error server
                showAlert(`Error server saat menyimpan LOCK_ID: ${err.message}`, "error");
                lockIdStatusMsg.textContent = `Error server: ${err.message}`;
                lockIdStatusMsg.style.color = "red";
                btnExportExcel.disabled = true;
                btnExportExcel.classList.add('btn-greyed-out');
                btnExportExcel.classList.remove('btn-ready-export');
            })
            .saveLockIdAndPrepareBackupSheet(namaGuru, activeCeklokMonthYear, lockIdValue, currentCeklokDataForBackup);
    }

    // --- PERUBAHAN DI SINI ---
    // Tambahkan parameter isAutoDownload dengan nilai default false
    function handleExportExcelClientSite(isAutoDownload = false) {
        const btnExportExcel = document.getElementById('btnExportExcelClient');
        const lockIdInputEl = document.getElementById('lockIdInput');
        const lockIdStatusMsg = document.getElementById('lockIdStatusMessage');

        if (!btnExportExcel || !lockIdInputEl || !lockIdStatusMsg) {
            showAlert("Komponen UI untuk export tidak ditemukan pada halaman. Coba muat ulang.", "error");
            return;
        }

        if (!currentBackupSheetName || !currentLockIdValue) {
            showAlert("LOCK_ID belum disimpan atau sheet cadangan belum siap. Klik 'Simpan LOCK_ID' dahulu.", "error");
            return;
        }
        if (!namaGuru) {
            showAlert("Nama guru belum dipilih atau tidak valid.", "error");
            return;
        }
        if (!activeCeklokMonthYear) {
            showAlert("Periode bulan dan tahun aktif tidak ditemukan. Silakan muat data ceklok terlebih dahulu.", "error");
            return;
        }

        if (btnExportExcel.disabled) {
            showAlert("Tombol export belum aktif. Pastikan LOCK_ID sudah disimpan dengan benar.", "warning");
            return;
        }

        // --- PERUBAHAN DI SINI ---
        // Hanya tampilkan loading jika fungsi ini dipanggil secara manual (bukan otomatis)
        if (!isAutoDownload) {
            showLoading("File sedang diekspor, silahkan tunggu...");
        }

        google.script.run
            .withSuccessHandler(response => {
                hideLoading(); // Sembunyikan loading screen yang sudah ada
                if (response.success && response.base64Data && response.fileName && response.mimeType) {
                    triggerClientSideDownload(response.base64Data, response.fileName, response.mimeType);
                    showAlert("Export Excel berhasil dimulai. File: " + response.fileName, "success", 5000); 
                    
                    lockIdInputEl.value = ''; 
                    lockIdStatusMsg.textContent = "Export selesai. Sheet cadangan akan segera dihapus oleh server.";
                    lockIdStatusMsg.style.color = "var(--grey-text)"; 
                    
                    // Jangan disable tombol unduh manual lagi, biarkan aktif
                    // btnExportExcel.disabled = true;
                    // btnExportExcel.classList.remove('btn-ready-export');
                    // btnExportExcel.classList.add('btn-greyed-out');
                    
                    // currentLockIdValue = null; 
                    // currentBackupSheetName = null; 
                } else {
                    showAlert(response.error || "Gagal mengekspor data.", "error");
                    lockIdStatusMsg.textContent = response.error || "Gagal mengekspor.";
                    lockIdStatusMsg.style.color = "red";
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showAlert(`Error server saat export: ${err.message}`, "error");
                if (lockIdStatusMsg) { 
                    lockIdStatusMsg.textContent = `Error server export: ${err.message}`;
                    lockIdStatusMsg.style.color = "red";
                }
            })
            .exportBackupSheetToExcel(currentBackupSheetName, namaGuru, activeCeklokMonthYear, currentLockIdValue);
    }

    function triggerClientSideDownload(base64Data, fileName, mimeType) {
      try {
        const byteCharacters = atob(base64Data);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: mimeType });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
      } catch (e) {
        console.error("Error saat memicu unduhan di browser:", e);
        showAlert("Gagal memulai unduhan di browser. Periksa konsol untuk detail.", "error");
      }
    }

    function openChangePasswordModal() {
        clearInlineError('changePasswordError');
        const currentPassEl = document.getElementById('currentPassword');
        const newPassEl = document.getElementById('newPassword');
        const confirmPassEl = document.getElementById('confirmNewPassword');
        if(currentPassEl) currentPassEl.value = '';
        if(newPassEl) newPassEl.value = '';
        if(confirmPassEl) confirmPassEl.value = '';
        const modal = document.getElementById('changePasswordModal');
        if(modal) modal.style.display = 'block';
        initializeAllPasswordToggles(); // Inisialisasi toggle untuk modal ini
    }

    function closeChangePasswordModal() {
        const modal = document.getElementById('changePasswordModal');
        if(modal) modal.style.display = 'none';
    }

    function submitChangePassword() {
        const currentPasswordEl = document.getElementById('currentPassword');
        const newPasswordEl = document.getElementById('newPassword');
        const confirmNewPasswordEl = document.getElementById('confirmNewPassword');
        const errorContainerId = 'changePasswordError';

        clearInlineError(errorContainerId);
        clearInputError(currentPasswordEl, newPasswordEl, confirmNewPasswordEl);

        const currentPassword = currentPasswordEl.value;
        const newPassword = newPasswordEl.value;
        const confirmNewPassword = confirmNewPasswordEl.value;

        if (!currentPassword) {
            showInlineError(errorContainerId, "Password lama wajib diisi.");
            showInputError(currentPasswordEl);
            return;
        }
        if (!newPassword) {
            showInlineError(errorContainerId, "Password baru wajib diisi.");
            showInputError(newPasswordEl);
            return;
        }
        if (newPassword.length < 4) {
            showInlineError(errorContainerId, "Password baru minimal 4 karakter.");
            showInputError(newPasswordEl);
            return;
        }
        if (newPassword !== confirmNewPassword) {
            showInlineError(errorContainerId, "Konfirmasi password baru tidak cocok.");
            showInputError(confirmNewPasswordEl);
            return;
        }

        if (!loggedInUser || !loggedInUser.username) {
            showAlert("Error: Informasi pengguna tidak ditemukan. Silakan login ulang.", "error");
            return;
        }

        showLoading("Mengubah password...");
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                if (response.success) {
                    showAlert(response.message, 'success');
                    closeChangePasswordModal();
                } else {
                    showInlineError(errorContainerId, response.error || "Gagal mengubah password.");
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showInlineError(errorContainerId, `Error server: ${err.message}`);
            })
            .changeUserPassword(loggedInUser.username, currentPassword, newPassword);
    }

    function handleGoogleLoginAttempt() {
        const loginErrorEl = document.getElementById('loginError');
        if (loginErrorEl) loginErrorEl.style.display = "none"; 

        showLoading("Mencoba login dengan Google...");
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                if (response.success) {
                    loggedInUser = { username: response.username, role: response.role, teacherName: response.teacherName, googleEmail: response.googleEmail, primaryEmail: response.primaryEmail }; 
                    try {
                        sessionStorage.setItem('loggedInUserData', JSON.stringify(loggedInUser));
                    } catch (e) {
                        console.error("Gagal menyimpan sesi login Google di browser:", e);
                    }
                    document.body.classList.remove('login-active');
                    proceedAfterLogin(); 
                } else {
                    if (loginErrorEl) {
                        loginErrorEl.textContent = response.error || "Login dengan Google gagal.";
                        loginErrorEl.style.display = "block";
                    } else {
                        showAlert(response.error || "Login dengan Google gagal.", "error");
                    }
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                if (loginErrorEl) {
                    loginErrorEl.textContent = "Error server saat login Google: " + err.message;
                    loginErrorEl.style.display = "block";
                } else {
                    showAlert("Error server saat login Google: " + err.message, "error");
                }
            })
            .loginViaLinkedGoogleAccount(); 
    }
    
    function populateYearSelect(selectElementId, minYear, maxYear, defaultSelectedYear) {
      const yearSelect = document.getElementById(selectElementId);
      if (!yearSelect) {
          console.error("Element select tahun tidak ditemukan:", selectElementId);
          return;
      }

      yearSelect.innerHTML = ''; 

        minYear = parseInt(minYear);
        maxYear = parseInt(maxYear);
        defaultSelectedYear = parseInt(defaultSelectedYear);

      if (isNaN(minYear) || isNaN(maxYear)) {
          console.error("minYear atau maxYear bukan angka yang valid untuk populateYearSelect");
          const currentY = new Date().getFullYear();
          minYear = isNaN(minYear) ? currentY : minYear;
          maxYear = isNaN(maxYear) ? currentY : maxYear;
          if (minYear > maxYear) maxYear = minYear; 
      }


      if (minYear > maxYear) {
            console.warn(`populateYearSelect: minYear (${minYear}) is greater than maxYear (${maxYear}). Defaulting to maxYear only.`);
            maxYear = minYear; 
      }

      for (let year = maxYear; year >= minYear; year--) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          if (year === defaultSelectedYear) {
              option.selected = true;
          }
          yearSelect.appendChild(option);
      }
      if (yearSelect.options.length > 0 && !yearSelect.value && defaultSelectedYear) {
            yearSelect.value = defaultSelectedYear; 
            if(!yearSelect.value) yearSelect.value = yearSelect.options[0].value; 
      } else if (yearSelect.options.length > 0 && !yearSelect.value) {
            yearSelect.value = yearSelect.options[0].value;
      }
    }

    function getYearFromMMYYYY(mm_yyyy_string) {
      if (!mm_yyyy_string || !mm_yyyy_string.includes('/')) {
          // console.warn("Format mm_yyyy_string salah di getYearFromMMYYYY, mengembalikan tahun ini.");
          return new Date().getFullYear();
      }
      const parts = mm_yyyy_string.split('/');
      if (parts.length === 2 && !isNaN(parseInt(parts[1], 10))) {
          return parseInt(parts[1], 10);
      }
      return new Date().getFullYear();
    }

    function getMonthStrFromMMYYYY(mm_yyyy_string) {
        if (!mm_yyyy_string || !mm_yyyy_string.includes('/')) {
            // console.warn("Format mm_yyyy_string salah di getMonthStrFromMMYYYY, mengembalikan bulan ini.");
            return String(new Date().getMonth() + 1).padStart(2, '0');
        }
        const parts = mm_yyyy_string.split('/');
        if (parts.length === 2 && parts[0].length === 2 && !isNaN(parseInt(parts[0],10))) {
             return parts[0];
        }
        return String(new Date().getMonth() + 1).padStart(2, '0');
    }

    function validateMonthRange(bulanSelectId, tahunSelectId) {
            const bulanSelect = document.getElementById(bulanSelectId);
            const tahunSelect = document.getElementById(tahunSelectId);

            if (!bulanSelect || !tahunSelect || !globalAdminMinMonthYear || !globalServerCurrentMonthYear) {
                // console.warn("validateMonthRange: Elemen atau variabel global tidak siap.");
                return;
            }

            const selectedYear = parseInt(tahunSelect.value);
            // Ambil nilai bulan yang sedang terpilih SEBELUM kita memodifikasi opsi
            const previouslySelectedMonthValue = bulanSelect.value;

            const minDefinedYear = getYearFromMMYYYY(globalAdminMinMonthYear);
            const minDefinedMonth = parseInt(getMonthStrFromMMYYYY(globalAdminMinMonthYear));
            const maxDefinedYear = getYearFromMMYYYY(globalServerCurrentMonthYear);
            const maxDefinedMonth = parseInt(getMonthStrFromMMYYYY(globalServerCurrentMonthYear));

            let firstVisibleAndValidMonthValue = null; // Untuk menyimpan value bulan pertama yang valid dan terlihat
            let isPreviouslySelectedMonthNowHidden = false;

            for (let i = 0; i < bulanSelect.options.length; i++) {
                const option = bulanSelect.options[i];
                const monthOptionValue = parseInt(option.value);
                let hideOption = false;

                if (selectedYear < minDefinedYear || selectedYear > maxDefinedYear) {
                    hideOption = true;
                } else {
                    if (selectedYear === minDefinedYear && monthOptionValue < minDefinedMonth) {
                        hideOption = true;
                    }
                    if (selectedYear === maxDefinedYear && monthOptionValue > maxDefinedMonth) {
                        hideOption = true;
                    }
                }
                
                option.style.display = hideOption ? 'none' : ''; // Sembunyikan atau tampilkan

                if (!hideOption && firstVisibleAndValidMonthValue === null) {
                    firstVisibleAndValidMonthValue = option.value; // Catat bulan pertama yang terlihat dan valid
                }

                // Cek apakah opsi yang sebelumnya terpilih kini disembunyikan
                if (option.value === previouslySelectedMonthValue && hideOption) {
                    isPreviouslySelectedMonthNowHidden = true;
                }
            }

            // Jika bulan yang sebelumnya terpilih sekarang disembunyikan,
            // atau jika tidak ada bulan yang terpilih (misalnya saat load pertama kali dan defaultnya tersembunyi),
            // pilih bulan pertama yang terlihat dan valid.
            if (isPreviouslySelectedMonthNowHidden || !bulanSelect.value || bulanSelect.options[bulanSelect.selectedIndex]?.style.display === 'none') {
                if (firstVisibleAndValidMonthValue) {
                    bulanSelect.value = firstVisibleAndValidMonthValue;
                } else {
                    // Kasus langka: tidak ada bulan yang valid untuk tahun yang dipilih.
                    // Ini seharusnya tidak terjadi jika rentang tahun juga divalidasi dengan benar.
                    // Anda bisa mengatur default atau membiarkannya kosong, tergantung preferensi.
                    // Untuk saat ini, jika tidak ada yang valid, biarkan seperti itu (dropdown mungkin kosong).
                    console.warn("Tidak ada bulan yang valid untuk tahun yang dipilih:", selectedYear, "pada dropdown:", bulanSelectId);
                    // Jika Anda ingin selalu ada nilai, Anda bisa set ke "" atau handle berbeda
                    // bulanSelect.value = ""; // Contoh jika ingin dikosongkan
                }
            }
    }


    function handlePrintRekap() {
        if (!activeRekapMonthYear) { 
            showAlert("Tidak ada data rekap yang sedang ditampilkan untuk dicetak. Silahkan tunggu data rekap dimuat.", "warning");
            return;
        }
        const periodeCetak = activeRekapMonthYear; 

        showLoading("Menyiapkan data untuk dicetak...");
        google.script.run
            .withSuccessHandler(responseGenerate => {
                if (responseGenerate.success) {
                    showAlert(responseGenerate.message || "Sheet sementara disiapkan, mengunduh PDF...", "info", 2000);
                    google.script.run
                        .withSuccessHandler(responseDownload => {
                            hideLoading();
                            if (responseDownload.success && responseDownload.downloadUrl) {
                                window.open(responseDownload.downloadUrl, '_blank');
                                showAlert(`PDF "${responseDownload.fileName}" berhasil dibuat dan proses unduh dimulai. Sheet sementara akan dihapus.`, "success", 7000); 
                            } else {
                                showAlert(responseDownload.error || "Gagal mengunduh PDF.", "error");
                            }
                        })
                        .withFailureHandler(errDownload => {
                            hideLoading();
                            showAlert(`Error server saat mengunduh PDF: ${errDownload.message}`, "error");
                        })
                        .downloadSheetAsPDF(responseGenerate.sheetId, responseGenerate.lastDataRow, responseGenerate.lastDataCol);
                } else {
                    hideLoading();
                    showAlert(responseGenerate.error || "Gagal menyiapkan data cetak.", "error");
                }
            })
            .withFailureHandler(errGenerate => {
                hideLoading();
                showAlert(`Error server saat menyiapkan data cetak: ${errGenerate.message}`, "error");
            })
            .generatePrintableSheet(periodeCetak); 
    }

    function isValidEmail(email) {
        if (!email) return false;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(String(email).toLowerCase());
    }

    function openPrimaryEmailModal() {
        const modal = document.getElementById('primaryEmailModal');
        if (modal) modal.style.display = 'flex';
        showPrimaryEmailStep1(); // Selalu mulai dari tahap 1
    }

    function closePrimaryEmailModal() {
        const modal = document.getElementById('primaryEmailModal');
        if (modal) modal.style.display = 'none';
        emailForPrimaryVerification = null; // Reset email yang diverifikasi
        if (primaryEmailOtpTimerInterval) {
            clearInterval(primaryEmailOtpTimerInterval);
            primaryEmailOtpTimerInterval = null;
        }
        // Reset juga input dan error jika ada
        const emailInput = document.getElementById('primaryEmailInput');
        const otpInput = document.getElementById('primaryEmailOtpInput');
        const errorStep1 = document.getElementById('primaryEmailStep1Error');
        const errorStep2 = document.getElementById('primaryEmailStep2Error');
        if(emailInput) emailInput.value = '';
        if(otpInput) otpInput.value = '';
        if(errorStep1) errorStep1.style.display = 'none';
        if(errorStep2) errorStep2.style.display = 'none';
    }

    function handleRequestPrimaryEmailOTP() {
        const emailInput = document.getElementById('primaryEmailInput');
        const errorDiv = document.getElementById('primaryEmailStep1Error');
        const requestButton = document.getElementById('btnRequestPrimaryEmailOTP');

        if (!emailInput || !errorDiv || !requestButton) {
            showAlert("Komponen modal email (tahap 1) tidak ditemukan.", "error");
            return;
        }

        const email = emailInput.value.trim().toLowerCase();
        clearInputError(emailInput);
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';

        if (!email) {
            errorDiv.textContent = "Email tidak boleh kosong.";
            errorDiv.style.display = 'block';
            showInputError(emailInput);
            return;
        }

        if (!isValidEmail(email)) {
            errorDiv.textContent = "Format email tidak valid.";
            errorDiv.style.display = 'block';
            showInputError(emailInput);
            return;
        }

        if (!loggedInUser || !loggedInUser.username) {
            errorDiv.textContent = "Sesi pengguna tidak ditemukan. Silakan login ulang."; // Seharusnya tidak terjadi jika modal ini muncul
            errorDiv.style.display = 'block';
            return;
        }

        emailForPrimaryVerification = email; // Simpan email yang akan diverifikasi
        requestButton.disabled = true;
        requestButton.textContent = "Mengirim...";
        showLoading("Meminta kode verifikasi...");

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                // Tombol akan di-enable lagi jika user kembali ke step 1
                // requestButton.disabled = false; 
                // requestButton.textContent = "Kirim Kode Verifikasi";
                if (response.success) {
                    showAlert(response.message, 'success', 5000);
                    showPrimaryEmailStep2(response.emailSentTo || email); // Pindah ke tahap 2
                } else {
                    errorDiv.textContent = response.error || "Gagal mengirim OTP.";
                    errorDiv.style.display = 'block';
                    requestButton.disabled = false; // Aktifkan lagi tombol jika gagal
                    requestButton.textContent = "Kirim Kode Verifikasi";
                    emailForPrimaryVerification = null; // Reset jika gagal
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                requestButton.disabled = false;
                requestButton.textContent = "Kirim Kode Verifikasi";
                emailForPrimaryVerification = null; // Reset jika gagal
                errorDiv.textContent = `Error server: ${err.message}`;
                errorDiv.style.display = 'block';
            })
            .requestPrimaryEmailVerificationOTP(loggedInUser.username, email);
    }

    function handleVerifyAndSavePrimaryEmail() {
        const otpInputEl = document.getElementById('primaryEmailOtpInput');
        const errorDiv = document.getElementById('primaryEmailStep2Error');
        const verifyButton = document.getElementById('btnVerifyAndSavePrimaryEmail');

        if (!otpInputEl || !errorDiv || !verifyButton || !emailForPrimaryVerification) {
            showAlert("Komponen modal email (tahap 2) atau email target tidak ditemukan.", "error");
            if(errorDiv) {
                errorDiv.textContent = "Sesi verifikasi tidak valid. Harap ulangi dari awal.";
                errorDiv.style.display = 'block';
            }
            return;
        }

        const otp = otpInputEl.value.trim();
        clearInputError(otpInputEl);
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';

        if (!otp) {
            errorDiv.textContent = "Kode OTP tidak boleh kosong.";
            errorDiv.style.display = 'block'; showInputError(otpInputEl); return;
        }
        if (otp.length !== 6 || !/^\d{6}$/.test(otp)) {
            errorDiv.textContent = "Kode OTP harus 6 digit angka.";
            errorDiv.style.display = 'block'; showInputError(otpInputEl); return;
        }

        if (!loggedInUser || !loggedInUser.username) {
            errorDiv.textContent = "Sesi pengguna tidak valid."; 
            errorDiv.style.display = 'block'; return;
        }

        verifyButton.disabled = true;
        verifyButton.textContent = "Memverifikasi...";
        showLoading("Memverifikasi dan menyimpan email...");

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                verifyButton.disabled = false;
                verifyButton.textContent = "Verifikasi & Simpan Email";
                if (primaryEmailOtpTimerInterval) {
                    clearInterval(primaryEmailOtpTimerInterval);
                    primaryEmailOtpTimerInterval = null;
                }

                if (response.success) {
                    showAlert(response.message, 'success');
                    if (loggedInUser) {
                        loggedInUser.primaryEmail = response.savedEmail;
                    }
                    const storedUserData = sessionStorage.getItem('loggedInUserData');
                    if (storedUserData) {
                        try {
                            const userData = JSON.parse(storedUserData);
                            userData.primaryEmail = response.savedEmail;
                            sessionStorage.setItem('loggedInUserData', JSON.stringify(userData));
                        } catch(e) { console.error("Gagal update primaryEmail di sessionStorage (setelah verifikasi):", e); }
                    }
                    closePrimaryEmailModal();
                    emailForPrimaryVerification = null; // Reset setelah berhasil
                } else {
                    errorDiv.textContent = response.error || "Gagal verifikasi atau simpan email.";
                    errorDiv.style.display = 'block';
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                verifyButton.disabled = false;
                verifyButton.textContent = "Verifikasi & Simpan Email";
                if (primaryEmailOtpTimerInterval) {
                    clearInterval(primaryEmailOtpTimerInterval);
                    primaryEmailOtpTimerInterval = null;
                }
                errorDiv.textContent = `Error server: ${err.message}`;
                errorDiv.style.display = 'block';
            })
            .verifyPrimaryEmailOTPAndSave(loggedInUser.username, otp, emailForPrimaryVerification);
    }
    
    function showPrimaryEmailStep1() {
        const step1Div = document.getElementById('primaryEmailStep1');
        const step2Div = document.getElementById('primaryEmailStep2');
        const emailInput = document.getElementById('primaryEmailInput');
        const errorStep1 = document.getElementById('primaryEmailStep1Error');
        const btnRequestOTP = document.getElementById('btnRequestPrimaryEmailOTP');

        if (step1Div) step1Div.style.display = 'block';
        if (step2Div) step2Div.style.display = 'none';
        if (emailInput) emailInput.value = emailForPrimaryVerification || ''; // Isi kembali jika ada proses kirim ulang
        if (errorStep1) {
            errorStep1.textContent = '';
            errorStep1.style.display = 'none';
        }
        if (btnRequestOTP) {
            btnRequestOTP.disabled = false;
            btnRequestOTP.textContent = "Kirim Kode Verifikasi";
        }
        if (primaryEmailOtpTimerInterval) {
            clearInterval(primaryEmailOtpTimerInterval);
            primaryEmailOtpTimerInterval = null;
        }
        // Jangan reset emailForPrimaryVerification di sini agar bisa kirim ulang
    }

    function showPrimaryEmailStep2(emailSentTo) {
        const step1Div = document.getElementById('primaryEmailStep1');
        const step2Div = document.getElementById('primaryEmailStep2');
        const otpSentDisplay = document.getElementById('otpSentToPrimaryEmailDisplay');
        const otpInput = document.getElementById('primaryEmailOtpInput');
        const errorStep2 = document.getElementById('primaryEmailStep2Error');
        const btnVerify = document.getElementById('btnVerifyAndSavePrimaryEmail');

        if (step1Div) step1Div.style.display = 'none';
        if (step2Div) step2Div.style.display = 'block';
        if (otpSentDisplay) otpSentDisplay.textContent = emailSentTo;
        if (otpInput) {
            otpInput.value = '';
            otpInput.focus();
        }
        if (errorStep2) {
            errorStep2.textContent = '';
            errorStep2.style.display = 'none';
        }
        if (btnVerify) {
            btnVerify.disabled = false;
            btnVerify.textContent = "Verifikasi & Simpan Email";
        }
        startPrimaryEmailOtpTimer(PRIMARY_EMAIL_OTP_EXPIRY_MINUTES * 60);
    }

    function startPrimaryEmailOtpTimer(durationInSeconds) {
        const timerDisplay = document.getElementById('primaryEmailOtpTimer');
        if (!timerDisplay) return;

        if (primaryEmailOtpTimerInterval) {
            clearInterval(primaryEmailOtpTimerInterval);
        }

        let timer = durationInSeconds;
        timerDisplay.textContent = formatOtpTime(timer); // formatOtpTime sudah ada

        primaryEmailOtpTimerInterval = setInterval(function () {
            timer--;
            if (timer >= 0) {
                timerDisplay.textContent = formatOtpTime(timer);
            } else {
                clearInterval(primaryEmailOtpTimerInterval);
                primaryEmailOtpTimerInterval = null;
                timerDisplay.textContent = "Kedaluwarsa";
                const btnVerify = document.getElementById('btnVerifyAndSavePrimaryEmail');
                if(btnVerify) btnVerify.disabled = true;
                showAlert("Waktu OTP habis. Silakan minta OTP baru.", "warning", 4000);
            }
        }, 1000);
    }    

    function showForgotPasswordForm(event) {
        if(event) event.preventDefault(); 
        
        const mainFields = document.getElementById('mainLoginFields');
        const loginBtnContainer = document.getElementById('loginButtonContainer');
        const forgotLink = document.getElementById('forgotPasswordLink');
        const loginErr = document.getElementById('loginError');
        const forgotContainer = document.getElementById('forgotPasswordContainer');
        const resetContainer = document.getElementById('resetPasswordContainer');
        const resetIdentifier = document.getElementById('resetIdentifierInput');
        const resetIdentifierErr = document.getElementById('resetIdentifierError');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');


        if(mainFields) mainFields.style.display = 'none';
        if(loginBtnContainer) loginBtnContainer.style.display = 'none';
        if(forgotLink) forgotLink.style.display = 'none'; 
        if(loginErr) loginErr.style.display = 'none'; 

        if(forgotContainer) forgotContainer.style.display = 'block';
        if(resetContainer) resetContainer.style.display = 'none'; 
        
        if(resetIdentifier) resetIdentifier.value = '';
        if(resetIdentifierErr) {
            resetIdentifierErr.style.display = 'none';
            resetIdentifierErr.textContent = '';
        }
        if(usernameInput) usernameInput.value = ''; 
        if(passwordInput) passwordInput.value = '';
    }

    function showLoginForm() {
        const mainFields = document.getElementById('mainLoginFields');
        const loginBtnContainer = document.getElementById('loginButtonContainer');
        const forgotLink = document.getElementById('forgotPasswordLink');
        const forgotContainer = document.getElementById('forgotPasswordContainer');
        const resetContainer = document.getElementById('resetPasswordContainer');
        const loginErr = document.getElementById('loginError');

        if(mainFields) mainFields.style.display = 'block';
        if(loginBtnContainer) loginBtnContainer.style.display = 'block';
        if(forgotLink) forgotLink.style.display = 'block'; 
        
        if(forgotContainer) forgotContainer.style.display = 'none';
        if(resetContainer) resetContainer.style.display = 'none';

        if(loginErr) loginErr.style.display = 'none'; 
        usernameForReset = null; 
        if (otpTimerInterval) {
            clearInterval(otpTimerInterval); 
            otpTimerInterval = null;
        }
    }

    function handleSendOTPRequest() {
        const identifierInput = document.getElementById('resetIdentifierInput');
        const errorDiv = document.getElementById('resetIdentifierError');
        const sendOTPButton = document.getElementById('btnSendOTP');

        const identifier = identifierInput.value.trim();
        clearInputError(identifierInput);
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';

        if (!identifier) {
            errorDiv.textContent = "Username atau Email Utama tidak boleh kosong.";
            errorDiv.style.display = 'block';
            showInputError(identifierInput);
            return;
        }

        sendOTPButton.disabled = true;
        sendOTPButton.textContent = "Mengirim...";
        showLoading("Memproses permintaan OTP...");

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                sendOTPButton.disabled = false;
                sendOTPButton.textContent = "Kirim OTP";
                if (response.success) {
                    usernameForReset = response.username; 
                    showAlert(response.message, 'success', 5000); 
                    showOTPInputForm();
                } else {
                    errorDiv.textContent = response.error || "Gagal mengirim OTP.";
                    errorDiv.style.display = 'block';
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                sendOTPButton.disabled = false;
                sendOTPButton.textContent = "Kirim OTP";
                errorDiv.textContent = `Error server: ${err.message}`;
                errorDiv.style.display = 'block';
            })
            .requestPasswordResetOTP(identifier);
    }

    function showOTPInputForm() {
        const forgotContainer = document.getElementById('forgotPasswordContainer');
        const resetContainer = document.getElementById('resetPasswordContainer');
        const otpInputEl = document.getElementById('otpInput');
        const newPassEl = document.getElementById('newPasswordResetInput');
        const confirmPassEl = document.getElementById('confirmNewPasswordResetInput');
        const resetErrDiv = document.getElementById('resetPasswordError');

        if(forgotContainer) forgotContainer.style.display = 'none';
        if(resetContainer) resetContainer.style.display = 'block';

        if(otpInputEl) otpInputEl.value = '';
        if(newPassEl) newPassEl.value = '';
        if(confirmPassEl) confirmPassEl.value = '';
        if(resetErrDiv) {
            resetErrDiv.style.display = 'none';
            resetErrDiv.textContent = '';
        }
        startOTPTimer(10 * 60); 
    }

    function startOTPTimer(durationInSeconds) {
        const timerDisplay = document.getElementById('otpTimer');
        if (!timerDisplay) return;

        if (otpTimerInterval) {
            clearInterval(otpTimerInterval); 
        }

        let timer = durationInSeconds;
        otpTimerInterval = setInterval(function () {
            let minutes = parseInt(timer / 60, 10);
            let seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            timerDisplay.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(otpTimerInterval);
                otpTimerInterval = null;
                timerDisplay.textContent = "Kedaluwarsa";
                const btnReset = document.getElementById('btnResetPassword');
                if(btnReset) btnReset.disabled = true;
                showAlert("Waktu OTP habis. Silakan minta OTP baru.", "warning", 4000);
            }
        }, 1000);
    }

    function handleResetPassword() {
        const otpInputEl = document.getElementById('otpInput');
        const newPasswordEl = document.getElementById('newPasswordResetInput');
        const confirmNewPasswordEl = document.getElementById('confirmNewPasswordResetInput');
        const errorDiv = document.getElementById('resetPasswordError');
        const resetButton = document.getElementById('btnResetPassword');

        if (!otpInputEl || !newPasswordEl || !confirmNewPasswordEl || !errorDiv || !resetButton) {
            showAlert("Komponen form reset password tidak ditemukan.", "error");
            return;
        }

        const otp = otpInputEl.value.trim();
        const newPassword = newPasswordEl.value; 
        const confirmNewPassword = confirmNewPasswordEl.value;

        clearInputError(otpInputEl, newPasswordEl, confirmNewPasswordEl);
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';

        if (!otp) {
            errorDiv.textContent = "Kode OTP tidak boleh kosong.";
            errorDiv.style.display = 'block';
            showInputError(otpInputEl);
            return;
        }
        if (otp.length !== 6 || !/^\d{6}$/.test(otp)) {
            errorDiv.textContent = "Kode OTP harus 6 digit angka.";
            errorDiv.style.display = 'block';
            showInputError(otpInputEl);
            return;
        }
        if (!newPassword) {
            errorDiv.textContent = "Password baru tidak boleh kosong.";
            errorDiv.style.display = 'block';
            showInputError(newPasswordEl);
            return;
        }
        if (newPassword.length < 4) {
            errorDiv.textContent = "Password baru minimal 4 karakter.";
            errorDiv.style.display = 'block';
            showInputError(newPasswordEl);
            return;
        }
        if (newPassword !== confirmNewPassword) {
            errorDiv.textContent = "Konfirmasi password baru tidak cocok.";
            errorDiv.style.display = 'block';
            showInputError(confirmNewPasswordEl);
            return;
        }

        if (!usernameForReset) { 
            errorDiv.textContent = "Sesi reset password tidak valid. Silakan ulangi dari awal.";
            errorDiv.style.display = 'block';
            return;
        }

        resetButton.disabled = true;
        resetButton.textContent = "Memproses...";
        showLoading("Mereset password Anda...");

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                resetButton.disabled = false;
                resetButton.textContent = "Reset Password";
                if (otpTimerInterval) { 
                    clearInterval(otpTimerInterval);
                    otpTimerInterval = null;
                }
                if (response.success) {
                    showAlert(response.message, 'success', 5000);
                    showLoginForm(); 
                    otpInputEl.value = '';
                    newPasswordEl.value = '';
                    confirmNewPasswordEl.value = '';
                } else {
                    errorDiv.textContent = response.error || "Gagal mereset password.";
                    errorDiv.style.display = 'block';
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                resetButton.disabled = false;
                resetButton.textContent = "Reset Password";
                if (otpTimerInterval) {
                    clearInterval(otpTimerInterval);
                    otpTimerInterval = null;
                }
                errorDiv.textContent = `Error server: ${err.message}`;
                errorDiv.style.display = 'block';
            })
            .verifyOTPAndResetPassword(usernameForReset, otp, newPassword);
    }

    function openChangePrimaryEmailModal(isResetToStep1 = false) {
        const modal = document.getElementById('changePrimaryEmailModal');
        const step1Div = document.getElementById('changeEmailStep1');
        const step2Div = document.getElementById('changeEmailStep2');
        const currentEmailDisplay = document.getElementById('currentPrimaryEmailDisplay');
        const currentEmailForOtpSpan = document.getElementById('currentPrimaryEmailForOtp');
        const newEmailInput = document.getElementById('newPrimaryEmailInput');
        const otpInput = document.getElementById('changeEmailOtpInput');
        const errorStep1 = document.getElementById('changeEmailStep1Error');
        const errorStep2 = document.getElementById('changeEmailStep2Error');
        const modalTitle = document.getElementById('changeEmailModalTitle');

        if (!modal || !step1Div || !step2Div || !currentEmailDisplay || !newEmailInput || !otpInput || !errorStep1 || !errorStep2 || !currentEmailForOtpSpan || !modalTitle) {
            showAlert("Komponen modal ubah email tidak lengkap.", "error");
            return;
        }

        if (loggedInUser && loggedInUser.primaryEmail) {
            currentEmailDisplay.textContent = loggedInUser.primaryEmail;
            currentEmailForOtpSpan.textContent = loggedInUser.primaryEmail; 
        } else {
            showAlert("Email utama Anda belum terdaftar.", "warning");
            currentEmailDisplay.textContent = "Tidak ada";
            currentEmailForOtpSpan.textContent = "email lama Anda";
        }
        
        if (isResetToStep1 || !proposedNewPrimaryEmail) {
            modalTitle.textContent = "Ubah Email Utama Anda";
            step1Div.style.display = 'block';
            step2Div.style.display = 'none';
            newEmailInput.value = '';
            otpInput.value = ''; 
            errorStep1.textContent = '';
            errorStep1.style.display = 'none';
            errorStep2.textContent = '';
            errorStep2.style.display = 'none';
            clearInputError(newEmailInput, otpInput);
            proposedNewPrimaryEmail = null; 
            if (changeEmailOtpTimerInterval) {
                clearInterval(changeEmailOtpTimerInterval);
                changeEmailOtpTimerInterval = null;
            }
            document.getElementById('btnSendChangeEmailOTP').disabled = false;
            document.getElementById('btnSendChangeEmailOTP').textContent = "Kirim Kode Verifikasi";
        } 
        modal.style.display = 'flex';
        if (step1Div.style.display === 'block') {
            newEmailInput.focus();
        }
    }

    function closeChangePrimaryEmailModal() {
        const modal = document.getElementById('changePrimaryEmailModal');
        if (modal) {
            modal.style.display = 'none';
        }
        proposedNewPrimaryEmail = null; 
        if (changeEmailOtpTimerInterval) {
            clearInterval(changeEmailOtpTimerInterval);
            changeEmailOtpTimerInterval = null;
        }
    }

    function showChangeEmailStep2(newEmail, oldEmailForDisplay) {
        const modalTitle = document.getElementById('changeEmailModalTitle');
        const step1Div = document.getElementById('changeEmailStep1');
        const step2Div = document.getElementById('changeEmailStep2');
        const otpSentToDisplay = document.getElementById('otpSentToEmailDisplay');
        const newProposedDisplay = document.getElementById('newProposedEmailDisplay');
        const otpInput = document.getElementById('changeEmailOtpInput');
        const errorStep2 = document.getElementById('changeEmailStep2Error');


        if (modalTitle) modalTitle.textContent = "Masukkan Kode Verifikasi";
        if (step1Div) step1Div.style.display = 'none';
        if (step2Div) step2Div.style.display = 'block';
        if (otpSentToDisplay) otpSentToDisplay.textContent = oldEmailForDisplay || (loggedInUser ? loggedInUser.primaryEmail : 'email lama Anda');
        if (newProposedDisplay) newProposedDisplay.textContent = newEmail;
        if (otpInput) {
            otpInput.value = ''; 
            otpInput.focus();
        }
        if(errorStep2) {
            errorStep2.textContent = '';
            errorStep2.style.display = 'none';
        }
        document.getElementById('btnVerifyAndSaveNewEmail').disabled = false;
        document.getElementById('btnVerifyAndSaveNewEmail').textContent = "Verifikasi & Ganti Email";

        startChangeEmailOtpTimer(CHANGE_EMAIL_OTP_EXPIRY_MINUTES * 60); 
    }

    function startChangeEmailOtpTimer(durationInSeconds) {
        const timerDisplay = document.getElementById('changeEmailOtpTimer');
        if (!timerDisplay) return;

        if (changeEmailOtpTimerInterval) {
            clearInterval(changeEmailOtpTimerInterval);
        }

        let timer = durationInSeconds;
        timerDisplay.textContent = formatOtpTime(timer); 

        changeEmailOtpTimerInterval = setInterval(function () {
            timer--;
            if (timer >= 0) {
                timerDisplay.textContent = formatOtpTime(timer);
            } else {
                clearInterval(changeEmailOtpTimerInterval);
                changeEmailOtpTimerInterval = null;
                timerDisplay.textContent = "Kedaluwarsa";
                const btnVerify = document.getElementById('btnVerifyAndSaveNewEmail');
                if(btnVerify) btnVerify.disabled = true;
                showAlert("Waktu OTP untuk ubah email habis. Silakan minta kode baru.", "warning", 4000);
            }
        }, 1000);
    }

    function formatOtpTime(totalSeconds) {
        let minutes = parseInt(totalSeconds / 60, 10);
        let seconds = parseInt(totalSeconds % 60, 10);
        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;
        return minutes + ":" + seconds;
    }


    function handleSendChangeEmailOTP() {
        const newEmailInput = document.getElementById('newPrimaryEmailInput');
        const errorDiv = document.getElementById('changeEmailStep1Error');
        const sendButton = document.getElementById('btnSendChangeEmailOTP');

        if (!newEmailInput || !errorDiv || !sendButton) return;

        const newEmail = newEmailInput.value.trim().toLowerCase(); 
        clearInputError(newEmailInput);
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';

        if (!newEmail) {
            errorDiv.textContent = "Email baru tidak boleh kosong.";
            errorDiv.style.display = 'block'; showInputError(newEmailInput); return;
        }
        if (!isValidEmail(newEmail)) {
            errorDiv.textContent = "Format email baru tidak valid.";
            errorDiv.style.display = 'block'; showInputError(newEmailInput); return;
        }
        if (loggedInUser && loggedInUser.primaryEmail && newEmail === loggedInUser.primaryEmail.toLowerCase()) {
            errorDiv.textContent = "Email baru tidak boleh sama dengan email lama Anda.";
            errorDiv.style.display = 'block'; showInputError(newEmailInput); return;
        }
        if (!loggedInUser || !loggedInUser.username) {
            errorDiv.textContent = "Sesi pengguna tidak valid.";
            errorDiv.style.display = 'block'; return;
        }

        sendButton.disabled = true;
        sendButton.textContent = "Mengirim...";
        showLoading("Meminta kode verifikasi...");

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                sendButton.disabled = false;
                sendButton.textContent = "Kirim Kode Verifikasi";
                if (response.success) {
                    proposedNewPrimaryEmail = response.newEmailPreview || newEmail; 
                    showAlert(response.message, 'success', 5000);
                    showChangeEmailStep2(proposedNewPrimaryEmail, response.oldEmailForDisplay); 
                } else {
                    errorDiv.textContent = response.error || "Gagal mengirim kode verifikasi.";
                    errorDiv.style.display = 'block';
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                sendButton.disabled = false;
                sendButton.textContent = "Kirim Kode Verifikasi";
                errorDiv.textContent = `Error server: ${err.message}`;
                errorDiv.style.display = 'block';
            })
            .requestChangePrimaryEmailOTP(loggedInUser.username, newEmail);
    }

    function handleVerifyAndSaveNewEmail() {
        const otpInputEl = document.getElementById('changeEmailOtpInput');
        const errorDiv = document.getElementById('changeEmailStep2Error');
        const verifyButton = document.getElementById('btnVerifyAndSaveNewEmail');

        if (!otpInputEl || !errorDiv || !verifyButton) return;

        const otp = otpInputEl.value.trim();
        clearInputError(otpInputEl);
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';

        if (!otp) {
            errorDiv.textContent = "Kode OTP tidak boleh kosong.";
            errorDiv.style.display = 'block'; showInputError(otpInputEl); return;
        }
        if (otp.length !== 6 || !/^\d{6}$/.test(otp)) {
            errorDiv.textContent = "Kode OTP harus 6 digit angka.";
            errorDiv.style.display = 'block'; showInputError(otpInputEl); return;
        }
        if (!proposedNewPrimaryEmail) { 
            errorDiv.textContent = "Sesi perubahan email tidak valid. Harap ulangi dari awal.";
            errorDiv.style.display = 'block';
            openChangePrimaryEmailModal(true); 
            return;
        }
        if (!loggedInUser || !loggedInUser.username) {
            errorDiv.textContent = "Sesi pengguna tidak valid.";
            errorDiv.style.display = 'block'; return;
        }

        verifyButton.disabled = true;
        verifyButton.textContent = "Memverifikasi...";
        showLoading("Memverifikasi dan menyimpan email baru...");

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                verifyButton.disabled = false;
                verifyButton.textContent = "Verifikasi & Ganti Email";
                if (changeEmailOtpTimerInterval) { 
                    clearInterval(changeEmailOtpTimerInterval);
                    changeEmailOtpTimerInterval = null;
                }

                if (response.success) {
                    showAlert(response.message, 'success');
                    if (loggedInUser) {
                        loggedInUser.primaryEmail = response.updatedEmail;
                    }
                    const storedUserData = sessionStorage.getItem('loggedInUserData');
                    if (storedUserData) {
                        try {
                            const userData = JSON.parse(storedUserData);
                            userData.primaryEmail = response.updatedEmail;
                            sessionStorage.setItem('loggedInUserData', JSON.stringify(userData));
                        } catch(e) { console.error("Gagal update primaryEmail di sessionStorage:", e); }
                    }
                    const emailTextSpan = document.getElementById('userPrimaryEmailText');
                    if (emailTextSpan) emailTextSpan.textContent = response.updatedEmail;
                    
                    closeChangePrimaryEmailModal();
                    proposedNewPrimaryEmail = null; 
                } else {
                    errorDiv.textContent = response.error || "Gagal mengubah email.";
                    errorDiv.style.display = 'block';
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                verifyButton.disabled = false;
                verifyButton.textContent = "Verifikasi & Ganti Email";
                if (changeEmailOtpTimerInterval) {
                    clearInterval(changeEmailOtpTimerInterval);
                    changeEmailOtpTimerInterval = null;
                }
                errorDiv.textContent = `Error server: ${err.message}`;
                errorDiv.style.display = 'block';
            })
            .verifyAndChangePrimaryEmail(loggedInUser.username, otp, proposedNewPrimaryEmail);
    }

    function navigateToTutorial() {
        const profileMenuContainer = document.getElementById('profileMenuContainer');
        if (profileMenuContainer && profileMenuContainer.classList.contains('show-dropdown')) {
            profileMenuContainer.classList.remove('show-dropdown');
        }
        renderView('tutorial');
    }

    function setupTutorialView(data) {
        // Jika ada setup khusus untuk halaman tutorial, tambahkan di sini.
        // Untuk sekarang, mungkin hanya scroll ke atas.
        window.scrollTo(0, 0);
        console.log("Tutorial view setup.");
    }

    // Fungsi baru
    function goBackFromTutorial() {
        if (previousViewBeforeTutorial && previousViewBeforeTutorial !== 'tutorial') {
            // Perlu memuat ulang data untuk view sebelumnya jika diperlukan
            // Ini contoh sederhana, mungkin perlu logika lebih kompleks tergantung view sebelumnya
            if (previousViewBeforeTutorial === 'admin_dashboard') {
                goBackToAdminDashboard(); // Fungsi ini sudah ada dan menangani load data
            } else if (previousViewBeforeTutorial === 'ceklok_table' && loggedInUser) {
                loadCeklokDataFromServer(namaGuru, activeCeklokMonthYear || globalServerCurrentMonthYear, loggedInUser.role === 'user');
            } else if (previousViewBeforeTutorial === 'hasil_ceklok') {
                navigateToHasilCeklok(); // Fungsi ini sudah ada
            }
            // Tambahkan kondisi lain untuk view lain yang mungkin
            else {
                // Fallback jika tidak ada view sebelumnya yang spesifik atau jika login
                if (loggedInUser) {
                    if (loggedInUser.role === 'admin') goBackToAdminDashboard();
                    else if (loggedInUser.role === 'user') loadCeklokDataFromServer(namaGuru, activeCeklokMonthYear || globalServerCurrentMonthYear, true);
                    else logout();
                } else {
                    logout();
                }
            }
        } else {
            // Fallback jika tidak ada view sebelumnya yang valid
            if (loggedInUser) {
                if (loggedInUser.role === 'admin') goBackToAdminDashboard();
                else if (loggedInUser.role === 'user') loadCeklokDataFromServer(namaGuru, activeCeklokMonthYear || globalServerCurrentMonthYear, true);
                else logout();
            } else {
                logout();
            }
        }
    }

    /**
     * (VERSI BARU) Memuat dan menampilkan ringkasan kehadiran guru pada kartu-kartu di dasbor.
     */
    function loadAndDisplayTeacherSummary(teacherName, monthYear) {
        const summaryContainer = document.getElementById('teacherDashboardSummary');
        const summaryLoadingEl = document.getElementById('summaryContentLoading');
        const summaryDataEl = document.getElementById('summaryContentData');
        const summaryErrorEl = document.getElementById('summaryContentError');

        const summaryItemAbsentEl = document.getElementById('summaryItemAbsent');
        const summaryItemIncompleteEl = document.getElementById('summaryItemIncomplete');

        if (!summaryContainer || !summaryLoadingEl || !summaryDataEl || !summaryErrorEl) {
            console.error("Elemen ringkasan atau item yang dapat diklik tidak ditemukan.");
            return;
        }

        summaryLoadingEl.style.display = 'block';
        summaryDataEl.style.display = 'none';
        summaryErrorEl.style.display = 'none';

        if (summaryItemAbsentEl) summaryItemAbsentEl.onclick = null;
        if (summaryItemIncompleteEl) summaryItemIncompleteEl.onclick = null;

        google.script.run
            .withSuccessHandler(response => {
                summaryLoadingEl.style.display = 'none';
                if (response.success && response.summary) {
                    const summary = response.summary;
                    
                    // Mengisi data ke kartu-kartu baru di dasbor
                    document.getElementById('summaryTotalWorkingDays').textContent = summary.totalWorkingDaysInMonth;
                    document.getElementById('summaryDaysPassed').textContent = summary.effectiveWorkingDaysPassed;
                    document.getElementById('summaryPresent').textContent = summary.present;
                    document.getElementById('summarySchoolHoliday').textContent = summary.schoolHoliday;
                    document.getElementById('summaryOtherValidReason').textContent = summary.otherValidReason;
                    document.getElementById('summaryAbsent').textContent = summary.absent;
                    document.getElementById('summaryIncomplete').textContent = summary.incomplete;
                    document.getElementById('summaryAttendancePercentage').textContent = summary.attendancePercentage;
                    document.getElementById('summaryCompletedDaysDisplay').textContent = `(${summary.completedChecklok} Hari)`;
                    
                    // Elemen tersembunyi untuk kompatibilitas (jika masih diperlukan oleh fungsi lain)
                    const hiddenCompletedEl = document.getElementById('summaryCompletedChecklok');
                    if (hiddenCompletedEl) {
                        hiddenCompletedEl.textContent = summary.completedChecklok;
                    }

                    currentTeacherSummaryDetails.absentDates = summary.absentDates || [];
                    currentTeacherSummaryDetails.incompleteEntries = summary.incompleteEntries || [];

                    if (summary.absent > 0 && summaryItemAbsentEl) {
                        summaryItemAbsentEl.onclick = function() {
                            openSummaryDetailModal('Detail Tanggal Alpa', currentTeacherSummaryDetails.absentDates, 'absent');
                        };
                    }

                    if (summary.incomplete > 0 && summaryItemIncompleteEl) {
                        summaryItemIncompleteEl.onclick = function() {
                            openSummaryDetailModal('Detail Ceklok Tidak Lengkap', currentTeacherSummaryDetails.incompleteEntries, 'incomplete');
                        };
                    }
                    
                    summaryDataEl.style.display = 'block';
                } else {
                    summaryErrorEl.textContent = response.error || "Gagal memuat ringkasan kehadiran.";
                    summaryErrorEl.style.display = 'block';
                }
            })
            .withFailureHandler(err => {
                summaryLoadingEl.style.display = 'none';
                summaryErrorEl.textContent = `Error server saat memuat ringkasan: ${err.message}`;
                summaryErrorEl.style.display = 'block';
            })
            .getTeacherMonthlySummary(teacherName, monthYear);
    }

    function handleLockThisMonth() {
        const monthInputEl = document.getElementById('monthToLockAdminInput');
        if (!monthInputEl) {
            showAlert("Elemen input bulan tidak ditemukan.", "error");
            return;
        }
        const yyyy_mm = monthInputEl.value; // Format "YYYY-MM" dari input type="month"
        if (!yyyy_mm) {
            showAlert("Silakan pilih bulan dan tahun yang akan dikunci.", "warning");
            return;
        }
        const [year, month] = yyyy_mm.split('-');
        if (!year || !month) {
            showAlert("Format input bulan tidak sesuai.", "error");
            return;
        }
        const monthYearToLock = `${month}/${year}`; // Konversi ke "MM/YYYY"

        // Validasi tambahan untuk memastikan format MM/YYYY benar
        if (!/^(0[1-9]|1[0-2])\/(20\d{2}|21\d{2})$/.test(monthYearToLock)) {
            showAlert("Format bulan/tahun untuk dikunci tidak valid (seharusnya MM/YYYY). Input: " + monthYearToLock, "error");
            return;
        }


        showLoading("Mengunci bulan " + monthYearToLock + "...");
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                showAlert(response.message || response.error, response.success ? 'success' : 'error');
                if (response.success) {
                    loadLockedMonthsForAdminDisplay(); // Refresh daftar
                    monthInputEl.value = ''; // Kosongkan input setelah berhasil
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showAlert(`Gagal mengunci bulan: ${err.message}`, 'error');
            })
            .lockMonth(monthYearToLock, loggedInUser.username, loggedInUser.role);
    }

    function handleUnlockThisMonth(monthYearToUnlock) {
        if (!monthYearToUnlock) {
            showAlert("Bulan/Tahun untuk dibuka kuncinya tidak spesifik.", "error");
            return;
        }
        if (!confirm(`Yakin ingin membuka kunci untuk bulan ${monthYearToUnlock}? Guru akan dapat mengubah data ceklok pada bulan tersebut.`)) {
            return;
        }
        showLoading("Membuka kunci bulan " + monthYearToUnlock + "...");
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                showAlert(response.message || response.error, response.success ? 'success' : 'error');
                if (response.success) {
                    loadLockedMonthsForAdminDisplay(); // Refresh daftar
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showAlert(`Gagal membuka kunci bulan: ${err.message}`, 'error');
            })
            .unlockMonth(monthYearToUnlock, loggedInUser.username, loggedInUser.role);
    }

    // Modifikasi pada fungsi setupAdminDashboardView(data)
    // Pastikan Anda menemukan fungsi setupAdminDashboardView(data) yang sudah ada
    // dan tambahkan baris `loadLockedMonthsForAdminDisplay();` di dalamnya.

    // Tambahkan fungsi ini di dalam <script> di index.html

    const svgIconShowPassword = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
    const svgIconHidePassword = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';

    function togglePasswordVisibility(inputId, toggleButtonId) {
        const passwordInput = document.getElementById(inputId);
        const toggleButton = document.getElementById(toggleButtonId);

        if (!passwordInput || !toggleButton) {
            console.warn("Input password atau tombol toggle tidak ditemukan:", inputId, toggleButtonId);
            return;
        }

        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleButton.innerHTML = svgIconHidePassword;
            toggleButton.setAttribute('title', 'Sembunyikan password');
        } else {
            passwordInput.type = 'password';
            toggleButton.innerHTML = svgIconShowPassword;
            toggleButton.setAttribute('title', 'Lihat password');
        }
    }

    // Fungsi untuk menginisialisasi semua tombol toggle password yang ada di halaman
    function initializeAllPasswordToggles() {
        // Untuk form login utama (jika belum dihandle spesifik)
        const mainPasswordToggle = document.getElementById('togglePassword');
        if (mainPasswordToggle && document.getElementById('password')) {
            mainPasswordToggle.onclick = () => togglePasswordVisibility('password', 'togglePassword');
        }

        // Untuk form Reset Password
        const newPasswordResetToggle = document.getElementById('toggleNewPasswordReset');
        if (newPasswordResetToggle && document.getElementById('newPasswordResetInput')) {
            newPasswordResetToggle.onclick = () => togglePasswordVisibility('newPasswordResetInput', 'toggleNewPasswordReset');
        }
        const confirmNewPasswordResetToggle = document.getElementById('toggleConfirmNewPasswordReset');
        if (confirmNewPasswordResetToggle && document.getElementById('confirmNewPasswordResetInput')) {
            confirmNewPasswordResetToggle.onclick = () => togglePasswordVisibility('confirmNewPasswordResetInput', 'toggleConfirmNewPasswordReset');
        }
        
        // Untuk Modal Ubah Password
        const currentPasswordToggle = document.getElementById('toggleCurrentPassword');
        if (currentPasswordToggle && document.getElementById('currentPassword')) {
            currentPasswordToggle.onclick = () => togglePasswordVisibility('currentPassword', 'toggleCurrentPassword');
        }
        const newPasswordModalToggle = document.getElementById('toggleNewPasswordModal');
        if (newPasswordModalToggle && document.getElementById('newPassword')) {
            newPasswordModalToggle.onclick = () => togglePasswordVisibility('newPassword', 'toggleNewPasswordModal');
        }
        const confirmNewPasswordModalToggle = document.getElementById('toggleConfirmNewPasswordModal');
        if (confirmNewPasswordModalToggle && document.getElementById('confirmNewPassword')) {
            confirmNewPasswordModalToggle.onclick = () => togglePasswordVisibility('confirmNewPassword', 'toggleConfirmNewPasswordModal');
        }

        // Untuk User Management
        const manageUserPasswordToggle = document.getElementById('toggleManageUserPassword');
        if (manageUserPasswordToggle && document.getElementById('manageUserPasswordInput')) {
            manageUserPasswordToggle.onclick = () => togglePasswordVisibility('manageUserPasswordInput', 'toggleManageUserPassword');
        }
    }

    // Di dalam file index.html, dalam blok <script>

    // ... (variabel global dan fungsi lain yang sudah ada) ...

    // Fungsi untuk navigasi ke halaman log aktivitas
    function navigateToActivityLog() {
        if (loggedInUser && loggedInUser.role === ROLE_SUPERADMIN) {
            // 'activity_log' adalah nama view baru yang akan kita daftarkan di renderView
            renderView('activity_log');
        } else {
            showAlert("Hanya Superadmin yang dapat mengakses halaman ini.", "error");
            // Arahkan kembali ke dashboard yang sesuai atau logout jika perlu
            if (loggedInUser && loggedInUser.role === ROLE_ADMIN) {
                goBackToAdminDashboard();
            } else {
                logout();
            }
        }
    }

    // Di dalam file index.html, dalam blok <script>

    // --- Variabel Global untuk Paginasi dan Filter Log (sudah ada atau tambahkan) ---
    let currentLogPage = 1;
    const LOGS_PER_PAGE = 30; // Anda bisa sesuaikan jumlah log per halaman
    let totalLogEntriesGlobal = 0; // Untuk menyimpan total entri setelah filter dari server
    let currentLogFiltersGlobal = {}; // Untuk menyimpan state filter saat ini

    // Fungsi setupActivityLogView (diperbarui)
    // Fungsi setupActivityLogView (diperbarui)
    function setupActivityLogView() {
        window.scrollTo(0, 0);
        currentLogPage = 1; 
        currentLogSortColumn = 'timestamp_internal_sort'; // Reset ke default sort saat view dimuat
        currentLogSortDirection = 'desc'; // Default direction (newest first)

        // Panggil fungsi untuk mereset filter ke keadaan default
        // false berarti tidak langsung memuat data, karena loadActivityLogWithFilters() akan dipanggil setelah ini
        resetActivityLogFilters(false); 

        // Panggil loadActivityLogWithFilters() untuk memuat data log awal dengan filter default (jika ada) dan sorting
        // Fungsi ini juga akan menangani tampilan loading dan error jika ada
        loadActivityLogWithFilters();   

        // Tambahkan event listener ke header yang bisa disortir
        document.querySelectorAll('#activityLogTable th.sortable-header').forEach(header => {
            header.onclick = function() {
                const columnKey = this.dataset.columnKey;
                if (columnKey) {
                    handleLogColumnSort(columnKey);
                }
            };
        });

        // Menampilkan atau menyembunyikan bagian reset log berdasarkan peran pengguna
        const resetLogSection = document.getElementById('resetLogSectionContainer');
        if (resetLogSection) {
            if (loggedInUser && loggedInUser.role === ROLE_SUPERADMIN) {
                resetLogSection.style.display = 'block';
            } else {
                resetLogSection.style.display = 'none';
            }
        }
        // Jika loadActivityLogWithFilters() tidak dipanggil di atas (misalnya, jika resetActivityLogFilters(true) digunakan),
        // maka pemanggilan eksplisit loadActivityLogWithFilters() atau loadActivityLogData() (jika ada) diperlukan di sini.
        // Namun, berdasarkan implementasi sebelumnya, resetActivityLogFilters(false) diikuti loadActivityLogWithFilters() sudah cukup.
    }

    // Fungsi loadActivityLogWithFilters yang sudah dimodifikasi
    function loadActivityLogWithFilters(isPageChange = false) {
        if (!isPageChange) {
            // currentLogPage sudah direset oleh handleLogColumnSort jika bukan page change
            // Jika ini apply filter biasa, reset page ke 1
            if(currentLogFiltersGlobal.sortBy !== currentLogSortColumn || currentLogFiltersGlobal.sortDir !== currentLogSortDirection){
                 // No, it means if this call to loadActivityLogWithFilters
                 // is NOT a direct result of a sort change (e.g. it's a filter change or initial load)
                 // then reset the page.
                 // If it IS a page change, currentLogPage is already set by changeLogPage.
                 // If it IS a sort change, currentLogPage is already set by handleLogColumnSort.
            } else if (!isPageChange) { // For regular filter application, reset page
                 currentLogPage = 1;
            }
        }

        const filterUsernameEl = document.getElementById('logFilterUsername');
        const filterActionTypeEl = document.getElementById('logFilterActionType');
        const filterStartDateEl = document.getElementById('logFilterDateStart');
        const filterEndDateEl = document.getElementById('logFilterDateEnd');

        let startDateForAPI = null;
        let endDateForAPI = null;

        const startDateInput = filterStartDateEl ? filterStartDateEl.value.trim() : "";
        if (startDateInput) {
            if (isValidDDMMYYYY(startDateInput)) { // Asumsi fungsi ini sudah ada
                startDateForAPI = convertDDMMYYYYtoYYYYMMDD(startDateInput); // Asumsi fungsi ini sudah ada
            } else {
                showAlert(`Format Tanggal Mulai (${startDateInput}) salah. Harap gunakan dd/mm/yyyy. Filter tanggal mulai diabaikan.`, "warning");
            }
        }

        const endDateInput = filterEndDateEl ? filterEndDateEl.value.trim() : "";
        if (endDateInput) {
            if (isValidDDMMYYYY(endDateInput)) {
                endDateForAPI = convertDDMMYYYYtoYYYYMMDD(endDateInput);
            } else {
                showAlert(`Format Tanggal Akhir (${endDateInput}) salah. Harap gunakan dd/mm/yyyy. Filter tanggal akhir diabaikan.`, "warning");
            }
        }
        
        currentLogFiltersGlobal = {
            filterUsername: filterUsernameEl ? filterUsernameEl.value.trim() : "",
            filterActionType: filterActionTypeEl ? filterActionTypeEl.value.trim() : "",
            filterStartDateString: startDateForAPI, 
            filterEndDateString: endDateForAPI,     
            limit: LOGS_PER_PAGE,
            offset: (currentLogPage - 1) * LOGS_PER_PAGE,
            // Parameter sortir BARU:
            sortBy: currentLogSortColumn,
            sortDir: currentLogSortDirection
        };
        
        if (currentLogFiltersGlobal.filterStartDateString && currentLogFiltersGlobal.filterEndDateString &&
            currentLogFiltersGlobal.filterStartDateString > currentLogFiltersGlobal.filterEndDateString) {
            showAlert("Tanggal 'Dari' tidak boleh lebih besar dari tanggal 'Sampai'. Filter tanggal diabaikan.", "warning");
            currentLogFiltersGlobal.filterStartDateString = null;
            currentLogFiltersGlobal.filterEndDateString = null;
        }

        showLoading("Memuat log aktivitas...");
        const tableBody = document.getElementById('activityLogTableBody');
        if (tableBody) {
            tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;">Memuat data log...</td></tr>`;
        }
        document.getElementById('totalLogEntriesInfo').textContent = '';
        updateActivityLogHeaderSortIcons(); // Update ikon sebelum memuat

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                if (!tableBody) return;

                if (response.success) {
                    totalLogEntriesGlobal = response.totalFilteredLogs || 0;
                    renderActivityLogTable(response.logs); // renderActivityLogTable tetap sama
                    updateLogPaginationControls();
                    document.getElementById('totalLogEntriesInfo').textContent = `Total ${totalLogEntriesGlobal} entri ditemukan ${ (startDateForAPI || endDateForAPI) ? 'sesuai filter' : ''}.`;
                } else {
                    showAlert(response.error || "Gagal memuat log.", "error");
                    tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px; color:red;">${response.error || 'Gagal memuat data.'}</td></tr>`;
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showAlert(`Error server saat mengambil log: ${err.message}`, "error");
                if (tableBody) {
                    tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px; color:red;">Error server: ${err.message}</td></tr>`;
                }
            })
            .getActivityLogData(loggedInUser.role, currentLogFiltersGlobal);
    }

    // Fungsi BARU untuk mereset filter
    function resetActivityLogFilters(doLoad = true) {
        const filterUsernameEl = document.getElementById('logFilterUsername');
        const filterActionTypeEl = document.getElementById('logFilterActionType');
        const filterStartDateEl = document.getElementById('logFilterDateStart');
        const filterEndDateEl = document.getElementById('logFilterDateEnd');

        if (filterUsernameEl) filterUsernameEl.value = '';
        if (filterActionTypeEl) filterActionTypeEl.value = '';
        if (filterStartDateEl) filterStartDateEl.value = '';
        if (filterEndDateEl) {
            // Set default end date ke hari ini lagi jika diinginkan saat reset
            // filterEndDateEl.valueAsDate = new Date();
            filterEndDateEl.value = ''; // Atau kosongkan saja
        }

        currentLogFiltersGlobal = {}; // Hapus semua filter yang tersimpan
        currentLogPage = 1;
        if (doLoad) {
            loadActivityLogWithFilters();
        }
    }

    // Fungsi BARU untuk memperbarui kontrol paginasi
    function updateLogPaginationControls() {
        const pageInfo = document.getElementById('logPageInfo');
        const prevButton = document.getElementById('logPrevPage');
        const nextButton = document.getElementById('logNextPage');

        if (!pageInfo || !prevButton || !nextButton) {
            console.error("Elemen kontrol paginasi tidak ditemukan.");
            return;
        }

        const totalPages = Math.ceil(totalLogEntriesGlobal / LOGS_PER_PAGE);
        pageInfo.textContent = `Halaman ${currentLogPage} dari ${totalPages > 0 ? totalPages : 1}`;

        prevButton.disabled = (currentLogPage <= 1);
        nextButton.disabled = (currentLogPage >= totalPages || totalPages === 0);
    }

    // Fungsi BARU untuk mengganti halaman log
    function changeLogPage(direction) {
        const newPage = currentLogPage + direction;
        // Tidak perlu cek totalPages di sini karena loadActivityLogWithFilters akan dipanggil
        // dan server akan mengembalikan data yang sesuai (atau kosong jika halaman tidak ada)
        // Namun, kita bisa nonaktifkan tombol berdasarkan totalPages di updateLogPaginationControls

        currentLogPage = newPage;
        loadActivityLogWithFilters(true); // true menandakan ini adalah perubahan halaman
    }

    // renderActivityLogTable(logs) sudah ada dari langkah sebelumnya, pastikan format timestamp-nya baik.
    // Fungsi seperti navigateToActivityLog, goBackToAdminDashboard juga sudah ada.

    // Fungsi untuk merender data log ke dalam tabel
    function renderActivityLogTable(logs) {
        const tableBody = document.getElementById('activityLogTableBody');
        if (!tableBody) return;

        let html = '';
        if (logs && logs.length > 0) {
            logs.forEach(log => {
                // Format timestamp agar lebih mudah dibaca
                let formattedTimestamp = log.timestamp;
                try {
                    // Mencoba format ke 'dd/MM/yyyy HH:mm:ss', sesuaikan dengan lokal Anda jika perlu
                    // Google Sheet DisplayValue biasanya sudah dalam format yang cukup baik,
                    // tapi jika itu ISO string, kita bisa format.
                    const dateObj = new Date(log.timestamp);
                    if (!isNaN(dateObj)) {
                        // Gunakan toLocaleString dengan opsi untuk format Indonesia
                        formattedTimestamp = dateObj.toLocaleString('id-ID', {
                            day: '2-digit', month: '2-digit', year: 'numeric',
                            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                        }).replace(/\./g, ':'); // Mengganti titik pemisah waktu dengan :
                    }
                } catch (e) {
                    // Biarkan timestamp apa adanya jika parsing gagal
                }

                html += `<tr>
                    <td data-label="Waktu">${formattedTimestamp}</td>
                    <td data-label="Pengguna">${log.actorUsername || '-'}</td>
                    <td data-label="Peran Aktor">${log.actorRole || '-'}</td>
                    <td data-label="Jenis Aksi" style="word-break:break-word;">${log.actionType || '-'}</td>
                    <td data-label="Target Entitas" style="word-break:break-word;">${log.targetEntity || '-'}</td>
                    <td data-label="Detail" style="max-width: 250px; overflow-wrap: break-word; white-space: pre-wrap;">${log.details || '-'}</td>
                    <td data-label="Status">${log.status || '-'}</td>
                </tr>`;
            });
        } else {
            html = `<tr><td colspan="7" style="text-align:center; padding:20px;">Tidak ada aktivitas yang tercatat atau sesuai filter.</td></tr>`;
        }
        tableBody.innerHTML = html;
    }

    // Fungsi helper BARU untuk validasi format dd/mm/yyyy
    function isValidDDMMYYYY(dateString) {
        if (!dateString) return false; // Kosong tidak valid untuk fungsi ini, tapi bisa valid untuk filter
        const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
        if (!regex.test(dateString)) return false;
        const [, day, month, year] = regex.exec(dateString);
        const d = parseInt(day, 10);
        const m = parseInt(month, 10);
        const y = parseInt(year, 10);
        const dateObj = new Date(y, m - 1, d); // Month is 0-indexed
        return dateObj.getFullYear() === y && dateObj.getMonth() === m - 1 && dateObj.getDate() === d;
    }

    // Fungsi helper BARU untuk konversi dd/mm/yyyy ke yyyy-mm-dd
    function convertDDMMYYYYtoYYYYMMDD(ddmmyyyy) {
        if (!isValidDDMMYYYY(ddmmyyyy)) return null;
        const [day, month, year] = ddmmyyyy.split('/');
        return `${year}-${month}-${day}`;
    }

    function handleLogColumnSort(columnKey) {
        if (currentLogSortColumn === columnKey) {
            currentLogSortDirection = currentLogSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentLogSortColumn = columnKey;
            currentLogSortDirection = 'asc'; // Default ke 'asc' saat kolom baru dipilih, atau 'desc' jika preferensi
        }
        currentLogPage = 1; // Reset ke halaman pertama saat sortir diubah
        loadActivityLogWithFilters(); // Memuat ulang data dengan parameter sortir baru
    }

    function updateActivityLogHeaderSortIcons() {
        document.querySelectorAll('#activityLogTable th .sort-icon').forEach(icon => {
            icon.classList.remove('asc', 'desc');
            icon.textContent = ''; // Atau ikon default jika ada
        });
        const activeIcon = document.getElementById(`sortIcon-${currentLogSortColumn}`);
        if (activeIcon) {
            activeIcon.classList.add(currentLogSortDirection);
        }
    }
  
    // --- Add to renderView function ---
    // case 'overall_teacher_summary': // Add this case
    //     htmlFile = 'overall_summary_content.html';
    //     setupFunction = setupOverallSummaryView;
    //     break;

    // --- Add these new functions ---

    function navigateToOverallTeacherSummary() {
        if (loggedInUser && loggedInUser.role === ROLE_SUPERADMIN) {
            renderView('overall_teacher_summary');
        } else {
            showAlert("Akses ditolak. Fitur ini hanya untuk Superadmin.", "error");
        }
    }

    function setupOverallSummaryView() {
        const bulanSelect = document.getElementById('overallSummaryBulanSelect');
        const tahunSelect = document.getElementById('overallSummaryTahunSelect');

        // Populate year select (similar to other views)
        const currentYear = new Date().getFullYear();
        let minYearOverall = getYearFromMMYYYY(globalAdminMinMonthYear) || (currentYear - 2);
        let maxYearOverall = getYearFromMMYYYY(globalServerCurrentMonthYear) || currentYear;
        
        populateYearSelect('overallSummaryTahunSelect', minYearOverall, maxYearOverall, maxYearOverall);
        if (bulanSelect && globalServerCurrentMonthYear) {
            bulanSelect.value = getMonthStrFromMMYYYY(globalServerCurrentMonthYear);
        }
        validateMonthRange('overallSummaryBulanSelect', 'overallSummaryTahunSelect'); // Ensure validation logic is available

        // Set initial state for results area
        const resultsArea = document.getElementById('overallSummaryResultsArea');
        if(resultsArea) resultsArea.innerHTML = '<p style="text-align:center;"><i>Silakan pilih periode dan klik "Tampilkan Ringkasan".</i></p>';
        const periodDisplay = document.getElementById('overallSummaryPeriodDisplay');
        const totalWorkingDaysDisplay = document.getElementById('overallTotalWorkingDays');
        const effectiveDaysDisplay = document.getElementById('overallEffectiveDaysPassed');
        if(periodDisplay) periodDisplay.textContent = "-";
        if(totalWorkingDaysDisplay) totalWorkingDaysDisplay.textContent = "-";
        if(effectiveDaysDisplay) effectiveDaysDisplay.textContent = "-";

        window.scrollTo(0, 0);
    }

    // Variabel global untuk menyimpan data ringkasan yang sedang ditampilkan
    let currentOverallSummaryData = null;

    function openOverallSummaryDetailModal(title, detailsArray) {
        const modal = document.getElementById('overallSummaryDetailModal');
        const titleEl = document.getElementById('overallSummaryDetailTitle');
        const contentEl = document.getElementById('overallSummaryDetailContent');

        if (modal && titleEl && contentEl) {
            titleEl.textContent = title;
            if (detailsArray && detailsArray.length > 0) {
                let listHtml = '<ul>';
                detailsArray.forEach(item => {
                    listHtml += `<li>${item}</li>`;
                });
                listHtml += '</ul>';
                contentEl.innerHTML = listHtml;
            } else {
                contentEl.innerHTML = '<p style="text-align:center; font-style:italic;">Tidak ada detail untuk ditampilkan.</p>';
            }
            modal.style.display = 'flex';
        }
    }

    function closeOverallSummaryDetailModal() {
        const modal = document.getElementById('overallSummaryDetailModal');
        if (modal) {
            modal.style.display = 'none';
        }
        document.getElementById('overallSummaryDetailContent').innerHTML = ''; // Kosongkan konten
    }

    function loadOverallSummaryData() {
        const bulanSelect = document.getElementById('overallSummaryBulanSelect');
        const tahunSelect = document.getElementById('overallSummaryTahunSelect');
        const resultsArea = document.getElementById('overallSummaryResultsArea');
        const periodDisplay = document.getElementById('overallSummaryPeriodDisplay');
        const totalWorkingDaysDisplay = document.getElementById('overallTotalWorkingDays');
        const effectiveDaysDisplay = document.getElementById('overallEffectiveDaysPassed');

        if (!bulanSelect || !tahunSelect || !resultsArea || !periodDisplay || !totalWorkingDaysDisplay || !effectiveDaysDisplay) {
            showAlert("Elemen UI untuk ringkasan keseluruhan tidak ditemukan.", "error");
            return;
        }
        const selectedMonth = bulanSelect.value;
        const selectedYear = tahunSelect.value;
        if (!selectedMonth || !selectedYear) {
            showAlert("Pilih bulan dan tahun terlebih dahulu.", "warning");
            return;
        }
        if (bulanSelect.options[bulanSelect.selectedIndex] && bulanSelect.options[bulanSelect.selectedIndex].disabled) {
            showAlert("Bulan yang dipilih tidak valid untuk tahun ini.", "warning");
            return;
        }
        const monthYear = `${selectedMonth}/${selectedYear}`;

        showLoading("Memuat ringkasan keseluruhan guru...");
        resultsArea.innerHTML = '<p style="text-align:center;">Memuat data...</p>'; // Ganti dengan pesan loading tabel
        periodDisplay.textContent = monthYear;
        totalWorkingDaysDisplay.textContent = "Memuat...";
        effectiveDaysDisplay.textContent = "Memuat...";

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                if (response.success) {
                    currentOverallSummaryData = response.allTeachersSummary; // Simpan data untuk modal
                    
                    periodDisplay.textContent = response.monthYear || monthYear;
                    totalWorkingDaysDisplay.textContent = response.totalWorkingDaysInMonth !== undefined ? response.totalWorkingDaysInMonth : "-";
                    effectiveDaysDisplay.textContent = response.effectiveWorkingDaysPassed !== undefined ? response.effectiveWorkingDaysPassed : "-";

                    if (response.allTeachersSummary && response.allTeachersSummary.length > 0) {
                        let tableHtml = `
                            <table id="overallSummaryTable">
                                <thead>
                                    <tr>
                                        <th>Nama Guru</th>
                                        <th>Ceklok Terisi Lengkap</th>
                                        <th>Hadir (Jam Lengkap)</th>
                                        <th>Hari Libur Sekolah (Input Guru)</th>
                                        <th>Alasan Lain (Valid)</th>
                                        <th>Alpa</th>
                                        <th>Ceklok Tidak Lengkap</th>
                                        <th>Persentase Pengisian</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                        response.allTeachersSummary.forEach((teacher, index) => {
                            tableHtml += `<tr>
                                <td data-label="Nama Guru">${teacher.teacherName}</td>
                                <td data-label="Ceklok Terisi Lengkap" style="text-align:center;">${teacher.completedChecklokCount} hari</td>
                                <td data-label="Hadir (Jam Lengkap)">${teacher.presentDetails.length} hari 
                                    ${teacher.presentDetails.length > 0 ? `<button class="btn-detail-summary" onclick="showSummaryDetail(${index}, 'presentDetails', 'Hadir: ${teacher.teacherName}')">Detail</button>` : ''}
                                </td>
                                <td data-label="Hari Libur Sekolah (Input Guru)">${teacher.schoolHolidayDetails.length} hari
                                    ${teacher.schoolHolidayDetails.length > 0 ? `<button class="btn-detail-summary" onclick="showSummaryDetail(${index}, 'schoolHolidayDetails', 'Libur Sekolah (Input): ${teacher.teacherName}')">Detail</button>` : ''}
                                </td>
                                <td data-label="Alasan Lain (Valid)">${teacher.otherValidReasonDetails.length} hari
                                    ${teacher.otherValidReasonDetails.length > 0 ? `<button class="btn-detail-summary" onclick="showSummaryDetail(${index}, 'otherValidReasonDetails', 'Alasan Lain: ${teacher.teacherName}')">Detail</button>` : ''}
                                </td>
                                <td data-label="Alpa">${teacher.absentDetails.length} hari
                                    ${teacher.absentDetails.length > 0 ? `<button class="btn-detail-summary" onclick="showSummaryDetail(${index}, 'absentDetails', 'Alpa: ${teacher.teacherName}')">Detail</button>` : ''}
                                </td>
                                <td data-label="Ceklok Tidak Lengkap">${teacher.incompleteDetails.length} hari
                                    ${teacher.incompleteDetails.length > 0 ? `<button class="btn-detail-summary" onclick="showSummaryDetail(${index}, 'incompleteDetails', 'Tidak Lengkap: ${teacher.teacherName}')">Detail</button>` : ''}
                                </td>
                                <td data-label="Persentase Pengisian" style="text-align:center;">${teacher.attendancePercentage}%</td>
                            </tr>`;
                        });
                        tableHtml += `</tbody></table>`;
                        resultsArea.innerHTML = tableHtml;
                    } else if (response.message) {
                        resultsArea.innerHTML = `<p style="text-align:center;"><i>${response.message}</i></p>`;
                    } else {
                        resultsArea.innerHTML = '<p style="text-align:center;"><i>Tidak ada data ringkasan untuk ditampilkan.</i></p>';
                    }
                } else {
                    showAlert(response.error || "Gagal memuat ringkasan keseluruhan.", "error");
                    resultsArea.innerHTML = `<p style="text-align:center; color:red;">${response.error || "Gagal memuat data."}</p>`;
                    totalWorkingDaysDisplay.textContent = "-";
                    effectiveDaysDisplay.textContent = "-";
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showAlert(`Error server: ${err.message}`, "error");
                resultsArea.innerHTML = `<p style="text-align:center; color:red;">Error server: ${err.message}</p>`;
                totalWorkingDaysDisplay.textContent = "-";
                effectiveDaysDisplay.textContent = "-";
                currentOverallSummaryData = null; // Kosongkan jika error
            })
            .getOverallMonthlySummaryForAllTeachers(monthYear, loggedInUser.role);
    }

    // Fungsi baru untuk menampilkan detail di modal
    function showSummaryDetail(teacherIndex, detailType, titlePrefix) {
        if (currentOverallSummaryData && currentOverallSummaryData[teacherIndex] && currentOverallSummaryData[teacherIndex][detailType]) {
            const details = currentOverallSummaryData[teacherIndex][detailType];
            const teacherName = currentOverallSummaryData[teacherIndex].teacherName;
            let title = `${titlePrefix}`; // Title sudah mencakup nama guru dari argumen

            // Menyesuaikan judul jika diperlukan berdasarkan detailType
            // switch(detailType) {
            //     case 'presentDetails': title = `Detail Kehadiran (Jam Lengkap) - ${teacherName}`; break;
            //     case 'schoolHolidayDetails': title = `Detail Hari Libur Sekolah (Input Guru) - ${teacherName}`; break;
            //     case 'otherValidReasonDetails': title = `Detail Alasan Lain (Valid) - ${teacherName}`; break;
            //     case 'absentDetails': title = `Detail Alpa - ${teacherName}`; break;
            //     case 'incompleteDetails': title = `Detail Ceklok Tidak Lengkap - ${teacherName}`; break;
            // }
            openOverallSummaryDetailModal(title, details);
        } else {
            showAlert("Data detail tidak ditemukan.", "error");
        }
    }

    // --- JavaScript untuk Fitur Pengajuan Perubahan Username (GURU) ---
    function openRequestUsernameChangeModal() {
        if (!loggedInUser || loggedInUser.role !== ROLE_USER) {
            showAlert("Fitur ini hanya untuk guru.", "warning");
            return;
        }
        const currentUsernameEl = document.getElementById('currentUsernameForChangeRequest');
        const newUsernameInputEl = document.getElementById('requestedNewUsernameInput');
        const errorEl = document.getElementById('requestUsernameChangeError');
        const modal = document.getElementById('requestUsernameChangeModal');
        const submitButton = document.getElementById('btnSubmitUsernameChangeRequest');

        if (!modal || !currentUsernameEl || !newUsernameInputEl || !errorEl || !submitButton) {
            console.error("Elemen modal untuk pengajuan username tidak lengkap.");
            showAlert("Gagal membuka form pengajuan. Komponen tidak lengkap.", "error");
            return;
        }

        currentUsernameEl.textContent = loggedInUser.username;
        newUsernameInputEl.value = '';
        newUsernameInputEl.disabled = true; // Nonaktifkan input dulu selama pengecekan
        errorEl.textContent = '';
        errorEl.style.display = 'none';
        clearInputError(newUsernameInputEl);
        
        submitButton.disabled = true; // Nonaktifkan tombol submit selama pengecekan awal
        submitButton.textContent = "Memeriksa..."; // Teks tombol saat loading awal

        modal.style.display = 'flex'; // Tampilkan modalnya dulu
        showLoading("Memeriksa status pengajuan Anda..."); // Tampilkan spinner global

        google.script.run
            .withSuccessHandler(response => {
                hideLoading(); // Sembunyikan spinner global
                newUsernameInputEl.disabled = false; // Aktifkan input setelah pengecekan

                if (response.success && response.hasPendingRequest) {
                    showAlert("Anda sudah memiliki pengajuan perubahan username yang sedang diproses. Mohon tunggu.", "info");
                    newUsernameInputEl.disabled = true;
                    submitButton.disabled = true;
                    submitButton.textContent = "Pengajuan Diproses";
                    errorEl.textContent = "Anda sudah memiliki pengajuan yang sedang diproses. Mohon tunggu hingga selesai.";
                    errorEl.style.display = 'block';
                } else if (response.success && !response.hasPendingRequest) {
                    newUsernameInputEl.disabled = false;
                    newUsernameInputEl.focus();
                    submitButton.disabled = false;
                    submitButton.textContent = "Kirim Pengajuan";
                } else {
                    showAlert(response.error || "Gagal memeriksa status pengajuan. Silakan coba lagi nanti.", "error");
                    errorEl.textContent = response.error || "Gagal memeriksa status pengajuan. Silakan tutup dan coba lagi.";
                    errorEl.style.display = 'block';
                    newUsernameInputEl.disabled = true;
                    submitButton.disabled = true;
                    submitButton.textContent = "Error";
                }
            })
            .withFailureHandler(err => {
                hideLoading(); // Sembunyikan spinner global
                newUsernameInputEl.disabled = true;
                submitButton.disabled = true;
                submitButton.textContent = "Error";
                showAlert("Error server saat memeriksa status pengajuan: " + err.message, "error");
                errorEl.textContent = "Error server. Silakan tutup dan coba lagi.";
                errorEl.style.display = 'block';
            })
            .checkUserPendingUsernameRequest(loggedInUser.username);
    }

    function closeRequestUsernameChangeModal() {
        const modal = document.getElementById('requestUsernameChangeModal');
        if (modal) modal.style.display = 'none';
    }

    function handleSubmitUsernameChangeRequest() {
        const newUsernameInputEl = document.getElementById('requestedNewUsernameInput');
        const errorEl = document.getElementById('requestUsernameChangeError');
        const submitButton = document.getElementById('btnSubmitUsernameChangeRequest'); // Ambil tombol submit
        
        if (!newUsernameInputEl || !errorEl || !submitButton) {
            console.error("Elemen form pengajuan username tidak lengkap saat submit.");
            showAlert("Gagal mengirim pengajuan. Komponen form hilang.", "error");
            return;
        }
        const newUsername = newUsernameInputEl.value.trim();

        clearInputError(newUsernameInputEl);
        errorEl.style.display = 'none';

        if (!newUsername) {
            errorEl.textContent = "Username baru tidak boleh kosong.";
            errorEl.style.display = 'block'; showInputError(newUsernameInputEl); return;
        }
        if (newUsername.length < 4) {
            errorEl.textContent = "Username baru minimal 4 karakter.";
            errorEl.style.display = 'block'; showInputError(newUsernameInputEl); return;
        }
        if (newUsername.toLowerCase() === loggedInUser.username.toLowerCase()) {
            errorEl.textContent = "Username baru tidak boleh sama dengan username Anda saat ini.";
            errorEl.style.display = 'block'; showInputError(newUsernameInputEl); return;
        }
        if (!/^[a-zA-Z0-9_]+$/.test(newUsername)) {
            errorEl.textContent = "Username baru hanya boleh berisi huruf, angka, dan underscore (_).";
            errorEl.style.display = 'block'; showInputError(newUsernameInputEl); return;
        }

        showLoading("Mengirim pengajuan perubahan username..."); // Tampilkan spinner global
        submitButton.disabled = true; // Nonaktifkan tombol selama proses kirim
        submitButton.textContent = "Mengirim...";

        google.script.run
            .withSuccessHandler(response => {
                hideLoading(); // Sembunyikan spinner global
                if (response.success) {
                    showAlert(response.message, "success");
                    closeRequestUsernameChangeModal();
                } else {
                    errorEl.textContent = response.error || "Gagal mengirim pengajuan.";
                    errorEl.style.display = 'block';
                    submitButton.disabled = false; // Aktifkan kembali jika gagal
                    submitButton.textContent = "Kirim Pengajuan";
                }
            })
            .withFailureHandler(err => {
                hideLoading(); // Sembunyikan spinner global
                errorEl.textContent = "Error server: " + err.message;
                errorEl.style.display = 'block';
                submitButton.disabled = false; // Aktifkan kembali jika gagal
                submitButton.textContent = "Kirim Pengajuan";
            })
            .submitUsernameChangeRequest(loggedInUser.username, newUsername, loggedInUser.teacherName, loggedInUser.role);
    }


    function navigateToUsernameChangeRequests() {
        if (loggedInUser && (loggedInUser.role === ROLE_ADMIN || loggedInUser.role === ROLE_SUPERADMIN)) {
            renderView('username_requests_view');
        } else {
            showAlert("Akses ditolak.", "error");
        }
    }

    function setupUsernameRequestsView() {
        window.scrollTo(0, 0);
        const tableBody = document.getElementById('usernameRequestsTableBody');
        if (tableBody) tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Memuat pengajuan...</td></tr>';

        showLoading("Memuat daftar pengajuan...");
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                if (response.success) {
                    renderUsernameRequestsTable(response.requests);
                } else {
                    if (tableBody) tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">${response.error || 'Gagal memuat data.'}</td></tr>`;
                    showAlert(response.error || "Gagal memuat pengajuan.", "error");
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                if (tableBody) tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Error server: ${err.message}</td></tr>`;
                showAlert("Error server: " + err.message, "error");
            })
            .getPendingUsernameChangeRequests(loggedInUser.username, loggedInUser.role);
    }

    function renderUsernameRequestsTable(requests) {
        const tableBody = document.getElementById('usernameRequestsTableBody');
        if (!tableBody) return;
        let html = '';
        if (requests && requests.length > 0) {
            requests.forEach(req => {
                html += `<tr>
                    <td data-label="ID">${req.requestID.substring(0,8)}...</td>
                    <td data-label="Username Saat Ini">${req.currentUsername}</td>
                    <td data-label="Nama Guru">${req.teacherName}</td>
                    <td data-label="Username Baru">${req.requestedUsername}</td>
                    <td data-label="Tgl. Pengajuan">${req.requestDate}</td>
                    <td data-label="Aksi" class="actions-cell">
                        <button class="btn-success" onclick="promptForUsernameRequestNotes('${req.requestID}', 'approve', 'Setujui Pengajuan ${req.requestedUsername}?')">Setujui</button>
                        <button class="btn-danger" onclick="promptForUsernameRequestNotes('${req.requestID}', 'reject', 'Tolak Pengajuan ${req.requestedUsername}?')">Tolak</button>
                    </td>
                </tr>`;
            });
        } else {
            html = '<tr><td colspan="6" style="text-align:center;">Tidak ada pengajuan perubahan username yang pending.</td></tr>';
        }
        tableBody.innerHTML = html;
    }

    function promptForUsernameRequestNotes(requestID, action, modalTitle) {
        document.getElementById('processRequestIdHidden').value = requestID;
        document.getElementById('processRequestActionHidden').value = action;
        document.getElementById('usernameRequestNotesTitle').textContent = modalTitle;
        document.getElementById('adminNotesForUsernameRequest').value = ''; // Kosongkan catatan
        document.getElementById('usernameRequestNotesModal').style.display = 'flex';
    }

    function closeUsernameRequestNotesModal() {
        document.getElementById('usernameRequestNotesModal').style.display = 'none';
    }

    function submitProcessUsernameRequestWithNotes() {
        const requestID = document.getElementById('processRequestIdHidden').value;
        const action = document.getElementById('processRequestActionHidden').value;
        const notes = document.getElementById('adminNotesForUsernameRequest').value.trim();
        
        closeUsernameRequestNotesModal(); // Tutup modal dulu
        handleProcessUsernameRequest(requestID, action, notes);
    }

    function handleProcessUsernameRequest(requestID, action, notes = "") {
        const confirmMsg = action === 'approve' ? 
            `Anda yakin ingin MENYETUJUI pengajuan perubahan username dengan ID: ${requestID.substring(0,8)}...? Pengguna mungkin perlu login ulang.` :
            `Anda yakin ingin MENOLAK pengajuan perubahan username dengan ID: ${requestID.substring(0,8)}...?`;

        if (!confirm(confirmMsg)) return;

        showLoading("Memproses pengajuan...");
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                if (response.success) {
                    showAlert(response.message, "success");
                    setupUsernameRequestsView(); // Muat ulang daftar
                } else {
                    showAlert(response.error || "Gagal memproses pengajuan.", "error");
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                showAlert("Error server: " + err.message, "error");
            })
            .processUsernameChangeRequest(requestID, action, loggedInUser.username, loggedInUser.role, notes);
    }

    function openSummaryDetailModal(title, items, itemType) { // itemType: 'absent' atau 'incomplete'
        const modal = document.getElementById('summaryDetailModal');
        const modalTitle = document.getElementById('summaryDetailModalTitle');
        const modalBody = document.getElementById('summaryDetailModalBody');

        if (!modal || !modalTitle || !modalBody) {
            showAlert("Komponen modal detail tidak ditemukan.", "error");
            return;
        }

        modalTitle.textContent = title;
        let listHtml = '<ul>';
        if (items && items.length > 0) {
            items.forEach(item => {
                if (itemType === 'absent') {
                    // Item adalah string tanggal "dd/MM/yyyy"
                    listHtml += `<li><span class="modal-item-date" onclick="navigateToCeklokDate('${item}')">${item}</span></li>`;
                } else if (itemType === 'incomplete') {
                    // Item adalah objek { date: "dd/MM/yyyy", missing: "Keterangan" }
                    const fieldToFocus = item.missing.toLowerCase().includes("masuk") ? 'jamMasuk' : 'jamPulang';
                    listHtml += `<li><span class="modal-item-date" onclick="navigateToCeklokDate('${item.date}', '${fieldToFocus}')">${item.date}</span>: ${item.missing}</li>`;
                }
            });
        } else {
            listHtml += '<li>Tidak ada data untuk ditampilkan.</li>';
        }
        listHtml += '</ul>';
        modalBody.innerHTML = listHtml;
        modal.style.display = 'flex';
    }

    // BARU: Fungsi untuk menutup modal detail ringkasan
    function closeSummaryDetailModal() {
        const modal = document.getElementById('summaryDetailModal');
        if (modal) {
            modal.style.display = 'none';
        }
        const modalBody = document.getElementById('summaryDetailModalBody');
        if(modalBody) modalBody.innerHTML = ''; // Kosongkan isi modal
    }

    /**
     * (VERSI BARU) Menavigasi ke tabel ceklok lalu menyorot tanggal tertentu.
     * Dipanggil dari modal ringkasan di dasbor.
     */
    function navigateToCeklokDate(dateString, fieldToFocus = null) {
        closeSummaryDetailModal(); // Tutup modal dulu

        // 1. Dapatkan periode (bulan/tahun) dari tanggal yang diklik
        const dateParts = dateString.split('/');
        if (dateParts.length !== 3) {
            showAlert("Format tanggal tidak valid untuk navigasi.", "error");
            return;
        }
        const monthYearToLoad = `${dateParts[1]}/${dateParts[2]}`;

        // 2. Periksa apakah pengguna sudah berada di halaman & periode yang benar
        const isOnCeklokTable = document.getElementById('ceklokTableBody');
        if (isOnCeklokTable && activeCeklokMonthYear === monthYearToLoad) {
            // Jika sudah benar, langsung panggil fungsi sorot
            findAndHighlightDateRow(dateString, fieldToFocus);
        } else {
            // Jika belum, muat halaman ceklok terlebih dahulu,
            // lalu panggil fungsi sorot sebagai callback setelah selesai.
            if (loggedInUser && loggedInUser.teacherName) {
                loadCeklokDataFromServer(
                    loggedInUser.teacherName, 
                    monthYearToLoad, 
                    true, // true karena ini adalah aksi dari guru (user)
                    () => {
                        // Ini adalah callback yang akan dijalankan SETELAH tabel dimuat
                        findAndHighlightDateRow(dateString, fieldToFocus);
                    }
                );
            } else {
                showAlert("Sesi pengguna tidak valid untuk navigasi.", "error");
            }
        }
    }

    // Fungsi baru untuk navigasi ke halaman "Cek Data Kehadiran"
    function navigateToCekDataKehadiran() {
        if (loggedInUser && loggedInUser.role === ROLE_USER) {
            renderView('cek_data_kehadiran'); // Nama view baru
        } else {
            showAlert("Fitur ini hanya untuk guru.", "error");
        }
    }

    // Setup function untuk halaman baru
    function setupCekDataKehadiranView() {
        window.scrollTo(0, 0);
        const teacherNameEl = document.getElementById('cdkTeacherName');
        const yearSelectEl = document.getElementById('cdkYearSelect');
        const calendarContainerEl = document.getElementById('cdkYearlyCalendarContainer');

        if (teacherNameEl) {
            teacherNameEl.textContent = loggedInUser.teacherName || "Tidak Diketahui";
        }

        if (yearSelectEl) {
            const currentYear = new Date().getFullYear();
            // Menggunakan globalAdminMinMonthYear untuk batas bawah tahun
            let minYear;
            if (globalAdminMinMonthYear && globalAdminMinMonthYear.includes('/')) {
                minYear = parseInt(globalAdminMinMonthYear.split('/')[1]);
            } else {
                minYear = currentYear - 5; // Fallback
            }
            
            yearSelectEl.innerHTML = ''; // Kosongkan opsi lama
            for (let y = currentYear; y >= minYear; y--) {
                let option = new Option(y, y);
                yearSelectEl.add(option);
            }
            if (yearSelectEl.options.length > 0) {
              yearSelectEl.value = currentYear; // Default ke tahun ini
            } else {
                showAlert("Tidak ada tahun yang valid untuk dipilih.", "warning");
                document.getElementById('btnCdkCekData').disabled = true;
            }
        }
        if(calendarContainerEl) calendarContainerEl.innerHTML = '<p style="text-align:center; color: var(--grey-text);"><i>Pilih tahun dan klik "CEK DATA" untuk melihat rekap kehadiran.</i></p>';
    }


    function fetchAndDisplayYearlyAttendance() {
        const selectedYear = document.getElementById('cdkYearSelect').value;
        const teacherName = loggedInUser.teacherName; 
        const calendarContainerEl = document.getElementById('cdkYearlyCalendarContainer');
        const loadingEl = document.getElementById('cdkLoadingIndicator');
        const errorEl = document.getElementById('cdkErrorMessage');

        if (!selectedYear) {
            showAlert("Silakan pilih tahun terlebih dahulu.", "warning");
            return;
        }

        calendarContainerEl.innerHTML = ''; 
        if(loadingEl) loadingEl.style.display = 'block';
        if(errorEl) errorEl.style.display = 'none';

        google.script.run
            .withSuccessHandler(response => {
                if(loadingEl) loadingEl.style.display = 'none';
                if (response.success && response.yearData) {
                    renderYearlyCalendar(response.yearData, parseInt(selectedYear));
                } else {
                    if(errorEl) {
                        errorEl.textContent = response.error || "Gagal memuat data kehadiran tahunan.";
                        errorEl.style.display = 'block';
                    }
                    showAlert(response.error || "Gagal memuat data.", "error");
                }
            })
            .withFailureHandler(err => {
                if(loadingEl) loadingEl.style.display = 'none';
                if(errorEl) {
                    errorEl.textContent = "Terjadi kesalahan server: " + err.message;
                    errorEl.style.display = 'block';
                }
                showAlert("Error server: " + err.message, "error");
            })
            .getYearlyAttendanceData(teacherName, parseInt(selectedYear));
    }

    function renderYearlyCalendar(yearData, year) {
        const calendarContainerEl = document.getElementById('cdkYearlyCalendarContainer');
        calendarContainerEl.innerHTML = ''; 

        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", 
                            "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const dayHeaders = ["Sen", "Sel", "Rab", "Kam", "Jum", "Sab", "Min"];

        monthNames.forEach((monthName, monthIndex) => { 
            const monthDataForDisplay = yearData[monthName];
            
            const monthContainer = document.createElement('div');
            monthContainer.className = 'cdk-month-container';
            monthContainer.innerHTML = `<h4>${monthName} ${year}</h4>`;

            const daysGrid = document.createElement('div');
            daysGrid.className = 'cdk-days-grid';

            dayHeaders.forEach(header => {
                const dayHeaderEl = document.createElement('div');
                dayHeaderEl.className = 'cdk-day-header';
                dayHeaderEl.textContent = header;
                daysGrid.appendChild(dayHeaderEl);
            });
            
            let firstDayOfMonth = new Date(year, monthIndex, 1).getDay(); 
            let dayOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; 

            for (let i = 0; i < dayOffset; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'cdk-day-cell empty-offset';
                daysGrid.appendChild(emptyCell);
            }

            if (monthDataForDisplay && monthDataForDisplay.length > 0) {
                monthDataForDisplay.forEach(dayEntry => {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'cdk-day-cell';
                    if (dayEntry.isNonWorkingScheduled) {
                        dayCell.classList.add('is-non-working-scheduled');
                    }

                    const dateNumber = document.createElement('span');
                    dateNumber.className = 'cdk-date-number';
                    dateNumber.textContent = dayEntry.date;
                    dayCell.appendChild(dateNumber);

                    const statusDot = document.createElement('span');
                    statusDot.className = `cdk-status-dot ${dayEntry.status}`;
                    
                    // Tambahkan event listener jika status bukan 'white'
                    if (dayEntry.status !== 'white') {
                        statusDot.classList.add('clickable');
                        const dateForModal = `${String(dayEntry.date).padStart(2, '0')}/${String(monthIndex + 1).padStart(2, '0')}/${year}`;
                        let statusTextForModal = "";
                        switch(dayEntry.status) {
                            case "green": statusTextForModal = "Hadir"; break;
                            case "yellow": statusTextForModal = "Tidak Lengkap"; break;
                            case "red": statusTextForModal = "Alpa"; break;
                            case "blue": statusTextForModal = "Hari Libur/Keterangan"; break;
                            default: statusTextForModal = "Info";
                        }
                        statusDot.onclick = function() {
                            openCdkDetailModal(dateForModal, statusTextForModal, dayEntry.detailMessage);
                        };
                    }
                    dayCell.appendChild(statusDot);
                    daysGrid.appendChild(dayCell);
                });
            } else {
                const daysInCurrentMonth = new Date(year, monthIndex + 1, 0).getDate();
                for(let d = 1; d <= daysInCurrentMonth; d++){
                    const dayCell = document.createElement('div');
                    dayCell.className = 'cdk-day-cell';
                    const dateNumberSpan = document.createElement('span');
                    dateNumberSpan.className = 'cdk-date-number';
                    dateNumberSpan.textContent = d;
                    dayCell.appendChild(dateNumberSpan);
                    const statusDotSpan = document.createElement('span');
                    statusDotSpan.className = `cdk-status-dot white`; 
                    dayCell.appendChild(statusDotSpan);
                    daysGrid.appendChild(dayCell);
                }
            }
            monthContainer.appendChild(daysGrid);
            calendarContainerEl.appendChild(monthContainer);
        });
    }

    // Fungsi baru untuk menampilkan modal detail Cek Data Kehadiran
    function openCdkDetailModal(dateString, statusText, detailMessage) {
        const modal = document.getElementById('cdkDetailModal');
        const modalTitle = document.getElementById('cdkDetailModalTitle');
        const modalDateEl = document.getElementById('cdkDetailModalDate');
        const modalBody = document.getElementById('cdkDetailModalBody');

        if (!modal || !modalTitle || !modalDateEl || !modalBody) {
            showAlert("Komponen modal detail CDK tidak ditemukan.", "error");
            return;
        }

        modalTitle.textContent = `Detail Kehadiran - ${statusText}`;
        modalDateEl.textContent = `Tanggal: ${dateString}`;
        modalBody.textContent = detailMessage;
        
        modal.style.display = 'flex';
    }

    // Fungsi baru untuk menutup modal detail Cek Data Kehadiran
    function closeCdkDetailModal() {
        const modal = document.getElementById('cdkDetailModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Fungsi untuk memuat dan menampilkan daftar bulan yang terkunci
    // di dashboard admin. (Letakkan di dalam tag <script> di index.html)
    function loadLockedMonthsForAdminDisplay() {
        const displayDiv = document.getElementById('lockedMonthsDisplay');
        if (!displayDiv) {
            console.error("Elemen 'lockedMonthsDisplay' tidak ditemukan.");
            return;
        }

        displayDiv.innerHTML = '<i>Memuat daftar bulan terkunci...</i>';
        // Tidak perlu showLoading() global jika hanya memuat bagian kecil ini,
        // kecuali jika prosesnya dirasa cukup lama.

        google.script.run
            .withSuccessHandler(response => {
                if (response.success) {
                    const lockedMonths = response.months;
                    if (lockedMonths && lockedMonths.length > 0) {
                        // Sortir bulan, misalnya dari yang terbaru
                        lockedMonths.sort((a, b) => {
                            const [m1, y1] = a.split('/').map(Number);
                            const [m2, y2] = b.split('/').map(Number);
                            if (y1 !== y2) return y2 - y1;
                            return m2 - m1;
                        });

                        let html = '<ul style="list-style-type: none; padding-left: 0; margin-top:0;">';
                        lockedMonths.forEach(monthYear => {
                            html += `<li style="padding: 6px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                                       <span>${monthYear}</span>
                                       <button onclick="handleUnlockThisMonth('${monthYear}')" class="btn-danger" style="font-size:0.85em; padding:4px 8px; margin-left:10px;">Buka Kunci</button>
                                     </li>`;
                        });
                        html += '</ul>';
                        displayDiv.innerHTML = html;
                    } else {
                        displayDiv.innerHTML = '<p style="text-align:center; color: #555; font-style:italic;">Tidak ada bulan yang terkunci saat ini.</p>';
                    }
                } else {
                    displayDiv.innerHTML = `<p style="color:red;">Gagal memuat daftar: ${response.error}</p>`;
                    // showAlert(response.error || "Gagal memuat daftar bulan terkunci.", 'error'); // Opsional, tergantung preferensi notifikasi
                }
            })
            .withFailureHandler(err => {
                displayDiv.innerHTML = `<p style="color:red;">Error server: ${err.message}</p>`;
                // showAlert(`Error server: ${err.message}`, 'error'); // Opsional
            })
            .getLockedMonths();
    }

    // Fungsi untuk menampilkan dialog konfirmasi sebelum mereset log aktivitas
    function confirmResetActivityLog(timeframeIdentifier) {
        let message = "Apakah Anda yakin ingin menghapus log aktivitas";
        let timeframeText = "";

        switch (timeframeIdentifier) {
            case 'today': timeframeText = "yang dibuat HARI INI"; break;
            case 'yesterday': timeframeText = "yang dibuat KEMARIN"; break;
            case 'older_than_3_days': timeframeText = "yang berumur 3 HARI ATAU LEBIH LAMA"; break;
            case 'older_than_5_days': timeframeText = "yang berumur 5 HARI ATAU LEBIH LAMA"; break;
            case 'older_than_1_week': timeframeText = "yang berumur 1 MINGGU ATAU LEBIH LAMA"; break;
            case 'older_than_3_weeks': timeframeText = "yang berumur 3 MINGGU ATAU LEBIH LAMA"; break;
            case 'older_than_1_month': timeframeText = "yang berumur 1 BULAN ATAU LEBIH LAMA"; break;
            case 'older_than_3_months': timeframeText = "yang berumur 3 BULAN ATAU LEBIH LAMA"; break;
            case 'older_than_6_months': timeframeText = "yang berumur 6 BULAN ATAU LEBIH LAMA"; break;
            case 'older_than_9_months': timeframeText = "yang berumur 9 BULAN ATAU LEBIH LAMA"; break;
            case 'older_than_1_year': timeframeText = "yang berumur 1 TAHUN ATAU LEBIH LAMA"; break;
            case 'all': timeframeText = "SEMUA LOG AKTIVITAS"; break;
            default:
                // Menggunakan customAlert yang sudah ada di proyek Anda
                if (typeof customAlert === "function") {
                    customAlert("Periode reset tidak dikenal.", "error");
                } else {
                    alert("Periode reset tidak dikenal."); // Fallback ke alert standar
                }
                return;
        }

        message += ` ${timeframeText}? Tindakan ini permanen dan tidak dapat diurungkan.`;

        // Menggunakan customConfirm yang sudah ada di proyek Anda
        if (typeof customConfirm === "function") {
            customConfirm(message, function(isConfirmed) {
                if (isConfirmed) {
                    performResetActivityLog(timeframeIdentifier);
                }
            });
        } else { // Fallback ke confirm standar jika customConfirm tidak ada
            if (confirm(message)) {
                performResetActivityLog(timeframeIdentifier);
            }
        }
    }

    // Fungsi untuk memanggil backend dan melakukan reset log aktivitas
    function performResetActivityLog(timeframeIdentifier) {
        showLoading("Sedang mereset log aktivitas..."); // Asumsi showLoading sudah ada
        google.script.run
            .withSuccessHandler(response => {
                hideLoading(); // Asumsi hideLoading sudah ada
                if (response.success) {
                    // Menggunakan customAlert yang sudah ada
                    if (typeof customAlert === "function") {
                        customAlert(response.message || "Log aktivitas berhasil direset.", "success");
                    } else {
                        alert(response.message || "Log aktivitas berhasil direset.");
                    }
                    
                    // Muat ulang data log untuk melihat perubahan
                    // Panggil fungsi yang sesuai untuk memuat ulang tabel log Anda
                    if (typeof loadActivityLogData === "function") { // Jika Anda punya fungsi spesifik ini
                        loadActivityLogData();
                    } else if (typeof loadActivityLogWithFilters === "function") { // Atau fungsi ini
                        loadActivityLogWithFilters();
                    } else {
                        // Jika tidak ada fungsi spesifik, mungkin render ulang view activity_log
                        renderView('activity_log');
                    }
                } else {
                    if (typeof customAlert === "function") {
                        customAlert(response.error || "Gagal mereset log aktivitas.", "error");
                    } else {
                        alert(response.error || "Gagal mereset log aktivitas.");
                    }
                }
            })
            .withFailureHandler(err => {
                hideLoading();
                if (typeof customAlert === "function") {
                    customAlert(`Error server saat mereset log: ${err.message}`, "error");
                } else {
                    alert(`Error server saat mereset log: ${err.message}`);
                }
            })
            .resetActivityLog(timeframeIdentifier); // Memanggil fungsi di Google Apps Script
    }

    function toggleExcelExportSection(triggerButton) {
        const content = triggerButton.nextElementSibling;
        const arrowIcon = triggerButton.querySelector('.arrow-icon');

        if (!content || !arrowIcon) {
            console.error("Element collapsible atau arrow icon tidak ditemukan.");
            return;
        }

        if (content.style.display === "none" || content.style.display === "") {
            content.style.display = "block";
            arrowIcon.classList.remove('down');
            arrowIcon.classList.add('up');
        } else {
            content.style.display = "none";
            arrowIcon.classList.remove('up');
            arrowIcon.classList.add('down');
        }
    }

    /**
     * Menampilkan pop-up pengingat di akhir bulan.
     * LOGIKA BARU: Pop-up hanya akan ditampilkan sekali per sesi login menggunakan sessionStorage.
     */
    function showEndOfMonthReminder() {
      // --- PERUBAHAN 1: Cek sessionStorage di awal ---
      // Jika pengingat sudah ditampilkan di sesi ini, jangan jalankan sisa fungsi.
      if (sessionStorage.getItem('reminderShownForSession') === 'true') {
        console.log("Pengingat akhir bulan sudah ditampilkan pada sesi ini. Melewatkan.");
        return;
      }

      console.log("Mencoba menjalankan showEndOfMonthReminder (pengecekan sesi lolos)...");

      // Periksa apakah pengguna sudah login
      if (!loggedInUser) {
        console.log("Pengingat dibatalkan: Pengguna belum login.");
        return;
      }

      const today = new Date();
      const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
      const currentDay = today.getDate();
      const reminderStartDate = lastDayOfMonth - 6; // Pengingat mulai 7 hari sebelum akhir bulan

      if (currentDay >= reminderStartDate) {
        console.log("Kondisi tanggal TERPENUHI. Menyiapkan pesan...");
        
        const daysRemaining = lastDayOfMonth - currentDay;
        let reminderMessage = '';
        if (daysRemaining > 1) {
          reminderMessage = `Tinggal ${daysRemaining} hari lagi untuk menyelesaikan pengisian ceklok bulan ini. Mohon segera lengkapi data Anda.`;
        } else if (daysRemaining === 1) {
          reminderMessage = `Besok adalah HARI TERAKHIR untuk melengkapi pengisian ceklok bulan ini. Segera selesaikan!`;
        } else { // daysRemaining === 0
          reminderMessage = `Ini adalah HARI TERAKHIR untuk melengkapi pengisian ceklok bulan ini. Segera selesaikan!`;
        }

        const reminderTextEl = document.getElementById('reminderText');
        const reminderModalEl = document.getElementById('reminderModal');

        if (reminderTextEl && reminderModalEl) {
          console.log("MENAMPILKAN POP-UP PENGINGAT.");
          reminderTextEl.innerText = reminderMessage;
          reminderModalEl.style.display = 'flex';

          // --- PERUBAHAN 2: Set sessionStorage setelah tampil ---
          // Tandai bahwa pengingat sudah ditampilkan untuk sesi ini.
          try {
            sessionStorage.setItem('reminderShownForSession', 'true');
            console.log("Flag 'reminderShownForSession' telah diatur di sessionStorage.");
          } catch (e) {
            console.error("Gagal menyimpan flag pengingat ke sessionStorage:", e);
          }
        } else {
          console.error("Elemen modal (#reminderModal atau #reminderText) tidak ditemukan di DOM.");
        }
      } else {
        console.log("Kondisi tanggal TIDAK TERPENUHI. Tidak ada pop-up yang ditampilkan.");
      }
    }

    // Event listener untuk tombol 'Mengerti' pada modal.
    // Pastikan ini berjalan setelah DOM siap.
    document.addEventListener('DOMContentLoaded', (event) => {
        const closeButton = document.getElementById('closeReminderModal');
        const reminderModal = document.getElementById('reminderModal');
        if (closeButton && reminderModal) {
            closeButton.addEventListener('click', () => {
                reminderModal.style.display = 'none';
            });
        }
    });

    /**
     * Menyiapkan tampilan dashboard untuk pengguna (guru).
     */
    function setupUserDashboardView() {
        window.scrollTo(0, 0);
        const guruNameEl = document.getElementById('dashboard-guru-name');
        if (guruNameEl && loggedInUser) {
            guruNameEl.textContent = loggedInUser.teacherName;
        }

        // --- TAMBAHKAN KODE INI ---
        const greetingSpan = document.getElementById('time-based-greeting');
        if (greetingSpan) {
            const now = new Date();
            const hour = now.getHours();
            let greeting = 'Selamat Datang'; // Default

            if (hour >= 3 && hour < 10) {
                greeting = 'Selamat Pagi';
            } else if (hour >= 10 && hour < 15) {
                greeting = 'Selamat Siang';
            } else if (hour >= 15 && hour < 19) {
                greeting = 'Selamat Sore';
            } else {
                greeting = 'Selamat Malam';
            }
            greetingSpan.textContent = greeting;
        }
        // --- AKHIR KODE TAMBAHAN ---

        // Panggil fungsi yang sudah ada untuk menyiapkan dan memuat periode
        setupDashboardPeriodSelector();

        // Panggil fungsi lazy loading setelah view di-render
        setupLazyLoadGifs(); // <-- PEMANGGILAN FUNGSI BARU

        // Tampilkan pop-up pengingat jika memenuhi syarat
        if (typeof showEndOfMonthReminder === 'function') {
            setTimeout(showEndOfMonthReminder, 100);
        }
    }

    /**
     * Menavigasikan pengguna dari dashboard ke halaman pengisian ceklok.
     */
    function navigateToCeklokTable() {
        if (loggedInUser && loggedInUser.teacherName) {
            const monthToLoad = activeCeklokMonthYear || globalServerCurrentMonthYear;
            if (monthToLoad) {
                // Fungsi ini sudah ada dan akan memuat serta merender tabel isian ceklok
                loadCeklokDataFromServer(loggedInUser.teacherName, monthToLoad, true); // true menandakan ini adalah view untuk guru
            } else {
                showAlert("Periode ceklok default tidak dapat ditentukan.", "error");
            }
        } else {
            showAlert("Informasi sesi pengguna tidak lengkap.", "error");
            logout();
        }
    }

    /**
     * Fungsi helper untuk mencari dan menyorot baris tanggal di tabel ceklok.
     * Dipanggil setelah tabel ceklok dijamin sudah termuat.
     */
    function findAndHighlightDateRow(dateString, fieldToFocus) {
        const tableBody = document.getElementById('ceklokTableBody');
        if (!tableBody || !dataTanggal || dataTanggal.length === 0) {
            // Cek ini sebagai fallback, seharusnya tidak terjadi jika alur benar
            showAlert("Tabel ceklok tidak termuat atau kosong setelah navigasi.", "warning");
            return;
        }

        let targetRowIndex = -1;
        for (let i = 0; i < dataTanggal.length; i++) {
            if (dataTanggal[i].tanggal === dateString) {
                targetRowIndex = i;
                break;
            }
        }

        if (targetRowIndex !== -1) {
            let inputIdToFocus;
            if (fieldToFocus) {
                inputIdToFocus = `${fieldToFocus}${targetRowIndex}`; // Misal: jamMasuk0, jamPulang0
            } else {
                inputIdToFocus = `jamMasuk${targetRowIndex}`;
            }
            
            const inputElement = document.getElementById(inputIdToFocus);
            if (inputElement) {
                if(!inputElement.disabled) {
                    inputElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => {
                        inputElement.focus();
                        inputElement.select();
                        const originalBg = inputElement.style.backgroundColor;
                        inputElement.style.backgroundColor = 'var(--warning-hover)';
                        setTimeout(() => {
                            inputElement.style.backgroundColor = originalBg;
                        }, 1500);
                    }, 300);
                } else {
                    const parentRow = inputElement.closest('tr');
                    if(parentRow) {
                        parentRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        const originalBg = parentRow.style.backgroundColor;
                        parentRow.style.backgroundColor = 'var(--warning-hover)'; 
                        setTimeout(() => {
                            parentRow.style.backgroundColor = originalBg;
                        }, 1500);
                    }
                    showAlert(`Input untuk ${dateString} tidak dapat diisi karena ada keterangan lain.`, "info");
                }
            } else {
                const rows = tableBody.getElementsByTagName('tr');
                if (rows[targetRowIndex]) {
                    rows[targetRowIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        } else {
            showAlert(`Tanggal ${dateString} tidak ditemukan dalam data ceklok saat ini.`, "warning");
        }
    }

    /**
     * Mengarahkan pengguna kembali ke halaman dasbor guru.
     * Fungsi ini dipanggil dari halaman rekap atau kalender tahunan.
     */
    function goBackToUserDashboard() {
        if (loggedInUser && (loggedInUser.role === 'user' || loggedInUser.role === 'admin' || loggedInUser.role === 'superadmin')) {
            // Render view 'user_dashboard' yang akan memanggil setupUserDashboardView
            // untuk memuat ulang ringkasan.
            renderView('user_dashboard');
        } else {
            // Fallback jika sesi tidak valid
            logout();
        }
    }

    /**
     * Memuat ulang data ringkasan di dasbor berdasarkan periode yang dipilih
     * dari dropdown baru.
     */
    function loadDashboardSummaryForSelectedPeriod() {
        const bulanSelect = document.getElementById('summaryBulanSelect');
        const tahunSelect = document.getElementById('summaryTahunSelect');
        
        if (!bulanSelect || !tahunSelect) {
            showAlert("Elemen pemilih periode tidak ditemukan.", "error");
            return;
        }

        const selectedMonthYear = `${bulanSelect.value}/${tahunSelect.value}`;

        if (loggedInUser && loggedInUser.teacherName) {
            // Panggil kembali fungsi yang sudah ada untuk memuat ringkasan
            loadAndDisplayTeacherSummary(loggedInUser.teacherName, selectedMonthYear);
        } else {
            showAlert("Sesi pengguna tidak valid.", "error");
        }
    }

    /**
     * Mengisi dropdown periode di dasbor dan memuat data awal.
     * Ini dipanggil saat setupUserDashboardView dijalankan.
     */
    function setupDashboardPeriodSelector() {
        const bulanSelect = document.getElementById('summaryBulanSelect');
        const tahunSelect = document.getElementById('summaryTahunSelect');

        if (!bulanSelect || !tahunSelect) return;

        // Mengisi dropdown tahun
        const defaultYear = getYearFromMMYYYY(globalServerCurrentMonthYear);
        const minYear = getYearFromMMYYYY(globalAdminMinMonthYear);
        populateYearSelect('summaryTahunSelect', minYear, defaultYear, defaultYear);

        // Mengatur bulan default
        bulanSelect.value = getMonthStrFromMMYYYY(globalServerCurrentMonthYear);

        // Memvalidasi rentang bulan yang dapat dipilih
        validateMonthRange('summaryBulanSelect', 'summaryTahunSelect');
        
        // Memuat data untuk periode default saat halaman pertama kali dibuka
        const initialMonthYear = `${bulanSelect.value}/${tahunSelect.value}`;
        if (loggedInUser && loggedInUser.teacherName) {
            loadAndDisplayTeacherSummary(loggedInUser.teacherName, initialMonthYear);
        }
    }

    /**
     * Menyiapkan lazy loading untuk gambar GIF menggunakan Intersection Observer.
     */
    function setupLazyLoadGifs() {
        const lazyGifs = document.querySelectorAll('.lazy-gif');

        if (!lazyGifs.length) return;

        const observerOptions = {
            root: null, // Menggunakan viewport sebagai root
            rootMargin: '0px',
            threshold: 0.01 // Picu callback bahkan jika hanya 1% dari gambar terlihat
        };

        const gifObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                const gif = entry.target;
                if (entry.isIntersecting) {
                    // Gambar terlihat, muat GIF dari data-src
                    if (gif.dataset.src && gif.src !== gif.dataset.src) {
                        gif.src = gif.dataset.src;
                    }
                } else {
                    // Gambar tidak terlihat, reset GIF dengan mengosongkan src
                    if (gif.src) {
                        gif.src = "";
                    }
                }
            });
        }, observerOptions);

        lazyGifs.forEach(gif => {
            gifObserver.observe(gif);
        });
    }

    /**
     * (VERSI 2)
     * Meng-handle proses impor dari file Excel. Nama guru diambil dari sesi aktif.
     */
    function handleImportExcel() {
      const fileInput = document.getElementById('excelFileInput');
      const selectedFile = fileInput.files[0];
      
      // Ambil nama guru dari variabel global yang sudah di-set saat login
      // atau saat admin memilih guru.
      const activeTeacherName = namaGuru; 

      if (!activeTeacherName) {
        showAlert('Sesi guru tidak aktif. Tidak bisa mengimpor data.', 'error');
        return;
      }

      if (!selectedFile) {
        showAlert('Silakan pilih file Excel untuk diimpor.', 'error');
        return;
      }

      showLoading("Membaca file Excel...");

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];

          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

          if (jsonData.length < 2) {
            hideLoading();
            showAlert('File Excel kosong atau tidak memiliki data.', 'error');
            return;
          }

          showLoading("Mengimpor data ke server...");
          google.script.run
            .withSuccessHandler(response => {
              hideLoading();
              if (response.success) {
                showAlert(response.message, 'success');
                // Muat ulang data ceklok untuk menampilkan hasil impor
                loadCeklokDataForSelectedMonth();
              } else {
                showAlert(response.error, 'error');
              }
            })
            .withFailureHandler(err => {
              hideLoading();
              showAlert('Gagal mengimpor data: ' + err.message, 'error');
            })
            .importFromExcel(activeTeacherName, jsonData); // Kirim nama guru yang aktif

        } catch (e) {
          hideLoading();
          showAlert('Gagal memproses file Excel: ' + e.message, 'error');
        }
      };
      reader.onerror = function() {
        hideLoading();
        showAlert('Gagal membaca file.', 'error');
      };
      reader.readAsArrayBuffer(selectedFile);
    }
  </script>
</body>
</html>
