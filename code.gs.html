// Code.gs

// Variabel global untuk nama sheet
const KALENDER_SHEET_NAME = "Kalender_Pendidikan";
const USERS_SHEET_NAME = "Users"; // Kolom: A=Username, B=Password, C=Role, D=Nama_Guru_Asli
const NAMA_GURU_SHEET_NAME = "Nama_Guru"; // Kolom: A=Nama Guru
const SETTING_SHEET_NAME = "Setting"; // Sel A1: BulanTahun (mm/yyyy)
const CEKLOK_MANUAL_SHEET_NAME = "Ceklok_Manual";
const HASIL_CEKLOK_SHEET_NAME = "Hasil_Ceklok";
const CETAK_SHEET_NAME = "CETAK"; // Untuk PDF
const LOGIN_HISTORY_SHEET_NAME = "Login_History";
const OPSIKETLIBUR_SHEET_NAME = "Opsi_Keterangan_Libur"; // BARU
const LOCK_ID_SHEET_NAME = "LOCK_ID";
const TEMPLATE_SHEET_FOR_BACKUP = "Worksheet"; // Asumsi "Worksheet" adalah template dasarnya
const BACKUP_SHEET_PREFIX = "Worksheet_"; // Sesuai permintaan "Worksheet_[nama_guru]"

function doGet(e) {
  return HtmlService.createHtmlOutputFromFile('index')
    .setTitle('Ceklok Guru MTS TANUNTUNG')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

// Fungsi untuk memuat konten HTML dari file parsial
function getHtmlContent(filename) {
  try {
    return HtmlService.createHtmlOutputFromFile(filename).getContent();
  } catch (e) {
    Logger.log("Error Gagal memuat file HTML '" + filename + "': " + e.toString());
    return "<p style='color:red;'>Error: Konten untuk '" + filename + "' tidak dapat dimuat. Pastikan file ada.</p>";
  }
}

function setBulanTahunSetting(newBulanTahun) {
  try {
    if (!newBulanTahun || typeof newBulanTahun !== 'string' || !/^\d{2}\/\d{4}$/.test(newBulanTahun)) {
      return { success: false, error: "Format Bulan/Tahun tidak valid. Harap gunakan format mm/yyyy (contoh: 05/2025)." };
    }
    const [mmStr, yyyyStr] = newBulanTahun.split("/");
    const mm = parseInt(mmStr, 10);
    const yyyy = parseInt(yyyyStr, 10);

    if (isNaN(mm) || isNaN(yyyy) || mm < 1 || mm > 12 || yyyy < 2000 || yyyy > 2100) {
      return { success: false, error: "Nilai Bulan/Tahun tidak valid. Gunakan mm/yyyy." };
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const settingSheet = ss.getSheetByName(SETTING_SHEET_NAME);
    if (!settingSheet) {
      return { success: false, error: `Sheet '${SETTING_SHEET_NAME}' tidak ditemukan.` };
    }
    settingSheet.getRange('A1').setValue(newBulanTahun);
    return { success: true, message: `Bulan & Tahun berhasil diubah menjadi ${newBulanTahun}.`, newBulanTahun: newBulanTahun };
  } catch (e) {
    Logger.log(`Error di setBulanTahunSetting: ${e.toString()}; Input: ${newBulanTahun}`);
    return { success: false, error: `Gagal mengubah Bulan/Tahun: ${e.message}` };
  }
}

// Di Code.gs
// Pastikan USERS_SHEET_NAME, LOGIN_HISTORY_SHEET_NAME, NAMA_GURU_SHEET_NAME sudah didefinisikan
// Kolom: A=Username (0), B=Password (1), C=Role (2), D=Nama_Guru_Asli (3), E=GoogleEmail (4)

function verifyLogin(username, password) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(USERS_SHEET_NAME);
    if (!usersSheet) return { success: false, error: `Sheet '${USERS_SHEET_NAME}' tidak ditemukan.` };

    const data = usersSheet.getDataRange().getValues();
    const headers = data[0]; // Ambil header
    const googleEmailColIdx = headers.indexOf("GoogleEmail"); // Dapatkan indeks kolom GoogleEmail

    // Jika kolom GoogleEmail tidak ada, log error tapi jangan gagalkan login sepenuhnya,
    // hanya saja fitur terkait Google link tidak akan berfungsi dengan baik.
    if (googleEmailColIdx === -1) {
        Logger.log("PERINGATAN di verifyLogin: Kolom 'GoogleEmail' tidak ditemukan di sheet Users.");
        // Anda bisa memutuskan untuk mengembalikan error di sini jika fitur ini krusial
        // return { success: false, error: "Konfigurasi sheet Users tidak lengkap (kolom GoogleEmail hilang)." };
    }

    for (let i = 1; i < data.length; i++) { // Mulai dari baris data
      const rowUsername = String(data[i][0]).trim();
      const rowPassword = String(data[i][1]); // Password tidak di-trim
      const rowRole = String(data[i][2]).trim();
      const rowActualTeacherName = data[i][3] ? String(data[i][3]).trim() : "";
      // Ambil GoogleEmail jika kolomnya ada
      const rowGoogleEmail = (googleEmailColIdx !== -1 && data[i][googleEmailColIdx]) ? String(data[i][googleEmailColIdx]).trim() : null;

      if (rowUsername === username && rowPassword === password) {
        let effectiveTeacherName = null;
        if (rowRole === "user") {
          if (!rowActualTeacherName) {
            return { success: false, error: `Login berhasil untuk '${username}', tetapi 'Nama_Guru_Asli' kosong. Hubungi admin.` };
          }
          effectiveTeacherName = rowActualTeacherName;
          const sheetGuru = ss.getSheetByName(NAMA_GURU_SHEET_NAME);
          if (sheetGuru) {
            const guruList = sheetGuru.getRange(1, 1, sheetGuru.getLastRow(), 1).getValues().flat().filter(String).map(g => String(g).trim());
            if (!guruList.includes(effectiveTeacherName)) {
              return { success: false, error: `Nama Guru Asli '${effectiveTeacherName}' (user: ${username}) tidak ada di sheet '${NAMA_GURU_SHEET_NAME}'.` };
            }
          } else {
            return { success: false, error: `Konfigurasi error: Sheet '${NAMA_GURU_SHEET_NAME}' tidak ditemukan.` };
          }
        }

        try {
            let loginHistorySheet = ss.getSheetByName(LOGIN_HISTORY_SHEET_NAME);
            if (!loginHistorySheet) {
                loginHistorySheet = ss.insertSheet(LOGIN_HISTORY_SHEET_NAME);
                // Langsung buat semua header yang dibutuhkan
                loginHistorySheet.appendRow(["Username", "Login_Timestamp", "Nama_Guru", "Metode_Login"]);
                loginHistorySheet.getRange("A1:D1").setFontWeight("bold"); // Asumsi 4 kolom
            }
            const timestamp = new Date();
            loginHistorySheet.appendRow([rowUsername, timestamp, effectiveTeacherName || '', "Password"]);
        } catch (logError) {
            Logger.log(`Gagal mencatat histori login untuk ${rowUsername}: ${logError.toString()}`);
        }
        return {
            success: true,
            username: rowUsername,
            role: rowRole,
            teacherName: effectiveTeacherName,
            googleEmail: rowGoogleEmail // <-- TAMBAHKAN INI
        };
      }
    }
    return { success: false, error: "Username atau password salah." };
  } catch (e) {
    Logger.log(`Error in verifyLogin: ${e.toString()}`);
    return { success: false, error: `Error server saat login: ${e.message}` };
  }
}

function getInitialData() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetGuru = ss.getSheetByName(NAMA_GURU_SHEET_NAME);
    const settingSheet = ss.getSheetByName(SETTING_SHEET_NAME);

    if (!sheetGuru) return { error: `Sheet '${NAMA_GURU_SHEET_NAME}' tidak ditemukan.` };
    if (!settingSheet) return { error: `Sheet '${SETTING_SHEET_NAME}' (A1: mm/yyyy) tidak ditemukan.` };

    const guruList = sheetGuru.getRange(1, 1, sheetGuru.getLastRow(), 1).getValues().flat().filter(String).map(g => String(g).trim());
    const bulanTahun = settingSheet.getRange('A1').getDisplayValue();

    if (!bulanTahun || !/^\d{2}\/\d{4}$/.test(bulanTahun)) {
      return { error: "Format bulanTahun di Setting A1 tidak valid (mm/yyyy)." };
    }
    // Inisialisasi sheet Kalender jika belum ada
    let kalenderSheet = ss.getSheetByName(KALENDER_SHEET_NAME);
    if (!kalenderSheet) {
        kalenderSheet = ss.insertSheet(KALENDER_SHEET_NAME);
        kalenderSheet.appendRow(["Tanggal (dd/mm/yyyy)", "Keterangan"]);
        Logger.log(`Sheet '${KALENDER_SHEET_NAME}' dibuat.`);
    }
    return { guruList, bulanTahun };
  } catch (e) {
      Logger.log(`Error in getInitialData: ${e.toString()}`);
      return { error: `Gagal memuat data awal: ${e.message}`};
  }
}

function getBulanTahunSetting() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const settingSheet = ss.getSheetByName(SETTING_SHEET_NAME);
    if (!settingSheet) return { error: `Sheet '${SETTING_SHEET_NAME}' tidak ditemukan.` };
    const bulanTahun = settingSheet.getRange('A1').getDisplayValue();
    if (!bulanTahun || !/^\d{2}\/\d{4}$/.test(bulanTahun)) {
      return { error: "Format bulanTahun di Setting A1 tidak valid (mm/yyyy)." };
    }
    return { bulanTahun: bulanTahun };
  } catch (e) {
    Logger.log(`Error di getBulanTahunSetting: ${e.toString()}`);
    return { error: `Gagal mengambil Bulan/Tahun: ${e.message}` };
  }
}

function getCeklokData(nama, bulanTahun) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(CEKLOK_MANUAL_SHEET_NAME);
    const liburSheet = ss.getSheetByName(KALENDER_SHEET_NAME);
    const opsiKetLiburSheet = ss.getSheetByName(OPSIKETLIBUR_SHEET_NAME); // BARU

    if (!sheet) return { error: `Sheet '${CEKLOK_MANUAL_SHEET_NAME}' tidak ditemukan.` };
    if (!liburSheet) return { error: `Sheet '${KALENDER_SHEET_NAME}' tidak ditemukan.` };
    // Tidak wajib error jika sheet opsi tidak ada, bisa saja dropdown kosong
    // if (!opsiKetLiburSheet) return { error: `Sheet '${OPSIKETLIBUR_SHEET_NAME}' tidak ditemukan.` };

    // Ambil opsi keterangan libur
    let ketLiburOptions = [];
    if (opsiKetLiburSheet && opsiKetLiburSheet.getLastRow() > 1) {
      ketLiburOptions = opsiKetLiburSheet.getRange(2, 1, opsiKetLiburSheet.getLastRow() - 1, 1)
                                .getValues().flat().filter(String).map(o => String(o).trim());
    } else {
      Logger.log(`Sheet '${OPSIKETLIBUR_SHEET_NAME}' tidak ada atau kosong.`);
    }

    const liburRows = liburSheet.getLastRow() > 1 ? liburSheet.getRange(2, 1, liburSheet.getLastRow() - 1, 2).getDisplayValues() : [];
    const liburMap = {};
    liburRows.forEach(([tglText, ket]) => {
      if (tglText && tglText.trim()) liburMap[tglText.trim()] = ket;
    });

    if (!bulanTahun || !/^\d{2}\/\d{4}$/.test(bulanTahun)) return { error: "Format bulanTahun tidak valid (mm/yyyy)." };
    const [mmStr, yyyyStr] = bulanTahun.split("/");
    const mm = parseInt(mmStr, 10);
    const yyyy = parseInt(yyyyStr, 10);
    if (isNaN(mm) || isNaN(yyyy) || mm < 1 || mm > 12) return { error: "Bulan/Tahun tidak valid." };

    const lastDay = new Date(yyyy, mm, 0).getDate();
    const allData = sheet.getDataRange().getValues();
    const headers = allData[0].map(h => String(h).trim()); // Pastikan header di trim
    const namaColIdx = headers.indexOf("Nama_Guru");
    const tanggalColIdx = headers.indexOf("Tanggal");
    const masukColIdx = headers.indexOf("Jam_Masuk");
    const pulangColIdx = headers.indexOf("Jam_Pulang");
    const ketLiburManualColIdx = headers.indexOf("Ket_Libur_Manual"); // BARU - Sesuaikan nama header

    if ([namaColIdx, tanggalColIdx, masukColIdx, pulangColIdx, ketLiburManualColIdx].includes(-1)) { // Tambah ketLiburManualColIdx
      let missingHeaders = [];
      if (namaColIdx === -1) missingHeaders.push("Nama_Guru");
      if (tanggalColIdx === -1) missingHeaders.push("Tanggal");
      if (masukColIdx === -1) missingHeaders.push("Jam_Masuk");
      if (pulangColIdx === -1) missingHeaders.push("Jam_Pulang");
      if (ketLiburManualColIdx === -1) missingHeaders.push("Ket_Libur_Manual"); // BARU
      return { error: `Header di 'Ceklok_Manual' tidak lengkap. Kolom yang hilang: ${missingHeaders.join(', ')}.` };
    }

    const resultData = []; // Ganti nama dari result menjadi resultData
    const namaHariIndonesia = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];

    for (let i = 1; i <= lastDay; i++) {
      const dateObj = new Date(yyyy, mm - 1, i);
      const dateStr = Utilities.formatDate(dateObj, Session.getScriptTimeZone(), "dd/MM/yyyy");
      const hari = namaHariIndonesia[dateObj.getDay()]; 
      
      const keteranganKalender = liburMap[dateStr] || ''; // Keterangan dari Kalender Pendidikan
      const isLiburKalender = (dateObj.getDay() === 0) || (keteranganKalender !== '');

      const dataRow = allData.find(r =>
        String(r[namaColIdx]).trim() === nama &&
        r[tanggalColIdx] instanceof Date &&
        Utilities.formatDate(new Date(r[tanggalColIdx]), Session.getScriptTimeZone(), "dd/MM/yyyy") === dateStr
      );

      resultData.push({
        hari,
        tanggal: dateStr,
        dataMasuk: dataRow && dataRow[masukColIdx] !== undefined ? String(dataRow[masukColIdx]) : '',
        dataPulang: dataRow && dataRow[pulangColIdx] !== undefined ? String(dataRow[pulangColIdx]) : '',
        isLibur: isLiburKalender, // Ini libur dari Kalender Pendidikan
        keterangan: keteranganKalender, // Ini keterangan dari Kalender Pendidikan
        keteranganLiburManual: dataRow && dataRow[ketLiburManualColIdx] !== undefined ? String(dataRow[ketLiburManualColIdx]) : '' // BARU
      });
    }
    // Ubah struktur return agar menyertakan options
    return { data: resultData, optionsKeteranganLibur: ketLiburOptions }; 
  } catch (e) {
    Logger.log(`Error in getCeklokData: ${e.toString()}; Input Nama: ${nama}, BulanTahun: ${bulanTahun}`);
    return { error: `Gagal mengambil data ceklok: ${e.message}` };
  }
}

function simpanData(nama, dataInput) { // dataInput adalah array dari objek {tanggal, jamMasuk, jamPulang, keteranganLiburManual}
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(CEKLOK_MANUAL_SHEET_NAME);
    if (!sheet) return "Error: Sheet 'Ceklok_Manual' tidak ditemukan.";

    const dataRange = sheet.getDataRange(); // Simpan range data
    const data = dataRange.getValues();
    const headers = data[0].map(h => String(h).trim());
    const namaColIdx = headers.indexOf("Nama_Guru");
    const tanggalColIdx = headers.indexOf("Tanggal");
    const masukColIdx = headers.indexOf("Jam_Masuk");
    const pulangColIdx = headers.indexOf("Jam_Pulang");
    const ketLiburManualColIdx = headers.indexOf("Ket_Libur_Manual"); // BARU

    if ([namaColIdx, tanggalColIdx, masukColIdx, pulangColIdx, ketLiburManualColIdx].includes(-1)) {
      let missingHeaders = [];
      if (namaColIdx === -1) missingHeaders.push("Nama_Guru");
      if (tanggalColIdx === -1) missingHeaders.push("Tanggal");
      if (masukColIdx === -1) missingHeaders.push("Jam_Masuk");
      if (pulangColIdx === -1) missingHeaders.push("Jam_Pulang");
      if (ketLiburManualColIdx === -1) missingHeaders.push("Ket_Libur_Manual");
      return `Error: Header di 'Ceklok_Manual' tidak lengkap. Kolom yang hilang: ${missingHeaders.join(', ')}.`;
    }

    dataInput.forEach(row => {
      if (!row || !row.tanggal) return; // Lewati jika row atau tanggal tidak ada
      const { tanggal, jamMasuk, jamPulang, keteranganLiburManual } = row; // Ambil keteranganLiburManual
      
      let jm = jamMasuk || "";
      let jp = jamPulang || "";

      // Jika keteranganLiburManual dipilih, kosongkan jamMasuk dan jamPulang
      const ketLiburTrimmed = keteranganLiburManual ? String(keteranganLiburManual).trim() : "";
      if (ketLiburTrimmed !== "") {
        jm = "";
        jp = "";
      }

      let existingRowIndex = -1;
      for (let i = 1; i < data.length; i++) {
        if (data[i][tanggalColIdx] instanceof Date && 
            Utilities.formatDate(new Date(data[i][tanggalColIdx]), Session.getScriptTimeZone(), "dd/MM/yyyy") === tanggal &&
            String(data[i][namaColIdx]).trim() === nama) {
          existingRowIndex = i + 1; 
          break;
        }
      }

      if (existingRowIndex !== -1) {
        sheet.getRange(existingRowIndex, masukColIdx + 1).setValue(jm);
        sheet.getRange(existingRowIndex, pulangColIdx + 1).setValue(jp);
        sheet.getRange(existingRowIndex, ketLiburManualColIdx + 1).setValue(ketLiburTrimmed); // Simpan keterangan libur
      } else if (jm || jp || ketLiburTrimmed !== "") { // Hanya tambah baris jika ada data yang diisi
        const dateParts = tanggal.split("/");
        const dateObject = new Date(parseInt(dateParts[2]), parseInt(dateParts[1]) - 1, parseInt(dateParts[0]));
        let newRowValues = new Array(headers.length).fill('');
        newRowValues[namaColIdx] = nama;
        newRowValues[tanggalColIdx] = dateObject;
        newRowValues[masukColIdx] = jm;
        newRowValues[pulangColIdx] = jp;
        newRowValues[ketLiburManualColIdx] = ketLiburTrimmed; // Simpan keterangan libur
        sheet.appendRow(newRowValues);
      }
    });

    if (sheet.getLastRow() > 1) { // Hanya format jika ada data selain header
      const lastDataRow = sheet.getLastRow(); // Dapatkan baris terakhir setelah appendRow
      if (masukColIdx > -1) sheet.getRange(2, masukColIdx + 1, lastDataRow - 1, 1).setNumberFormat("@");
      if (pulangColIdx > -1) sheet.getRange(2, pulangColIdx + 1, lastDataRow - 1, 1).setNumberFormat("@");
      if (ketLiburManualColIdx > -1) sheet.getRange(2, ketLiburManualColIdx + 1, lastDataRow - 1, 1).setNumberFormat("@"); // BARU
    }
    return "Data berhasil disimpan.";
  } catch (e) {
    Logger.log(`Error in simpanData: ${e.toString()}; Nama: ${nama}, DataInput: ${JSON.stringify(dataInput)}`);
    return `Error saat menyimpan: ${e.message}`;
  }
}

function downloadPDF() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(CETAK_SHEET_NAME);
    if (!sheet) return { error: `Sheet '${CETAK_SHEET_NAME}' tidak ditemukan.` };

    const exportUrl = ss.getUrl().replace(/edit$/, '') + 'export?';
    const params = {
      format: 'pdf', portrait: false, fitw: true,
      top_margin: 0.4, bottom_margin: 0.4, left_margin: 0.4, right_margin: 0.4,
      sheetnames: false, printtitle: false, pagenumbers: false,
      gridlines: false, fzr: false, gid: sheet.getSheetId()
    };
    const query = Object.entries(params).map(([k, v]) => `${k}=${v}`).join('&');
    const blob = UrlFetchApp.fetch(exportUrl + query, {
      headers: { Authorization: 'Bearer ' + ScriptApp.getOAuthToken() }
    }).getBlob().setName(`Ceklok_${Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy-MM-dd_HH-mm")}.pdf`);

    const folderName = 'Ceklok_PDF_MTSTANUNTUNG_Generated';
    let folder = DriveApp.getFoldersByName(folderName);
    folder = folder.hasNext() ? folder.next() : DriveApp.createFolder(folderName);
    
    // Hapus file lama dengan nama sama jika ada
    const files = folder.getFilesByName(blob.getName());
    while(files.hasNext()) files.next().setTrashed(true);

    const file = folder.createFile(blob);
    return file.getUrl();
  } catch (e) {
    Logger.log(`Error downloadPDF: ${e.toString()}`);
    return { error: `Gagal membuat PDF: ${e.message}` };
  }
}

function getCeklokHasil() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(HASIL_CEKLOK_SHEET_NAME);
    if (!sheet) return { error: `Sheet '${HASIL_CEKLOK_SHEET_NAME}' tidak ditemukan.` };
    if (sheet.getLastRow() < 2) return { headers: ["Info"], data: [["Data di Hasil Ceklok kosong."]] };

    const NUM_COLUMNS_TO_READ = 32; // AF
    const colsToFetch = Math.min(NUM_COLUMNS_TO_READ, sheet.getMaxColumns());
    if (colsToFetch === 0) return { headers: ["Info"], data: [["Sheet Hasil Ceklok tidak punya kolom."]] };

    const headers = sheet.getRange(2, 1, 1, colsToFetch).getDisplayValues()[0];
    let dataRows = [];
    if (sheet.getLastRow() > 2) {
      dataRows = sheet.getRange(3, 1, sheet.getLastRow() - 2, colsToFetch).getDisplayValues();
    }
    return { headers: headers, data: dataRows };
  } catch (e) {
    Logger.log(`Error in getCeklokHasil: ${e.toString()}`);
    return { error: `Gagal mengambil hasil ceklok: ${e.message}` };
  }
}

// Fungsi Kalender Pendidikan
function getKalenderPendidikanEntries() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName(KALENDER_SHEET_NAME);
    if (!sheet) { // Jika sheet tidak ada, buat dan kembalikan array kosong
        sheet = ss.insertSheet(KALENDER_SHEET_NAME);
        sheet.appendRow(["Tanggal (dd/mm/yyyy)", "Keterangan"]);
        Logger.log(`Sheet '${KALENDER_SHEET_NAME}' dibuat saat getKalenderPendidikanEntries.`);
        return [];
    }
    if (sheet.getLastRow() < 2) return [];
    
    const values = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getDisplayValues();
    return values.map((row, index) => ({
      date: row[0], description: row[1], sheetRow: index + 2
    })).filter(entry => entry.date && entry.date.trim() !== "");
  } catch (e) {
    Logger.log(`Error di getKalenderPendidikanEntries: ${e.toString()}`);
    return { error: `Gagal mengambil entri kalender: ${e.message}` };
  }
}

function addKalenderPendidikanEntry(entryData) {
  try {
    if (!entryData || !entryData.date || !entryData.description) return {success: false, error: "Data tidak lengkap. Tanggal dan Keterangan wajib."};
    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(entryData.date)) return {success: false, error: "Format Tanggal salah (dd/mm/yyyy)."};

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(KALENDER_SHEET_NAME);
    if (!sheet) return {success: false, error: `Sheet '${KALENDER_SHEET_NAME}' tidak ditemukan.`};

    sheet.appendRow([entryData.date, entryData.description]);
    return {success: true, message: "Entri Kalender berhasil ditambahkan."};
  } catch (e) {
    Logger.log(`Error di addKalenderPendidikanEntry: ${e.toString()}`);
    return {success: false, error: `Gagal menambah entri kalender: ${e.message}`};
  }
}

function deleteKalenderPendidikanEntry(sheetRow) {
  try {
    if (!sheetRow || typeof sheetRow !== 'number' || sheetRow < 2) return {success: false, error: "Nomor baris tidak valid."};
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(KALENDER_SHEET_NAME);
    if (!sheet) return {success: false, error: `Sheet '${KALENDER_SHEET_NAME}' tidak ditemukan.`};
    if (sheetRow > sheet.getLastRow()) return {success: false, error: "Baris sudah dihapus atau tidak ada."};

    sheet.deleteRow(sheetRow);
    return {success: true, message: "Entri Kalender berhasil dihapus."};
  } catch (e) {
    Logger.log(`Error di deleteKalenderPendidikanEntry: ${e.toString()}`);
    return {success: false, error: `Gagal menghapus entri kalender: ${e.message}`};
  }
}

// Fungsi Manajemen Pengguna (Admin)
function getUsersForAdmin() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(USERS_SHEET_NAME);
    if (!usersSheet) return { success: false, error: `Sheet '${USERS_SHEET_NAME}' tidak ditemukan.` };
    
    if (usersSheet.getLastRow() < 2) return { success: true, users: [] }; // Kosong jika hanya header
    const data = usersSheet.getRange(2, 1, usersSheet.getLastRow() - 1, 4).getValues();
    const users = data.map(row => ({
      username: String(row[0]).trim(),
      role: String(row[2]).trim(),
      teacherName: row[3] ? String(row[3]).trim() : ""
    })).filter(user => user.username); // Filter user tanpa username
    return { success: true, users: users };
  } catch (e) {
    Logger.log(`Error in getUsersForAdmin: ${e.toString()}`);
    return { success: false, error: `Gagal mengambil pengguna: ${e.message}` };
  }
}

function addNewUser(userData) {
  try {
    if (!userData.username || !userData.password || !userData.role) {
      return { success: false, error: "Username, password, dan role harus diisi." };
    }
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(USERS_SHEET_NAME);
    if (!usersSheet) return { success: false, error: `Sheet '${USERS_SHEET_NAME}' tidak ditemukan.` };

    const usernames = usersSheet.getRange(2, 1, usersSheet.getLastRow() > 1 ? usersSheet.getLastRow() - 1 : 1, 1)
                                .getValues().flat().map(u => String(u).trim());
    if (usernames.includes(userData.username.trim())) {
      return { success: false, error: `Username '${userData.username}' sudah ada.` };
    }
    
    let teacherNameToSave = "";
    if (userData.role === 'user') {
      if (!userData.teacherName) return { success: false, error: "Nama Guru Asli wajib untuk role 'user'." };
      const namaGuruSheet = ss.getSheetByName(NAMA_GURU_SHEET_NAME);
      if (namaGuruSheet) {
        const guruList = namaGuruSheet.getRange(1, 1, namaGuruSheet.getLastRow(), 1).getValues().flat().filter(String).map(g => String(g).trim());
        if (!guruList.includes(userData.teacherName.trim())) {
             return { success: false, error: `Nama Guru '${userData.teacherName}' tidak ada di daftar. Tambahkan dulu.` };
        }
        teacherNameToSave = userData.teacherName.trim();
      } else {
        return { success: false, error: `Sheet '${NAMA_GURU_SHEET_NAME}' tidak ditemukan.` };
      }
    }
    usersSheet.appendRow([userData.username.trim(), userData.password, userData.role.trim(), teacherNameToSave]);
    return { success: true, message: "Pengguna baru berhasil ditambahkan." };
  } catch (e) {
    Logger.log(`Error in addNewUser: ${e.toString()}`);
    return { success: false, error: `Gagal menambah pengguna: ${e.message}` };
  }
}

function updateUserByUsername(username, userDataToUpdate) {
  try {
    if (!username || !userDataToUpdate || !userDataToUpdate.newRole) {
      return { success: false, error: "Username dan role baru wajib." };
    }
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(USERS_SHEET_NAME);
    if (!usersSheet) return { success: false, error: `Sheet '${USERS_SHEET_NAME}' tidak ditemukan.` };

    const data = usersSheet.getDataRange().getValues();
    let rowIndex = -1;
    for (let i = 1; i < data.length; i++) { // Skip header
      if (String(data[i][0]).trim() === username) {
        rowIndex = i + 1; break;
      }
    }
    if (rowIndex === -1) return { success: false, error: `Pengguna '${username}' tidak ditemukan.` };

    usersSheet.getRange(rowIndex, 3).setValue(userDataToUpdate.newRole.trim()); // Update Role
    if (userDataToUpdate.newPassword) { // Update Password jika ada
      usersSheet.getRange(rowIndex, 2).setValue(userDataToUpdate.newPassword);
    }

    let teacherNameToSave = "";
    if (userDataToUpdate.newRole === 'user') {
      if (!userDataToUpdate.newTeacherName) return { success: false, error: "Nama Guru Asli baru wajib untuk role 'user'." };
      const namaGuruSheet = ss.getSheetByName(NAMA_GURU_SHEET_NAME);
      if (namaGuruSheet) {
        const guruList = namaGuruSheet.getRange(1, 1, namaGuruSheet.getLastRow(), 1).getValues().flat().filter(String).map(g => String(g).trim());
        if (!guruList.includes(userDataToUpdate.newTeacherName.trim())) {
             return { success: false, error: `Nama Guru '${userDataToUpdate.newTeacherName}' tidak ada di daftar.` };
        }
        teacherNameToSave = userDataToUpdate.newTeacherName.trim();
      } else {
        return { success: false, error: `Sheet '${NAMA_GURU_SHEET_NAME}' tidak ditemukan.` };
      }
    }
    usersSheet.getRange(rowIndex, 4).setValue(teacherNameToSave); // Update Nama_Guru_Asli
    return { success: true, message: `Pengguna '${username}' berhasil diperbarui.` };
  } catch (e) {
    Logger.log(`Error in updateUserByUsername: ${e.toString()}`);
    return { success: false, error: `Gagal memperbarui pengguna: ${e.message}` };
  }
}

function deleteUserByUsername(username) {
  try {
    if (!username) return { success: false, error: "Username wajib." };
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(USERS_SHEET_NAME);
    if (!usersSheet) return { success: false, error: `Sheet '${USERS_SHEET_NAME}' tidak ditemukan.` };

    const data = usersSheet.getDataRange().getValues();
    let rowIndex = -1;
    let roleToDelete = '';
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]).trim() === username) {
        rowIndex = i + 1; 
        roleToDelete = String(data[i][2]).trim().toLowerCase();
        break;
      }
    }
    if (rowIndex === -1) return { success: false, error: `Pengguna '${username}' tidak ditemukan.` };

    if (roleToDelete === 'admin') {
        let adminCount = 0;
        for (let i = 1; i < data.length; i++) {
            if(String(data[i][2]).trim().toLowerCase() === 'admin') adminCount++;
        }
        if(adminCount <= 1 && rowIndex !== -1) { // Hanya cek jika user ditemukan
            return { success: false, error: `Tidak dapat menghapus satu-satunya akun admin.` };
        }
    }
    usersSheet.deleteRow(rowIndex);
    return { success: true, message: `Pengguna '${username}' berhasil dihapus.` };
  } catch (e) {
    Logger.log(`Error in deleteUserByUsername: ${e.toString()}`);
    return { success: false, error: `Gagal menghapus pengguna: ${e.message}` };
  }
}

// Fungsi Manajemen Guru (Admin)
function getTeachersForAdmin() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetGuru = ss.getSheetByName(NAMA_GURU_SHEET_NAME);
    if (!sheetGuru) return { success: false, error: `Sheet '${NAMA_GURU_SHEET_NAME}' tidak ditemukan.` };
    if (sheetGuru.getLastRow() === 0) return { success: true, teachers: [] };

    const guruList = sheetGuru.getRange(1, 1, sheetGuru.getLastRow(), 1).getValues().flat().filter(String).map(g => String(g).trim());
    return { success: true, teachers: guruList };
  } catch (e) {
    Logger.log(`Error in getTeachersForAdmin: ${e.toString()}`);
    return { success: false, error: `Gagal mengambil data guru: ${e.message}` };
  }
}

function addNewTeacher(teacherName) {
  try {
    if (!teacherName || teacherName.trim() === "") return { success: false, error: "Nama guru tidak boleh kosong." };
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetGuru = ss.getSheetByName(NAMA_GURU_SHEET_NAME);
    if (!sheetGuru) return { success: false, error: `Sheet '${NAMA_GURU_SHEET_NAME}' tidak ditemukan.` };

    const guruList = sheetGuru.getRange(1, 1, sheetGuru.getLastRow(), 1).getValues().flat().filter(String).map(g => String(g).trim());
    if (guruList.includes(teacherName.trim())) {
      return { success: false, error: `Nama guru '${teacherName}' sudah ada.` };
    }
    sheetGuru.appendRow([teacherName.trim()]);
    return { success: true, message: `Nama guru '${teacherName.trim()}' berhasil ditambahkan.` };
  } catch (e) {
    Logger.log(`Error in addNewTeacher: ${e.toString()}`);
    return { success: false, error: `Gagal menambah nama guru: ${e.message}` };
  }
}

function updateTeacherByName(oldTeacherName, newTeacherName) {
  try {
    if (!oldTeacherName || !newTeacherName || oldTeacherName.trim() === "" || newTeacherName.trim() === "") {
      return { success: false, error: "Nama guru lama dan baru tidak boleh kosong." };
    }
    if (oldTeacherName.trim() === newTeacherName.trim()) return { success: false, error: "Nama baru sama dengan nama lama." };

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetGuru = ss.getSheetByName(NAMA_GURU_SHEET_NAME);
    if (!sheetGuru) return { success: false, error: `Sheet '${NAMA_GURU_SHEET_NAME}' tidak ditemukan.` };

    const dataGuru = sheetGuru.getRange(1, 1, sheetGuru.getLastRow(), 1).getValues();
    let rowIndexGuru = -1;
    let guruListForValidation = [];
    for (let i = 0; i < dataGuru.length; i++) {
      const currentTeacher = String(dataGuru[i][0]).trim();
      guruListForValidation.push(currentTeacher);
      if (currentTeacher === oldTeacherName.trim()) rowIndexGuru = i + 1;
    }
    if (rowIndexGuru === -1) return { success: false, error: `Nama guru '${oldTeacherName}' tidak ditemukan.` };
    if (guruListForValidation.includes(newTeacherName.trim())) return { success: false, error: `Nama guru '${newTeacherName}' sudah ada.` };

    sheetGuru.getRange(rowIndexGuru, 1).setValue(newTeacherName.trim());

    // Update di sheet Users
    const usersSheet = ss.getSheetByName(USERS_SHEET_NAME);
    if (usersSheet && usersSheet.getLastRow() > 1) {
      const dataUsers = usersSheet.getRange(2, 1, usersSheet.getLastRow() - 1, 4).getValues();
      for (let i = 0; i < dataUsers.length; i++) {
        if (String(dataUsers[i][3]).trim() === oldTeacherName.trim()) { // Kolom D (index 3) adalah Nama_Guru_Asli
          usersSheet.getRange(i + 2, 4).setValue(newTeacherName.trim()); // i+2 karena dataUsers 0-based, sheet 1-based, dan skip header
        }
      }
    }
    return { success: true, message: `Nama guru '${oldTeacherName}' diperbarui menjadi '${newTeacherName}'. Referensi di Users juga diupdate.` };
  } catch (e) {
    Logger.log(`Error in updateTeacherByName: ${e.toString()}`);
    return { success: false, error: `Gagal memperbarui nama guru: ${e.message}` };
  }
}

function deleteTeacherByName(teacherName) {
  try {
    if (!teacherName || teacherName.trim() === "") return { success: false, error: "Nama guru tidak boleh kosong." };
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetGuru = ss.getSheetByName(NAMA_GURU_SHEET_NAME);
    if (!sheetGuru) return { success: false, error: `Sheet '${NAMA_GURU_SHEET_NAME}' tidak ditemukan.` };

    const usersSheet = ss.getSheetByName(USERS_SHEET_NAME);
    if (usersSheet && usersSheet.getLastRow() > 1) {
      const dataUsersTeacherNames = usersSheet.getRange(2, 4, usersSheet.getLastRow() - 1, 1).getValues().flat().map(name => String(name).trim());
      if (dataUsersTeacherNames.includes(teacherName.trim())) {
        return { success: false, error: `Guru '${teacherName}' terhubung ke user. Update/hapus user terkait dulu.` };
      }
    }

    const dataGuru = sheetGuru.getRange(1, 1, sheetGuru.getLastRow(), 1).getValues();
    let rowIndexGuru = -1;
    for (let i = 0; i < dataGuru.length; i++) {
      if (String(dataGuru[i][0]).trim() === teacherName.trim()) {
        rowIndexGuru = i + 1; break;
      }
    }
    if (rowIndexGuru === -1) return { success: false, error: `Nama guru '${teacherName}' tidak ditemukan.` };

    sheetGuru.deleteRow(rowIndexGuru);
    return { success: true, message: `Nama guru '${teacherName}' berhasil dihapus.` };
  } catch (e) {
    Logger.log(`Error in deleteTeacherByName: ${e.toString()}`);
    return { success: false, error: `Gagal menghapus nama guru: ${e.message}` };
  }
}


function getLoginHistory(limit = 20) {
    try {
        const ss = SpreadsheetApp.getActiveSpreadsheet();
        const historySheet = ss.getSheetByName(LOGIN_HISTORY_SHEET_NAME);

        if (!historySheet) {
            return { success: true, history: [], message: `Sheet '${LOGIN_HISTORY_SHEET_NAME}' tidak ditemukan.` };
        }

        const lastRow = historySheet.getLastRow();
        const headerRows = 1;

        if (lastRow <= headerRows) {
            return { success: true, history: [] };
        }

        const dataRowsCount = lastRow - headerRows;
        const rowsToFetch = Math.min(dataRowsCount, limit);

        if (rowsToFetch <= 0) {
            return { success: true, history: [] };
        }

        // *** MODIFIKASI: Baca 3 kolom ***
        const range = historySheet.getRange(lastRow - rowsToFetch + 1, 1, rowsToFetch, 3);
        const values = range.getDisplayValues();

        // *** MODIFIKASI: Tambahkan teacherName ke objek hasil ***
        const historyEntries = values.map(row => {
            return {
                username: row[0],
                timestamp: row[1],
                teacherName: row[2] || '-' // Ambil nama guru, gunakan '-' jika kosong
            };
        });

        return { success: true, history: historyEntries.reverse() };

    } catch (e) {
        Logger.log(`Error di getLoginHistory: ${e.toString()}`);
        return { success: false, error: `Gagal mengambil histori login: ${e.message}` };
    }
}


function ensureSheet(sheetName, headers = []) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    if (headers.length > 0) {
      sheet.appendRow(headers);
      // Optional: Jadikan header tebal
      sheet.getRange(1, 1, 1, headers.length).setFontWeight("bold").setHorizontalAlignment("center");
    }
  }
  return sheet;
}


function saveOrUpdateLockId(teacherName, lockId) {
  if (!teacherName || !lockId) {
    return { success: false, error: "Nama Guru dan LOCK_ID tidak boleh kosong." };
  }

  try {
    const lockIdSheet = ensureSheet(LOCK_ID_SHEET_NAME, ["Nama_Guru", "LOCK_ID"]);
    const data = lockIdSheet.getDataRange().getValues();
    let rowIndex = -1;

    // Cari guru, mulai dari baris kedua (setelah header)
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === teacherName) {
        rowIndex = i + 1; // Sheet row index is 1-based
        break;
      }
    }

    if (rowIndex !== -1) {
      lockIdSheet.getRange(rowIndex, 2).setValue(lockId); // Update LOCK_ID
    } else {
      lockIdSheet.appendRow([teacherName, lockId]); // Tambah baru
    }
    return { success: true, message: "LOCK_ID berhasil disimpan." };
  } catch (e) {
    Logger.log(`Error in saveOrUpdateLockId: ${e.toString()}`);
    return { success: false, error: `Gagal menyimpan LOCK_ID: ${e.message}` };
  }
}

function getLockIdForTeacher(teacherName) {
  if (!teacherName) return null;
  try {
    const lockIdSheet = ensureSheet(LOCK_ID_SHEET_NAME, ["Nama_Guru", "LOCK_ID"]);
    const data = lockIdSheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) { // Mulai dari baris data (setelah header)
      if (data[i][0] === teacherName) {
        return data[i][1] ? String(data[i][1]).trim() : null; // LOCK_ID ada di kolom kedua
      }
    }
    return null; // Tidak ditemukan
  } catch (e) {
    Logger.log(`Error in getLockIdForTeacher: ${e.toString()}`);
    return null;
  }
}

// Di dalam file Code.gs

function formatTimeToHHMM_Excel(timeStr) {
  if (!timeStr || typeof timeStr !== 'string' || String(timeStr).trim() === "") { // Ditambahkan trim() check
    return ""; // Kembalikan string kosong jika input kosong, null, atau bukan string
  }
  const parts = String(timeStr).trim().split(/[.:]/); // Trim input sebelum di-split
  if (parts.length === 2) {
    const h = String(parts[0]).padStart(2, '0');
    const m = String(parts[1]).padStart(2, '0');
    
    // Validasi tambahan untuk memastikan h dan m adalah angka setelah padding
    if (!isNaN(parseInt(h, 10)) && !isNaN(parseInt(m, 10)) &&
        parseInt(h, 10) >= 0 && parseInt(h, 10) < 24 &&
        parseInt(m, 10) >= 0 && parseInt(m, 10) < 60) {
      return `'${h}:${m}`; // Tambahkan apostrof di depan string HH:MM
    }
  }
  // Jika format input tidak valid (misalnya "Sakit" atau format salah lainnya), kembalikan string kosong.
  // Ini mencegah input yang tidak valid merusak format atau muncul sebagai error.
  return ""; 
}

// Pastikan fungsi helper formatTimeToHHMM_Excel sudah ada.
// ... (kode helper lainnya seperti ensureSheet, saveOrUpdateLockId, dll. juga diasumsikan ada) ...

function requestExcelExport(teacherName, bulanTahun, lockIdFromUser) {
  try { // Blok try terluar untuk menangani error di luar LockService
    // TAMBAHAN: Menerapkan semua perubahan spreadsheet yang tertunda
    SpreadsheetApp.flush(); 

    const saveLockIdResult = saveOrUpdateLockId(teacherName, lockIdFromUser);
    if (!saveLockIdResult.success) {
      return { success: false, error: saveLockIdResult.error };
    }

    const storedLockId = getLockIdForTeacher(teacherName);
    if (!storedLockId) {
      return { success: false, error: "LOCK_ID tidak ditemukan untuk guru ini setelah upaya penyimpanan." };
    }
    let currentExportId;
    if (isNaN(parseInt(storedLockId, 10))) {
      return { success: false, error: `LOCK_ID '${storedLockId}' (dari sheet) tidak valid untuk penomoran otomatis (harus berupa angka).` };
    }
    currentExportId = parseInt(storedLockId, 10);

    // getCeklokData dipanggil SETELAH flush, idealnya membaca data yang sudah ter-update
    const ceklokDataResponse = getCeklokData(teacherName, bulanTahun); 
    if (ceklokDataResponse.error) {
      return { success: false, error: `Gagal mendapatkan data absensi: ${ceklokDataResponse.error}` };
    }
    const attendanceDataArray = ceklokDataResponse.data;
    if (!attendanceDataArray || attendanceDataArray.length === 0) {
      return { success: false, error: "Tidak ada data absensi untuk diekspor pada bulan dan tahun ini." };
    }

    const worksheetHeaders = [
      "EXPORT_ID", "Tanggal (YYYY-MM-DD)", "Hari (Bahasa Indonesia)",
      "Jam Masuk (HH:MM)", "Jam Pulang (HH:MM)",
      "Keterangan Libur 1", "Keterangan Libur 2"
    ];
    const scriptTimeZone = Session.getScriptTimeZone();
    const dataToLoadToWorksheet = [];

    attendanceDataArray.forEach(row => {
      let formattedDateYYYYMMDD = "";
      if (row.tanggal && typeof row.tanggal === 'string' && row.tanggal.includes('/')) {
        const dateParts = row.tanggal.split("/");
        if (dateParts.length === 3) {
          const day = parseInt(dateParts[0], 10);
          const month = parseInt(dateParts[1], 10) - 1;
          const year = parseInt(dateParts[2], 10);
          if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
            const dateObject = new Date(year, month, day);
            if (dateObject && typeof dateObject.getTime === 'function' && !isNaN(dateObject.getTime())) {
              formattedDateYYYYMMDD = Utilities.formatDate(dateObject, scriptTimeZone, "yyyy-MM-dd");
            } else { Logger.log(`Gagal membuat objek Date valid dari: ${row.tanggal}`); }
          } else { Logger.log(`Bagian tanggal tidak valid setelah parse: ${row.tanggal}`); }
        } else { Logger.log(`Format tanggal tidak dikenali (bukan dd/MM/yyyy): ${row.tanggal}`); }
      } else if (row.tanggal) {
        try { formattedDateYYYYMMDD = Utilities.formatDate(new Date(row.tanggal), scriptTimeZone, "yyyy-MM-dd"); }
        catch (e) { Logger.log(`Gagal memformat row.tanggal (${row.tanggal}) secara langsung: ${e.message}`); }
      }
      const hariIndonesia = row.hari;
      const jamMasukFormatted = formatTimeToHHMM_Excel(row.dataMasuk);
      const jamPulangFormatted = formatTimeToHHMM_Excel(row.dataPulang);
      const keteranganManual = row.keteranganLiburManual || "";
      let finalJamMasuk = jamMasukFormatted;
      let finalJamPulang = jamPulangFormatted;
      if (keteranganManual !== "") { finalJamMasuk = ""; finalJamPulang = ""; }
      dataToLoadToWorksheet.push([
        "", formattedDateYYYYMMDD, hariIndonesia, finalJamMasuk, finalJamPulang, keteranganManual, keteranganManual
      ]);
    });

    for (let i = 0; i < dataToLoadToWorksheet.length; i++) {
      dataToLoadToWorksheet[i][0] = currentExportId + i;
    }

    const lock = LockService.getDocumentLock();
    try {
      lock.waitLock(30000); 

      const worksheet = ensureSheet(WORKSHEET_NAME, worksheetHeaders);
      if (worksheet.getLastRow() > 1) {
        worksheet.getRange(2, 1, worksheet.getLastRow() - 1, worksheetHeaders.length)
          .clearContent().clearFormat();
      }

      if (dataToLoadToWorksheet.length > 0) {
        const startDataRow = 2; const numDataRows = dataToLoadToWorksheet.length;
        const dataRange = worksheet.getRange(startDataRow, 1, numDataRows, worksheetHeaders.length);
        dataRange.setValues(dataToLoadToWorksheet);
        worksheet.getRange(startDataRow, 1, numDataRows, 1).setNumberFormat("@");
        worksheet.getRange(startDataRow, 2, numDataRows, 1).setNumberFormat("@");
        worksheet.getRange(startDataRow, 3, numDataRows, 1).setNumberFormat("@");
        worksheet.getRange(startDataRow, 4, numDataRows, 2).setNumberFormat("@"); 
        worksheet.getRange(startDataRow, 6, numDataRows, 2).setNumberFormat("@");
      }

      const spreadsheetId = SpreadsheetApp.getActiveSpreadsheet().getId();
      const sheetId = worksheet.getSheetId();
      const internalExportUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=xlsx&gid=${sheetId}`;

      const token = ScriptApp.getOAuthToken();
      const fetchParams = {
        headers: { 'Authorization': 'Bearer ' + token },
        muteHttpExceptions: true
      };
      const httpResponse = UrlFetchApp.fetch(internalExportUrl, fetchParams);

      if (httpResponse.getResponseCode() !== 200) {
        Logger.log(`Gagal mengambil blob Excel. Kode status: ${httpResponse.getResponseCode()}. Respons: ${httpResponse.getContentText()}`);
        return { success: false, error: `Gagal mengambil data Excel dari server (Status: ${httpResponse.getResponseCode()}).` };
      }
      const blob = httpResponse.getBlob();
      const bulanTahunFormattedForFilename = bulanTahun.replace('/', '-');
      const dynamicFileName = `${teacherName}-${bulanTahunFormattedForFilename}.xlsx`;
      const base64Data = Utilities.base64Encode(blob.getBytes());
      const mimeType = blob.getContentType() || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';

      Logger.log(`File '${dynamicFileName}' (ukuran base64: ${base64Data.length} bytes) siap dikirim ke klien.`);

      return {
        success: true,
        base64Data: base64Data,
        fileName: dynamicFileName,
        mimeType: mimeType,
        message: `Mempersiapkan unduhan untuk file '${dynamicFileName}'.`
      };

    } catch (e) {
      Logger.log(`Error di dalam blok LockService requestExcelExport: ${e.toString()}; Stack: ${e.stack}`);
      if (e.message && e.message.toLowerCase().includes("lock timed out")) { 
        return { success: false, error: "Server sedang sibuk memproses ekspor lain. Silakan coba lagi dalam beberapa saat." };
      }
      return { success: false, error: `Terjadi error server saat memproses export (dalam lock): ${e.message}` };
    } finally {
      lock.releaseLock();
    }
  } catch (e_outer) {
    Logger.log(`Error besar di requestExcelExport (di luar lock): ${e_outer.toString()}; Stack: ${e_outer.stack}`);
    return { success: false, error: `Terjadi error server saat memproses export: ${e_outer.message}` };
  }
}


// Helper function untuk memastikan sheet template ada
function ensureTemplateSheetExists() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let templateSheet = ss.getSheetByName(TEMPLATE_SHEET_FOR_BACKUP);
  if (!templateSheet) {
    templateSheet = ss.insertSheet(TEMPLATE_SHEET_FOR_BACKUP);
    // Anda mungkin ingin menambahkan header default ke template sheet di sini jika belum ada
    const worksheetHeaders = [
      "LOCK ID", "TANGGAL", "HARI",
      "JAM MASUK", "JAM PULANG",
      "ALASAN TIDAK HADIR", "DESKRIPSI" // Keterangan Libur 1 dan 2 bisa sama (keteranganLiburManual)
    ];
    templateSheet.appendRow(worksheetHeaders);
    templateSheet.getRange(1, 1, 1, worksheetHeaders.length).setFontWeight("bold").setHorizontalAlignment("center");
    SpreadsheetApp.flush(); // Pastikan header tertulis
    Logger.log(`Template sheet '${TEMPLATE_SHEET_FOR_BACKUP}' dibuat dengan header.`);
  }
  return templateSheet;
}

function saveLockIdAndPrepareBackupSheet(teacherName, bulanTahun, lockId, clientCeklokData) {
  try {
    SpreadsheetApp.flush(); // Pastikan semua perubahan sebelumnya tersimpan
    // 1. Simpan LOCK_ID (gunakan fungsi yang sudah ada atau buat yang baru jika perlu modifikasi)
    const saveLockResult = saveOrUpdateLockId(teacherName, lockId); // Asumsi fungsi ini ada dari kode Anda
    if (!saveLockResult.success) {
      return { success: false, error: `Gagal menyimpan LOCK_ID: ${saveLockResult.error}` };
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const backupSheetName = `${BACKUP_SHEET_PREFIX}${teacherName}`;

    // 2. Hapus sheet cadangan lama dengan nama yang sama jika ada
    let existingBackupSheet = ss.getSheetByName(backupSheetName);
    if (existingBackupSheet) {
      ss.deleteSheet(existingBackupSheet);
      Logger.log(`Sheet cadangan lama '${backupSheetName}' dihapus.`);
    }
    SpreadsheetApp.flush(); // Pastikan penghapusan selesai

    // 3. Duplikasi dari template atau buat sheet baru dan format
    const templateSheet = ensureTemplateSheetExists(); // Pastikan template ada
    if (!templateSheet) {
        return { success: false, error: `Sheet template '${TEMPLATE_SHEET_FOR_BACKUP}' tidak ditemukan dan tidak dapat dibuat.` };
    }
    const newBackupSheet = templateSheet.copyTo(ss).setName(backupSheetName);
    newBackupSheet.clearContents(); // Hapus konten dari template (jika ada selain header)
    // Pastikan header ada di sheet baru (jika clearContents menghapusnya atau template kosong)
    const worksheetHeaders = [
      "LOCK ID", "TANGGAL", "HARI",
      "JAM MASUK", "JAM PULANG",
      "ALASAN TIDAK HADIR", "DESKRIPSI"
    ];
    newBackupSheet.appendRow(worksheetHeaders); // Tambahkan header lagi
    newBackupSheet.getRange(1, 1, 1, worksheetHeaders.length).setFontWeight("bold").setHorizontalAlignment("center");
    SpreadsheetApp.flush();
    Logger.log(`Sheet cadangan baru '${backupSheetName}' dibuat dari template dan header ditambahkan.`);


    // 4. Populate sheet cadangan dengan data dari klien
    // clientCeklokData adalah array of objects: {tanggal, hari, jamMasuk, jamPulang, keteranganLiburManual}
    const dataToLoad = [];
    const scriptTimeZone = Session.getScriptTimeZone();
    let exportIdCounter = parseInt(lockId, 10); // Mulai EXPORT_ID dari lockId

    if (isNaN(exportIdCounter)) { // Fallback jika lockId tidak bisa jadi angka
        Logger.log(`LOCK_ID "${lockId}" tidak valid untuk counter EXPORT_ID, menggunakan 1 sebagai basis.`);
        exportIdCounter = 1; // Atau handle error
    }


    clientCeklokData.forEach((row, index) => {
      let formattedDateYYYYMMDD = "";
      if (row.tanggal && typeof row.tanggal === 'string' && row.tanggal.includes('/')) {
        const dateParts = row.tanggal.split("/"); // dd/MM/yyyy
        if (dateParts.length === 3) {
          const day = parseInt(dateParts[0], 10);
          const month = parseInt(dateParts[1], 10) - 1; // JS month is 0-indexed
          const year = parseInt(dateParts[2], 10);
          if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
            const dateObject = new Date(year, month, day);
            formattedDateYYYYMMDD = Utilities.formatDate(dateObject, scriptTimeZone, "yyyy-MM-dd");
          }
        }
      }

      const jamMasukFormatted = formatTimeToHHMM_Excel(row.jamMasuk); // Gunakan helper Anda
      const jamPulangFormatted = formatTimeToHHMM_Excel(row.jamPulang);
      const keteranganManual = row.keteranganLiburManual || "";

      dataToLoad.push([
        exportIdCounter + index, // EXPORT_ID
        formattedDateYYYYMMDD,
        row.hari,
        jamMasukFormatted,
        jamPulangFormatted,
        keteranganManual, // Ket Libur 1
        keteranganManual  // Ket Libur 2 (atau sesuaikan jika berbeda)
      ]);
    });

    if (dataToLoad.length > 0) {
      newBackupSheet.getRange(2, 1, dataToLoad.length, dataToLoad[0].length).setValues(dataToLoad);
      // Terapkan format teks jika perlu
      newBackupSheet.getRange(2, 1, dataToLoad.length, newBackupSheet.getLastColumn()).setNumberFormat("@");
      Logger.log(`Data dimuat ke '${backupSheetName}'. Jumlah baris: ${dataToLoad.length}`);
    } else {
      Logger.log(`Tidak ada data valid dari klien untuk dimuat ke '${backupSheetName}'.`);
    }
    SpreadsheetApp.flush();

    // 5. Jadwalkan penghapusan otomatis (15 menit jika tidak diekspor)
    // Ini bagian yang paling kompleks dan membutuhkan trigger.
    // Untuk ilustrasi, kita simpan info ini di Script Properties.
    // Fungsi cleanup akan membaca ini.
    const cleanupInfo = {
      sheetName: backupSheetName,
      teacherName: teacherName,
      lockId: lockId,
      deleteAt: Date.now() + (15 * 60 * 1000), // 15 menit dari sekarang
      status: "PENDING_NO_EXPORT" // Status awal
    };
    PropertiesService.getScriptProperties().setProperty(`cleanup_${backupSheetName}`, JSON.stringify(cleanupInfo));
    Logger.log(`Penghapusan untuk '${backupSheetName}' dijadwalkan dalam 15 menit.`);

    // Panggil fungsi untuk membuat trigger jika belum ada
    createTriggerForCleanupIfNotExists();

    return { success: true, message: "LOCK_ID disimpan. Sheet cadangan disiapkan.", backupSheetName: backupSheetName };

  } catch (e) {
    Logger.log(`Error di saveLockIdAndPrepareBackupSheet: ${e.toString()} \nStack: ${e.stack}`);
    return { success: false, error: `Gagal memproses: ${e.message}` };
  }
}

function exportBackupSheetToExcel(backupSheetName, teacherName, bulanTahun, lockId) {
  try {
    SpreadsheetApp.flush();
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetToExport = ss.getSheetByName(backupSheetName);

    if (!sheetToExport) {
      return { success: false, error: `Sheet cadangan '${backupSheetName}' tidak ditemukan. Mungkin sudah terhapus atau nama salah.` };
    }

    // Validasi tambahan: cek apakah lockId pada sheet cadangan (jika disimpan di sana) cocok
    // atau cek apakah sheet ini memang milik teacherName tersebut.
    // Untuk sekarang, kita asumsikan nama sudah cukup.

    const spreadsheetId = ss.getId();
    const sheetId = sheetToExport.getSheetId();
    const internalExportUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=xlsx&gid=${sheetId}`;
    const token = ScriptApp.getOAuthToken();
    const fetchParams = {
      headers: { 'Authorization': 'Bearer ' + token },
      muteHttpExceptions: true
    };
    const httpResponse = UrlFetchApp.fetch(internalExportUrl, fetchParams);

    if (httpResponse.getResponseCode() !== 200) {
      Logger.log(`Gagal mengambil blob Excel untuk '${backupSheetName}'. Kode: ${httpResponse.getResponseCode()}. Respon: ${httpResponse.getContentText()}`);
      return { success: false, error: `Gagal mengambil data Excel dari server (Status: ${httpResponse.getResponseCode()}).` };
    }
    const blob = httpResponse.getBlob();
    const bulanTahunFormattedForFilename = bulanTahun.replace('/', '-');
    const dynamicFileName = `Backup_${teacherName}_${bulanTahunFormattedForFilename}_LOCK${lockId}.xlsx`; // Nama file lebih deskriptif
    const base64Data = Utilities.base64Encode(blob.getBytes());
    const mimeType = blob.getContentType() || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';

    // 6. Jadwalkan penghapusan lebih cepat (1 menit setelah export)
    const cleanupKey = `cleanup_${backupSheetName}`;
    let cleanupInfo = PropertiesService.getScriptProperties().getProperty(cleanupKey);
    if (cleanupInfo) {
      cleanupInfo = JSON.parse(cleanupInfo);
      cleanupInfo.deleteAt = Date.now() + (1 * 60 * 1000); // 1 menit dari sekarang
      cleanupInfo.status = "EXPORTED_PENDING_DELETE";
      PropertiesService.getScriptProperties().setProperty(cleanupKey, JSON.stringify(cleanupInfo));
      Logger.log(`Penghapusan untuk '${backupSheetName}' dijadwalkan ulang dalam 1 menit setelah export.`);
    } else {
      // Jika tidak ada info cleanup (seharusnya ada), buat baru untuk deletion cepat
       const newCleanupInfo = {
        sheetName: backupSheetName,
        teacherName: teacherName,
        lockId: lockId,
        deleteAt: Date.now() + (1 * 60 * 1000),
        status: "EXPORTED_PENDING_DELETE_NO_PRIOR_RECORD"
      };
      PropertiesService.getScriptProperties().setProperty(`cleanup_${backupSheetName}`, JSON.stringify(newCleanupInfo));
      Logger.log(`Info cleanup tidak ditemukan untuk '${backupSheetName}', dibuat jadwal baru untuk penghapusan dalam 1 menit.`);
    }
     createTriggerForCleanupIfNotExists();


    return {
      success: true,
      base64Data: base64Data,
      fileName: dynamicFileName,
      mimeType: mimeType,
      message: `Export untuk '${dynamicFileName}' dimulai.`
    };

  } catch (e) {
    Logger.log(`Error di exportBackupSheetToExcel: ${e.toString()} \nStack: ${e.stack}`);
    return { success: false, error: `Gagal mengekspor sheet cadangan: ${e.message}` };
  }
}

// --- FUNGSI UNTUK PENGHAPUSAN OTOMATIS ---
function autoCleanupBackupSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const properties = PropertiesService.getScriptProperties();
  const allKeys = properties.getKeys();
  const now = Date.now();
  let deletedCount = 0;

  allKeys.forEach(key => {
    if (key.startsWith("cleanup_")) {
      const backupSheetNameFromKey = key.substring("cleanup_".length); // Ambil nama sheet dari key
      try {
        const infoString = properties.getProperty(key);
        if (infoString) {
          const info = JSON.parse(infoString);
          // Pastikan info.sheetName ada dan cocok dengan nama dari key jika perlu validasi lebih
          const sheetNameToDelete = info.sheetName || backupSheetNameFromKey;

          if (now >= info.deleteAt) {
            const sheet = ss.getSheetByName(sheetNameToDelete);
            if (sheet) {
              ss.deleteSheet(sheet);
              Logger.log(`Sheet cadangan '${sheetNameToDelete}' (Status: ${info.status}) otomatis dihapus karena waktu habis.`);
              deletedCount++;
            } else {
              Logger.log(`Sheet cadangan '${sheetNameToDelete}' (Status: ${info.status}) tidak ditemukan untuk dihapus (mungkin sudah dihapus manual).`);
            }
            properties.deleteProperty(key); // Hapus properti setelah diproses
          }
        }
      } catch (e) {
        Logger.log(`Error saat memproses cleanup untuk key '${key}': ${e.toString()}`);
        // Pertimbangkan untuk menghapus properti yang error agar tidak diproses berulang kali
        // properties.deleteProperty(key);
      }
    }
  });
  if (deletedCount > 0) Logger.log(`${deletedCount} sheet cadangan berhasil dihapus oleh autoCleanup.`);

  // Jika tidak ada lagi properti cleanup, hapus trigger untuk menghemat resource
  const remainingCleanupKeys = properties.getKeys().filter(k => k.startsWith("cleanup_"));
  if (remainingCleanupKeys.length === 0) {
    deleteTriggerByName('autoCleanupBackupSheets');
    Logger.log("Tidak ada jadwal cleanup tersisa, trigger 'autoCleanupBackupSheets' dihapus.");
  }
}

function createTriggerForCleanupIfNotExists() {
  const triggers = ScriptApp.getProjectTriggers();
  let triggerExists = false;
  for (let i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === "autoCleanupBackupSheets") {
      triggerExists = true;
      break;
    }
  }
  if (!triggerExists) {
    ScriptApp.newTrigger("autoCleanupBackupSheets")
      .timeBased()
      .everyMinutes(5) // Jalankan setiap 5 menit (atau sesuaikan)
      .create();
    Logger.log("Trigger untuk 'autoCleanupBackupSheets' dibuat, berjalan setiap 5 menit.");
  }
}

function deleteTriggerByName(triggerHandlerFunctionName) {
  const triggers = ScriptApp.getProjectTriggers();
  for (let i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === triggerHandlerFunctionName) {
      ScriptApp.deleteTrigger(triggers[i]);
      Logger.log(`Trigger dengan handler '${triggerHandlerFunctionName}' berhasil dihapus.`);
      break; // Asumsi hanya ada satu trigger dengan nama handler tersebut
    }
  }
}

function changeUserPassword(username, oldPassword, newPassword) {
  try {
    if (!username) {
      return { success: false, error: "Informasi pengguna tidak valid." };
    }
    if (!oldPassword) {
      return { success: false, error: "Password lama wajib diisi." };
    }
    if (!newPassword || String(newPassword).length < 4) {
      return { success: false, error: "Password baru minimal 4 karakter." };
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(USERS_SHEET_NAME);
    if (!usersSheet) {
      return { success: false, error: `Sheet '${USERS_SHEET_NAME}' tidak ditemukan.` };
    }

    const data = usersSheet.getDataRange().getValues();
    let rowIndex = -1;
    let actualOldPassword = "";

    // Kolom: A=Username (0), B=Password (1), C=Role (2), D=Nama_Guru_Asli (3)
    for (let i = 1; i < data.length; i++) { // Mulai dari baris 1 (data), baris 0 adalah header
      if (String(data[i][0]).trim() === username) {
        rowIndex = i + 1; // Nomor baris di sheet (1-based)
        actualOldPassword = String(data[i][1]); // Password ada di kolom B (index 1)
        break;
      }
    }

    if (rowIndex === -1) {
      return { success: false, error: "Pengguna tidak ditemukan." };
    }

    if (actualOldPassword !== oldPassword) {
      return { success: false, error: "Password lama salah." };
    }

    // Update password baru di kolom B (index 2 dari getRange)
    usersSheet.getRange(rowIndex, 2).setValue(newPassword);
    SpreadsheetApp.flush(); // Pastikan perubahan disimpan

    return { success: true, message: "Password berhasil diubah." };

  } catch (e) {
    Logger.log(`Error in changeUserPassword for ${username}: ${e.toString()}`);
    return { success: false, error: `Gagal mengubah password: ${e.message}` };
  }
}


// ... (fungsi lainnya) ...

// Pastikan USERS_SHEET_NAME sudah didefinisikan
// const USERS_SHEET_NAME = "Users"; // Kolom: A=Username, B=Password, C=Role, D=Nama_Guru_Asli, E=GoogleEmail (BARU)

function linkCurrentUserToGoogle(customUsername) {
  try {
    if (!customUsername) {
      return { success: false, error: "Username kustom tidak diberikan." };
    }

    const activeUserEmail = Session.getActiveUser().getEmail(); // Email akun Google yang menjalankan skrip
    const effectiveUserEmail = Session.getEffectiveUser().getEmail(); // Email pemilik skrip (jika dieksekusi oleh pemilik)

    // Tentukan email Google yang akan digunakan.
    // Jika aplikasi dieksekusi "sebagai pengguna yang mengakses aplikasi web", activeUserEmail adalah yang relevan.
    let googleEmailToLink = activeUserEmail;

    if (!googleEmailToLink) {
      // Ini bisa terjadi jika skrip tidak memiliki izin atau pengguna tidak login ke Google.
      // Atau jika skrip dijalankan oleh pemilik dan activeUser adalah pemilik.
      // Dalam Apps Script Web App yang berjalan "execute as me (owner)", activeUser adalah owner.
      // Jika "execute as user accessing the app", activeUser adalah user yang login.
      // Untuk web app publik, ini mungkin tidak selalu mengembalikan email pengguna tanpa OAuth Flow yang lebih eksplisit.
      // Namun, untuk web app yang dibatasi untuk domain tertentu, ini bisa berfungsi.
      Logger.log(`Active user email: ${activeUserEmail}, Effective user: ${effectiveUserEmail}`);
      return { success: false, error: "Tidak dapat mengambil email akun Google Anda. Pastikan Anda login ke Google dan telah memberikan izin." };
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(USERS_SHEET_NAME);
    if (!usersSheet) {
      return { success: false, error: `Sheet '${USERS_SHEET_NAME}' tidak ditemukan.` };
    }

    // Pastikan header kolom E adalah 'GoogleEmail' atau sesuaikan
    const headers = usersSheet.getRange(1, 1, 1, usersSheet.getLastColumn()).getValues()[0];
    const googleEmailColIdx = headers.indexOf("GoogleEmail"); // Cari indeks kolom GoogleEmail

    if (googleEmailColIdx === -1) {
        return { success: false, error: "Kolom 'GoogleEmail' tidak ditemukan di sheet Users. Harap tambahkan kolom tersebut (misalnya di kolom E)." };
    }

    const data = usersSheet.getDataRange().getValues();
    let rowIndex = -1;

    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]).trim() === customUsername) {
        rowIndex = i + 1;
        // Cek apakah sudah ada email Google yang tertaut dan apakah berbeda
        if (data[i][googleEmailColIdx] && String(data[i][googleEmailColIdx]).trim() !== "" && String(data[i][googleEmailColIdx]).trim() !== googleEmailToLink) {
            return { success: false, error: `Akun '<span class="math-inline">\{customUsername\}' sudah tertaut dengan email Google lain \(</span>{data[i][googleEmailColIdx]}).` };
        }
        if (String(data[i][googleEmailColIdx]).trim() === googleEmailToLink) {
             return { success: true, message: `Akun Anda sudah tertaut dengan ${googleEmailToLink}.`, linkedEmail: googleEmailToLink };
        }
        break;
      }
    }

    if (rowIndex === -1) {
      return { success: false, error: `Pengguna kustom '${customUsername}' tidak ditemukan.` };
    }

    // Simpan email Google di kolom yang sesuai (googleEmailColIdx + 1 karena 1-based)
    usersSheet.getRange(rowIndex, googleEmailColIdx + 1).setValue(googleEmailToLink);
    SpreadsheetApp.flush();

    return { success: true, message: `Akun '${customUsername}' berhasil ditautkan dengan email Google: ${googleEmailToLink}.`, linkedEmail: googleEmailToLink };

  } catch (e) {
    Logger.log(`Error in linkCurrentUserToGoogle for ${customUsername}: ${e.toString()}`);
    return { success: false, error: `Gagal menautkan akun Google: ${e.message}` };
  }
}

// ... (fungsi lainnya, pastikan USERS_SHEET_NAME, LOGIN_HISTORY_SHEET_NAME, NAMA_GURU_SHEET_NAME sudah didefinisikan) ...

function loginViaLinkedGoogleAccount() {
  try {
    const activeUserGoogleEmail = Session.getActiveUser().getEmail();

    if (!activeUserGoogleEmail) {
      Logger.log("Tidak dapat mengambil email Google pengguna aktif. Pengguna mungkin tidak login ke Google atau belum memberikan izin.");
      return { success: false, error: "Tidak dapat mengakses akun Google Anda. Pastikan Anda login ke Google dan telah memberikan izin ke aplikasi ini." };
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(USERS_SHEET_NAME);
    if (!usersSheet) {
      return { success: false, error: `Sheet '${USERS_SHEET_NAME}' tidak ditemukan.` };
    }

    const data = usersSheet.getDataRange().getValues();
    // Kolom: A=Username (0), B=Password (1), C=Role (2), D=Nama_Guru_Asli (3), E=GoogleEmail (4)
    const headers = data[0];
    const googleEmailColIdx = headers.indexOf("GoogleEmail");

    if (googleEmailColIdx === -1) {
      return { success: false, error: "Konfigurasi internal error: Kolom 'GoogleEmail' tidak ditemukan di backend." };
    }

    for (let i = 1; i < data.length; i++) { // Mulai dari baris data
      const rowCustomUsername = String(data[i][0]).trim();
      const rowRole = String(data[i][2]).trim();
      const rowActualTeacherName = data[i][3] ? String(data[i][3]).trim() : "";
      const linkedGoogleEmailInSheet = data[i][googleEmailColIdx] ? String(data[i][googleEmailColIdx]).trim() : "";

      if (linkedGoogleEmailInSheet && linkedGoogleEmailInSheet.toLowerCase() === activeUserGoogleEmail.toLowerCase()) {
        // Akun Google cocok dengan yang tertaut di sheet
        let effectiveTeacherName = null;
        if (rowRole === "user") {
          if (!rowActualTeacherName) {
            return { success: false, error: `Login Google berhasil untuk '<span class="math-inline">\{activeUserGoogleEmail\}', tetapi 'Nama\_Guru\_Asli' untuk akun '</span>{rowCustomUsername}' kosong. Hubungi admin.` };
          }
          effectiveTeacherName = rowActualTeacherName;
          const sheetGuru = ss.getSheetByName(NAMA_GURU_SHEET_NAME);
          if (sheetGuru) {
            const guruList = sheetGuru.getRange(1, 1, sheetGuru.getLastRow(), 1).getValues().flat().filter(String).map(g => String(g).trim());
            if (!guruList.includes(effectiveTeacherName)) {
              return { success: false, error: `Nama Guru Asli '${effectiveTeacherName}' (akun: <span class="math-inline">\{rowCustomUsername\}\) tidak ada di sheet '</span>{NAMA_GURU_SHEET_NAME}'.` };
            }
          } else {
            return { success: false, error: `Konfigurasi error: Sheet '${NAMA_GURU_SHEET_NAME}' tidak ditemukan.` };
          }
        }

        // Catat histori login
        try {
          let loginHistorySheet = ss.getSheetByName(LOGIN_HISTORY_SHEET_NAME);
          if (!loginHistorySheet) {
            loginHistorySheet = ss.insertSheet(LOGIN_HISTORY_SHEET_NAME);
            loginHistorySheet.appendRow(["Username", "Login_Timestamp", "Nama_Guru", "Metode_Login"]); // Tambah header Metode_Login
            loginHistorySheet.getRange("A1:D1").setFontWeight("bold");
          }
          const timestamp = new Date();
          loginHistorySheet.appendRow([rowCustomUsername, timestamp, effectiveTeacherName || '', "Google"]);
        } catch (logError) {
          Logger.log(`Gagal mencatat histori login Google untuk ${rowCustomUsername}: ${logError.toString()}`);
        }

        return {
          success: true,
          username: rowCustomUsername, // Kembalikan username kustom agar sistem tetap konsisten
          role: rowRole,
          teacherName: effectiveTeacherName,
          googleEmail: activeUserGoogleEmail // Info tambahan
        };
      }
    }

    return { success: false, error: `Akun Google Anda (${activeUserGoogleEmail}) tidak tertaut dengan akun manapun di sistem ini. Silakan login dengan username/password, lalu tautkan akun Anda dari dashboard.` };

  } catch (e) {
    Logger.log(`Error in loginViaLinkedGoogleAccount: ${e.toString()}`);
    return { success: false, error: `Error server saat login Google: ${e.message}` };
  }
}


// Di Code.gs
// Pastikan USERS_SHEET_NAME sudah didefinisikan

function unlinkCurrentUserFromGoogle(customUsername) {
  try {
    if (!customUsername) {
      return { success: false, error: "Username kustom tidak diberikan." };
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(USERS_SHEET_NAME);
    if (!usersSheet) {
      return { success: false, error: `Sheet '${USERS_SHEET_NAME}' tidak ditemukan.` };
    }

    const headers = usersSheet.getRange(1, 1, 1, usersSheet.getLastColumn()).getValues()[0];
    const googleEmailColIdx = headers.indexOf("GoogleEmail");

    if (googleEmailColIdx === -1) {
      return { success: false, error: "Kolom 'GoogleEmail' tidak ditemukan di sheet Users (backend)." };
    }

    const data = usersSheet.getDataRange().getValues();
    let rowIndex = -1;

    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]).trim() === customUsername) {
        rowIndex = i + 1; // Nomor baris di sheet (1-based)
        break;
      }
    }

    if (rowIndex === -1) {
      return { success: false, error: `Pengguna kustom '${customUsername}' tidak ditemukan.` };
    }

    // Kosongkan nilai di kolom GoogleEmail
    usersSheet.getRange(rowIndex, googleEmailColIdx + 1).setValue(''); // googleEmailColIdx + 1 karena 1-based
    SpreadsheetApp.flush();

    return { success: true, message: `Hubungan akun Google untuk '${customUsername}' berhasil diputuskan.` };

  } catch (e) {
    Logger.log(`Error in unlinkCurrentUserFromGoogle for ${customUsername}: ${e.toString()}`);
    return { success: false, error: `Gagal memutuskan hubungan akun Google: ${e.message}` };
  }
}
